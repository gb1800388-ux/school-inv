<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è - –ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        bank: {
                            primary: '#1a365d',
                            secondary: '#2c5282',
                            accent: '#3182ce',
                            success: '#38a169',
                            warning: '#d69e2e',
                            danger: '#e53e3e',
                            light: '#f7fafc',
                            dark: '#1a202c',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html { 
            font-size: 15px; 
            -webkit-font-smoothing: antialiased;
        }
        
        body { 
            font-family: 'Nunito', system-ui, sans-serif; 
            background: #f7fafc; 
            color: #1a202c;
            line-height: 1.5;
            overflow: hidden;
            height: 100dvh;
        }
        
        .app-container {
            padding-top: env(safe-area-inset-top, 0px);
            height: 100dvh;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 2px; }
        
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .touch-btn {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .touch-btn:active { transform: scale(0.98); }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .status-checked { background: #c6f6d5; color: #276749; }
        .status-pending { background: #feebc8; color: #975a16; }
        .status-writeoff { background: #fed7d7; color: #c53030; }
        
        .building-nansen { border-left-color: #3182ce !important; }
        .building-botanica { border-left-color: #38a169 !important; }
        .building-unknown { border-left-color: #a0aec0 !important; }
        
        .building-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .building-badge-nansen { background: #ebf8ff; color: #2b6cb0; }
        .building-badge-botanica { background: #f0fff4; color: #276749; }
        
        .cat-audio { border-left-color: #805ad5; }
        .cat-interactive { border-left-color: #3182ce; }
        .cat-printers { border-left-color: #00b5d8; }
        .cat-tv { border-left-color: #38a169; }
        .cat-default { border-left-color: #718096; }
        
        .category-divider {
            background: #1a365d;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 20px 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.875rem;
        }
        .category-divider:first-child { margin-top: 0; }
        
        .card-shadow {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        }
        .card-shadow:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .note-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #3182ce;
            border-radius: 50%;
        }
        
        .equipment-card {
            position: relative;
            isolation: isolate;
        }
        .equipment-card.selected {
            ring: 2px;
            ring-color: #3182ce;
            box-shadow: 0 0 0 2px #3182ce, 0 4px 12px rgba(49, 130, 206, 0.3);
        }
        .equipment-card .selection-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #cbd5e0;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            z-index: 10;
        }
        .equipment-card .selection-checkbox:hover {
            border-color: #3182ce;
            background: #ebf8ff;
        }
        .equipment-card .selection-checkbox.checked {
            background: #3182ce;
            border-color: #3182ce;
            color: white;
        }

        .bulk-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            z-index: 400;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .bulk-action-bar .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .bulk-action-bar button {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }
        .bulk-action-bar .btn-check { background: #38a169; color: white; }
        .bulk-action-bar .btn-check:hover { background: #2f855a; }
        .bulk-action-bar .btn-writeoff { background: #e53e3e; color: white; }
        .bulk-action-bar .btn-writeoff:hover { background: #c53030; }
        .bulk-action-bar .btn-print { background: #3182ce; color: white; }
        .bulk-action-bar .btn-print:hover { background: #2c5282; }
        .bulk-action-bar .btn-cancel { background: #4a5568; color: white; }
        .bulk-action-bar .btn-cancel:hover { background: #2d3748; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #3182ce;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: -100px;
            bottom: 0;
            width: 100px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .equipment-card:hover .swipe-actions {
            opacity: 1;
        }

        .modal-base {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 3vh 16px 16px;
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-z-500 { z-index: 500; }
        .modal-z-600 { z-index: 600; }
        .modal-z-700 { z-index: 700; }
        .modal-z-800 { z-index: 800; }
        
        .modal-animate {
            animation: modalIn 0.2s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .nav-rail { display: none !important; }
            .filter-panel { 
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 300px;
                z-index: 500;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            }
            .filter-panel.open { transform: translateX(0); }
            .mobile-header { display: flex !important; }
            .desktop-header { display: none !important; }
            .main-area { margin-left: 0 !important; }
        }
        
        @media (min-width: 769px) {
            .mobile-header { display: none !important; }
            .mobile-overlay { display: none !important; }
            .desktop-header { display: flex !important; }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .nav-rail { width: 56px; }
            .nav-rail button { width: 40px; height: 40px; }
            .filter-panel { width: 220px; }
            .quick-stat-card { padding: 8px 4px; }
            .quick-stat-value { font-size: 1.25rem; }
        }
        
        .quick-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }
        .quick-stat-card:hover { border-color: #e2e8f0; }
        .quick-stat-card.active { border-color: #3182ce; background: #ebf8ff; }
        .quick-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }
        .quick-stat-label {
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #718096;
        }
        
        .filter-panel { will-change: transform; }
        
        .dropdown-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 140px;
        }
        .dropdown-btn:hover { background: #edf2f7; border-color: #cbd5e0; }
        .dropdown-btn.open { border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1); }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 200;
            max-height: 320px;
            overflow-y: auto;
            animation: dropdownIn 0.15s ease-out;
            min-width: 200px;
        }
        @keyframes dropdownIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            font-size: 0.875rem;
            color: #4a5568;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background 0.1s ease;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f7fafc; }
        .dropdown-item.active { background: #ebf8ff; color: #2b6cb0; font-weight: 700; }
        .dropdown-item .item-icon { font-size: 1.125rem; }
        .dropdown-item .item-count {
            margin-left: auto;
            padding: 2px 8px;
            background: #e2e8f0;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .dropdown-item.active .item-count { background: #bee3f8; }

        .item-count-dual {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #e2e8f0;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .dropdown-item.active .item-count-dual { background: #bee3f8; }
        .count-total { color: #2d3748; }
        .count-separator { color: #a0aec0; font-weight: 400; }
        .count-pending {
            color: #d69e2e;
            font-weight: 700;
            background: #fef5e7;
            padding: 1px 5px;
            border-radius: 3px;
        }
        .dropdown-item.active .count-pending { background: #fef3c7; }

        .building-selector {
            display: flex;
            align-items: stretch;
            gap: 4px;
            padding: 2px;
            background: #edf2f7;
            border-radius: 8px;
        }
        .building-selector-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            color: #718096;
            line-height: 1.2;
        }
        .building-selector-btn:hover { color: #4a5568; }
        .building-selector-btn.active { background: white; color: #2d3748; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .building-selector-btn.nansen.active { background: #3182ce; color: white; }
        .building-selector-btn.botanica.active { background: #38a169; color: white; }
        .building-icon {
            font-size: 0.85rem;
            line-height: 1;
            margin-right: 2px;
            vertical-align: middle;
        }
        
        @media (max-width: 768px) {
            .dropdown-btn { min-width: unset; padding: 8px 10px; }
            .dropdown-btn .btn-name { max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .dropdown-menu { min-width: 220px; }
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 16px;
        }
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.2s ease;
        }
        .step-dot.active { background: #3182ce; transform: scale(1.2); }
        .step-dot.completed { background: #38a169; }

        .nav-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            font-size: 1.1rem;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: rgba(255,255,255,0.2); }
        .nav-btn-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 16px;
            height: 16px;
            background: #e53e3e;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .floor-section {
            margin-bottom: 8px;
        }
        .floor-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .floor-header:hover { background: #edf2f7; }
        .floor-rooms {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px 12px;
        }
        .room-chip {
            padding: 4px 10px;
            background: #e2e8f0;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .room-chip:hover { background: #cbd5e0; }
        .room-chip.active { background: #3182ce; color: white; }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .recent-item:hover { background: #f7fafc; }

        .problem-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #fef3c7;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .problem-item:hover { background: #fde68a; }
        .problem-item.critical { background: #fee2e2; }
        .problem-item.critical:hover { background: #fecaca; }

        .sidebar-section {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .sidebar-section-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }

        .device-item {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 8px;
        }
        .device-item:hover { border-color: #3182ce; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .device-item.checked { background: #f0fff4; border-color: #9ae6b4; }
        .device-item.writeoff { background: #fff5f5; border-color: #feb2b2; }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <div id="root" style="height: 100%; display: flex; flex-direction: column;"></div>
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none">

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const Icons = {
            Home: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            Building: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Upload: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Menu: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            ChevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
        };

        const buildingsConfig = {
            "–ù–∞–Ω—Å–µ–Ω–∞": { icon: "üè´", color: "#3182ce", colorClass: "nansen", floors: ['1', '2', '3'] },
            "–ë–æ—Ç–∞–Ω–∏—á–∫–∞": { icon: "üè¢", color: "#38a169", colorClass: "botanica", floors: ['1', '2'] },
        };

        // ===== –ú–û–î–£–õ–¨ –£–ß–Å–¢–ê –ö–ê–†–¢–†–ò–î–ñ–ï–ô =====

        // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–æ–¥–µ–ª–µ–π –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π
        // ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• –í–´–ù–ï–°–ï–ù–ê –í–û –í–ù–ï–®–ù–ò–ô –§–ê–ô–õ data.json =====
        // –≠—Ç–∏ –º–∞—Å—Å–∏–≤—ã –ø—É—Å—Ç—ã–µ - –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ localStorage –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ backup
        const initialCartridgeModels = [];
        const initialEquipment = [];

        // –¶–≤–µ—Ç–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π –¥–ª—è UI
        const cartridgeColors = {
            black: { name: '–ß—ë—Ä–Ω—ã–π', short: 'K', color: '#1a1a1a', bg: '#e5e5e5' },
            cyan: { name: '–ì–æ–ª—É–±–æ–π', short: 'C', color: '#0891b2', bg: '#cffafe' },
            magenta: { name: '–ü—É—Ä–ø—É—Ä–Ω—ã–π', short: 'M', color: '#be185d', bg: '#fce7f3' },
            yellow: { name: '–ñ—ë–ª—Ç—ã–π', short: 'Y', color: '#ca8a04', bg: '#fef9c3' },
        };


        const categoryConfig = {
            "–ê—É–¥–∏–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": { icon: "üîä", colorClass: "cat-audio", color: "#805ad5" },
            "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": { icon: "üì±", colorClass: "cat-interactive", color: "#3182ce" },
            "–ü—Ä–∏–Ω—Ç–µ—Ä—ã –∏ –ú–§–£": { icon: "üñ®Ô∏è", colorClass: "cat-printers", color: "#00b5d8" },
            "–¢–µ–ª–µ–≤–∏–∑–æ—Ä—ã": { icon: "üì∫", colorClass: "cat-tv", color: "#38a169" },
            "–°–≤–µ—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": { icon: "üí°", colorClass: "cat-lighting", color: "#f59e0b" },
        };
        const defaultCatConfig = { icon: "üì¶", colorClass: "cat-default", color: "#718096" };

        const ProgressRing = ({ percent, size = 64 }) => {
            const strokeWidth = 6;
            const radius = (size - strokeWidth) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            return (
                <div className="relative" style={{ width: size, height: size }}>
                    <svg className="transform -rotate-90" width={size} height={size}>
                        <circle stroke="#e2e8f0" strokeWidth={strokeWidth} fill="transparent" r={radius} cx={size/2} cy={size/2} />
                        <circle stroke="#3182ce" strokeWidth={strokeWidth} fill="transparent" r={radius} cx={size/2} cy={size/2}
                            strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" style={{ transition: 'stroke-dashoffset 0.5s ease' }} />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                        <span className="text-lg font-bold text-gray-800">{percent}%</span>
                    </div>
                </div>
            );
        };

        const NavRail = ({ onOpenRooms, onOpenPeople, onAddEquipment, onShowInfo, onGoHome, onOpenStats, onOpenExport, onOpenSettings, onOpenHistory, onOpenNotes, onOpenCartridges, onOpenProcurement, onOpenConsumables, problemCount, notesCount, criticalCartridgesCount, procurementCount, consumablesCount }) => (
            <div className="nav-rail w-16 bg-gray-900 flex flex-col items-center py-4 flex-shrink-0">
                <button onClick={onShowInfo} className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mb-6" title="–û –ø—Ä–æ–≥—Ä–∞–º–º–µ">
                    <span className="text-white font-bold text-sm">102</span>
                </button>
                <div className="flex-1 flex flex-col items-center gap-2">
                    <button onClick={onGoHome} className="nav-btn bg-gray-800 text-white" title="–ì–ª–∞–≤–Ω–∞—è">
                        üè†
                    </button>
                    <button onClick={onOpenStats} className="nav-btn text-gray-400 hover:text-white" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
                        üìä
                    </button>
                    <button onClick={onOpenHistory} className="nav-btn text-gray-400 hover:text-white" title="–ò—Å—Ç–æ—Ä–∏—è">
                        üìú
                    </button>
                    <button onClick={onOpenNotes} className="nav-btn text-gray-400 hover:text-white relative" title="–ó–∞–º–µ—Ç–∫–∏">
                        üìù
                        {notesCount > 0 && <span className="nav-btn-badge">{notesCount}</span>}
                    </button>
                    <button onClick={onOpenCartridges} className="nav-btn text-gray-400 hover:text-white relative" title="–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏">
                        üñ®Ô∏è
                        {criticalCartridgesCount > 0 && <span className="nav-btn-badge bg-red-500">{criticalCartridgesCount}</span>}
                    </button>
                    <button onClick={onOpenProcurement} className="nav-btn text-gray-400 hover:text-white relative" title="–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏">
                        üõí
                        {procurementCount > 0 && <span className="nav-btn-badge bg-amber-500">{procurementCount}</span>}
                    </button>
                    <button onClick={onOpenConsumables} className="nav-btn text-gray-400 hover:text-white relative" title="–°–∫–ª–∞–¥ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤">
                        üì¶
                        {consumablesCount > 0 && <span className="nav-btn-badge bg-purple-500">{consumablesCount}</span>}
                    </button>

                    <div className="w-8 h-px bg-gray-700 my-2"></div>

                    <button onClick={onOpenRooms} className="nav-btn text-gray-400 hover:text-white" title="–ö–∞–±–∏–Ω–µ—Ç—ã">
                        üö™
                    </button>
                    <button onClick={onOpenPeople} className="nav-btn text-gray-400 hover:text-white" title="–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏">
                        üë•
                    </button>

                    <div className="w-8 h-px bg-gray-700 my-2"></div>

                    <button onClick={onOpenExport} className="nav-btn text-gray-400 hover:text-white" title="–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç">
                        üì§
                    </button>
                    <button onClick={onOpenSettings} className="nav-btn text-gray-400 hover:text-white relative" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        ‚öôÔ∏è
                        {problemCount > 0 && <span className="nav-btn-badge">{problemCount}</span>}
                    </button>
                </div>
                <button onClick={onAddEquipment} className="nav-btn bg-green-600 text-white" title="–î–æ–±–∞–≤–∏—Ç—å">
                    ‚ûï
                </button>
            </div>
        );

        // –ò–ó–ú–ï–ù–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä onRoomClick
        const FilterPanel = ({ isOpen, onClose, stats, activeFilter, setActiveFilter, activeBuilding, setActiveBuilding, equipment, onViewItem, recentItems, problemItems, onRoomClick, printDeletedRegistry }) => {
            const percent = stats.total > 0 ? Math.round((stats.checked / stats.total) * 100) : 0;
            const [expandedFloors, setExpandedFloors] = useState({});
            const [showAllProblems, setShowAllProblems] = useState(false);

            const locationsByFloor = useMemo(() => {
                const result = { '–ù–∞–Ω—Å–µ–Ω–∞': {}, '–ë–æ—Ç–∞–Ω–∏—á–∫–∞': {} };
                equipment.forEach(item => {
                    if (item.building && item.floor && item.location) {
                        if (!result[item.building][item.floor]) {
                            result[item.building][item.floor] = new Set();
                        }
                        result[item.building][item.floor].add(item.location);
                    }
                });
                return result;
            }, [equipment]);

            const toggleFloor = (building, floor) => {
                setExpandedFloors(prev => ({
                    ...prev,
                    [`${building}-${floor}`]: !prev[`${building}-${floor}`]
                }));
            };

            return (
                <>
                    <div className={`mobile-overlay fixed inset-0 bg-black/40 z-400 ${isOpen ? 'block' : 'hidden'}`} onClick={onClose} />
                    <div className={`filter-panel w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 ${isOpen ? 'open' : ''}`}>
                        <button onClick={onClose} className="absolute top-3 right-3 w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center lg:hidden">
                            <Icons.X />
                        </button>
                        
                        <div className="p-4 border-b border-gray-100">
                            <h1 className="text-base font-bold text-gray-900">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
                            <p className="text-xs text-gray-500">–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</p>
                        </div>

                        <div className="sidebar-section">
                            <div className="sidebar-section-title">–ó–¥–∞–Ω–∏–µ</div>
                            <div className="building-selector">
                                <button onClick={() => { setActiveBuilding('–í—Å–µ –∑–¥–∞–Ω–∏—è'); onClose(); }}
                                    className={`building-selector-btn ${activeBuilding === '–í—Å–µ –∑–¥–∞–Ω–∏—è' ? 'active' : ''}`}>
                                    <span>–í—Å–µ</span>
                                </button>
                                <button onClick={() => { setActiveBuilding('–ù–∞–Ω—Å–µ–Ω–∞'); onClose(); }}
                                    className={`building-selector-btn nansen ${activeBuilding === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'active' : ''}`}>
                                    <span className="building-icon">üè´</span><span>–ù–∞–Ω—Å–µ–Ω–∞</span>
                                </button>
                                <button onClick={() => { setActiveBuilding('–ë–æ—Ç–∞–Ω–∏—á–∫–∞'); onClose(); }}
                                    className={`building-selector-btn botanica ${activeBuilding === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'active' : ''}`}>
                                    <span className="building-icon">üè¢</span><span>–ë–æ—Ç–∞–Ω–∏—á–∫–∞</span>
                                </button>
                            </div>
                            <button onClick={() => { setActiveBuilding('–ù–µ —É–∫–∞–∑–∞–Ω–æ'); onClose(); }}
                                className={`w-full mt-2 py-2 text-xs rounded-lg transition-all ${activeBuilding === '–ù–µ —É–∫–∞–∑–∞–Ω–æ' ? 'bg-gray-200 text-gray-700 font-bold' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>
                                ‚ùì –ù–µ —É–∫–∞–∑–∞–Ω–æ ({stats.noBuilding})
                            </button>
                        </div>

                        <div className="sidebar-section">
                            <div className="flex items-center gap-4">
                                <ProgressRing percent={percent} size={56} />
                                <div className="flex-1">
                                    <div className="text-xs text-gray-500 uppercase font-semibold mb-1">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-600">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                                        <span className="font-semibold text-green-600">{stats.checked}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-gray-600">–û—Å—Ç–∞–ª–æ—Å—å</span>
                                        <span className="font-semibold text-amber-600">{stats.pending}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-2 p-3 border-b border-gray-100">
                            <div onClick={() => setActiveFilter(activeFilter === 'writeoff' ? 'all' : 'writeoff')}
                                className={`quick-stat-card bg-red-50 ${activeFilter === 'writeoff' ? 'active' : ''}`}>
                                <div className="quick-stat-value text-red-600">{stats.writeOff}</div>
                                <div className="quick-stat-label">–°–ø–∏—Å–∞–Ω–∏–µ</div>
                            </div>
                            <div onClick={() => setActiveFilter(activeFilter === 'pending' ? 'all' : 'pending')}
                                className={`quick-stat-card bg-blue-50 ${activeFilter === 'pending' ? 'active' : ''}`}>
                                <div className="quick-stat-value text-blue-600">{stats.pending}</div>
                                <div className="quick-stat-label">–û–∂–∏–¥–∞–µ—Ç</div>
                            </div>
                            <div onClick={() => setActiveFilter(activeFilter === 'nolabel' ? 'all' : 'nolabel')}
                                className={`quick-stat-card bg-amber-50 ${activeFilter === 'nolabel' ? 'active' : ''}`}>
                                <div className="quick-stat-value text-amber-600">{stats.noLabel}</div>
                                <div className="quick-stat-label">–ë–µ–∑ –±–∏—Ä–∫–∏</div>
                            </div>
                        </div>

                        {stats.deleted > 0 && (
                            <div className="px-3 pb-3">
                                <button onClick={() => setActiveFilter(activeFilter === 'deleted' ? 'all' : 'deleted')}
                                    className={`w-full py-2.5 rounded-lg transition-all ${activeFilter === 'deleted' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    <div className="flex items-center justify-between px-3">
                                        <span className="text-sm font-medium">üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ</span>
                                        <span className="px-2 py-0.5 rounded-full bg-gray-700 text-white text-xs font-bold">{stats.deleted}</span>
                                    </div>
                                </button>
                                {activeFilter === 'deleted' && (
                                    <button onClick={printDeletedRegistry}
                                        className="w-full mt-2 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium">
                                        üñ®Ô∏è –ü–µ—á–∞—Ç—å —Ä–µ–µ—Å—Ç—Ä–∞
                                    </button>
                                )}
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto custom-scroll">
                            {/* –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ */}
                            {problemItems.length > 0 && (
                                <div className="sidebar-section">
                                    <div className="sidebar-section-title">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                                    <div className="space-y-1">
                                        {(showAllProblems ? problemItems : problemItems.slice(0, 5)).map(item => (
                                            <div key={item.id} onClick={() => { onViewItem(item); onClose(); }}
                                                className={`problem-item ${item.hasLabel === false ? 'critical' : ''}`}>
                                                <span className="text-sm">{item.hasLabel === false ? 'üè∑Ô∏è' : 'üì¶'}</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-mono text-xs font-bold text-gray-700">{item.invNumber}</div>
                                                    <div className="text-xs text-gray-500 truncate">{item.name}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {problemItems.length > 5 && (
                                            <button
                                                onClick={() => setShowAllProblems(!showAllProblems)}
                                                className="w-full text-xs text-center text-blue-500 hover:text-blue-700 py-1 cursor-pointer hover:bg-blue-50 rounded transition-colors">
                                                {showAllProblems ? '‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å' : `‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${problemItems.length - 5}...`}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* –õ–æ–∫–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–∂–∞–º */}
                            <div className="sidebar-section">
                                <div className="sidebar-section-title">üìç –õ–æ–∫–∞—Ü–∏–∏ –ø–æ —ç—Ç–∞–∂–∞–º</div>
                                {['–ù–∞–Ω—Å–µ–Ω–∞', '–ë–æ—Ç–∞–Ω–∏—á–∫–∞'].map(building => {
                                    const floors = buildingsConfig[building]?.floors || [];
                                    const hasLocations = floors.some(f => locationsByFloor[building][f]?.size > 0);
                                    if (!hasLocations) return null;
                                    
                                    return (
                                        <div key={building} className="mb-3">
                                            <div className={`text-xs font-bold mb-1 ${building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'text-blue-600' : 'text-green-600'}`}>
                                                {building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'} {building}
                                            </div>
                                            {floors.map(floor => {
                                                const rooms = locationsByFloor[building][floor];
                                                if (!rooms || rooms.size === 0) return null;
                                                const isExpanded = expandedFloors[`${building}-${floor}`];
                                                
                                                return (
                                                    <div key={floor} className="floor-section">
                                                        <div className="floor-header" onClick={() => toggleFloor(building, floor)}>
                                                            <span className="text-sm">üî¢</span>
                                                            <span className="text-sm font-semibold">{floor} —ç—Ç–∞–∂</span>
                                                            <span className="text-xs text-gray-400 ml-auto">{rooms.size} –∫–∞–±.</span>
                                                            <span className={`text-xs transition-transform ${isExpanded ? 'rotate-180' : ''}`}>‚ñº</span>
                                                        </div>
                                                        {isExpanded && (
                                                            <div className="floor-rooms">
                                                                {[...rooms].sort().map(room => (
                                                                    // –ò–ó–ú–ï–ù–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω onClick –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                                                                    <span 
                                                                        key={room} 
                                                                        className="room-chip"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            if (onRoomClick) {
                                                                                onRoomClick(building, floor, room);
                                                                                onClose();
                                                                            }
                                                                        }}
                                                                    >
                                                                        {room}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                                {!['–ù–∞–Ω—Å–µ–Ω–∞', '–ë–æ—Ç–∞–Ω–∏—á–∫–∞'].some(b => 
                                    (buildingsConfig[b]?.floors || []).some(f => locationsByFloor[b][f]?.size > 0)
                                ) && (
                                    <div className="text-xs text-gray-400 text-center py-4">
                                        –õ–æ–∫–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                    </div>
                                )}
                            </div>

                            {/* –ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ */}
                            <div className="sidebar-section">
                                <div className="sidebar-section-title">üïê –ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                                {recentItems.length === 0 ? (
                                    <div className="text-xs text-gray-400 text-center py-4">
                                        –ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
                                    </div>
                                ) : (
                                    <div className="space-y-1">
                                        {recentItems.map(item => (
                                            <div key={item.id} onClick={() => { onViewItem(item); onClose(); }} className="recent-item">
                                                <div className={`w-6 h-6 rounded flex items-center justify-center text-xs ${item.writeOff ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                                    {item.writeOff ? 'üìù' : '‚úì'}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-mono text-xs font-bold text-gray-700">{item.invNumber}</div>
                                                    <div className="text-xs text-gray-400 truncate">{item.location || '–ë–µ–∑ –ª–æ–∫–∞—Ü–∏–∏'}</div>
                                                </div>
                                                {item.building && (
                                                    <span className={`text-xs ${item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'text-blue-500' : 'text-green-500'}`}>
                                                        {item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'}
                                                    </span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const EquipmentCard = React.memo(({ item, onView, onCheck, selectionMode, isSelected, onToggleSelect, onQuickCheck, onQuickWriteOff }) => {
            const isProcessed = item.checked || item.writeOff;
            const hasNote = !!item.inventoryNote?.trim();
            const config = categoryConfig[item.category] || defaultCatConfig;

            const getBuildingBorderClass = () => {
                if (item.writeOff) return 'border-l-red-500';
                if (item.checked) return 'border-l-green-500';
                if (item.building === '–ù–∞–Ω—Å–µ–Ω–∞') return 'building-nansen';
                if (item.building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞') return 'building-botanica';
                return 'building-unknown';
            };

            const handleCardClick = (e) => {
                if (selectionMode && !e.target.closest('button')) {
                    onToggleSelect(item.id);
                }
            };

            return (
                <div
                    className={`equipment-card bg-white rounded-xl p-4 card-shadow border-l-4 transition-all ${getBuildingBorderClass()} ${isSelected ? 'selected' : ''} ${selectionMode ? 'cursor-pointer' : ''}`}
                    onClick={handleCardClick}
                >
                    {hasNote && <div className="note-indicator" title="–ï—Å—Ç—å –∑–∞–º–µ—Ç–∫–∞" />}

                    {/* –ß–µ–∫–±–æ–∫—Å –≤—ã–±–æ—Ä–∞ */}
                    {selectionMode && (
                        <div
                            className={`selection-checkbox ${isSelected ? 'checked' : ''}`}
                            onClick={(e) => { e.stopPropagation(); onToggleSelect(item.id); }}
                        >
                            {isSelected && '‚úì'}
                        </div>
                    )}

                    {/* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏) */}
                    {!selectionMode && !isProcessed && (
                        <div className="absolute -right-1 top-1/2 -translate-y-1/2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                onClick={(e) => { e.stopPropagation(); onQuickCheck && onQuickCheck(item); }}
                                className="w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-l-lg text-sm flex items-center justify-center shadow-md"
                                title="–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
                            >‚úì</button>
                            <button
                                onClick={(e) => { e.stopPropagation(); onQuickWriteOff && onQuickWriteOff(item); }}
                                className="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-l-lg text-sm flex items-center justify-center shadow-md"
                                title="–°–ø–∏—Å–∞–Ω–∏–µ"
                            >‚úó</button>
                        </div>
                    )}

                    <div className="flex items-start gap-3 mb-3">
                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 text-lg
                            ${item.writeOff ? 'bg-red-100' : item.checked ? 'bg-green-100' : 'bg-gray-100'}`}>
                            {item.writeOff ? 'üìù' : item.checked ? '‚úì' : config.icon}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-mono font-bold">{item.invNumber}</span>
                                {item.building && (
                                    <span className={`building-badge ${item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'building-badge-nansen' : 'building-badge-botanica'}`}>
                                        {item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'} {item.building}
                                    </span>
                                )}
                                {item.isUserAdded && <span title="–ù–æ–≤–æ–µ" className="w-2 h-2 bg-blue-500 rounded-full" />}
                                {item.hasLabel === false && <span title="–ë–µ–∑ –±–∏—Ä–∫–∏" className="w-2 h-2 bg-amber-500 rounded-full" />}
                            </div>
                            <h3 className="font-semibold text-gray-800 text-sm leading-snug line-clamp-2">{item.name}</h3>
                        </div>
                    </div>

                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-3 flex-wrap">
                        <span className={`status-badge ${item.writeOff ? 'status-writeoff' : item.checked ? 'status-checked' : 'status-pending'}`}>
                            {item.writeOff ? '–°–ø–∏—Å–∞–Ω–∏–µ' : item.checked ? '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç'}
                        </span>
                        {item.responsible && (
                            <>
                                <span className="text-gray-400">‚Ä¢</span>
                                <span>üë§ {item.responsible}</span>
                            </>
                        )}
                        {(item.floor || item.location) && (
                            <>
                                <span className="text-gray-400">‚Ä¢</span>
                                {item.floor && <span>üî¢ {item.floor} —ç—Ç.</span>}
                                {item.location && <span>üìç {item.location}</span>}
                            </>
                        )}
                        {item.serialNumber?.trim() && (
                            <>
                                <span className="text-gray-400">‚Ä¢</span>
                                <span className="font-mono text-gray-600" title="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä">S/N: {item.serialNumber}</span>
                            </>
                        )}
                    </div>

                    <div className="flex gap-2 pt-3 border-t border-gray-100">
                        <button onClick={() => onView(item)} className="touch-btn flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-semibold">
                            –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        {!isProcessed ? (
                            <button onClick={() => onCheck(item)} className="touch-btn flex-1 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-semibold">
                                ‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                            </button>
                        ) : (
                            <button onClick={() => onCheck(item, true)} className="touch-btn flex-1 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-semibold">
                                ‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        )}
                    </div>
                </div>
            );
        });

        const Dropdown = ({ value, options, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);
            
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                        setIsOpen(false);
                    }
                };
                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                    document.addEventListener('touchstart', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                    document.removeEventListener('touchstart', handleClickOutside);
                };
            }, [isOpen]);
            
            const currentOption = options.find(o => o.value === value) || options[0];
            const isAllOption = value === '–í—Å–µ –∑–¥–∞–Ω–∏—è' || value === '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
            
            return (
                <div className="relative" ref={dropdownRef}>
                    <button className={`dropdown-btn ${isOpen ? 'open' : ''}`} onClick={() => setIsOpen(!isOpen)}>
                        {currentOption?.icon && <span className="item-icon">{currentOption.icon}</span>}
                        <span className="btn-name flex-1 text-left truncate">{currentOption?.label || ''}</span>
                        {!isAllOption && currentOption?.count !== undefined && <span className="item-count">{currentOption.count}</span>}
                        <Icons.ChevronDown />
                    </button>
                    
                    {isOpen && (
                        <div className="dropdown-menu custom-scroll">
                            {options.map(opt => (
                                <div key={opt.value} className={`dropdown-item ${value === opt.value ? 'active' : ''}`}
                                    onClick={() => { onChange(opt.value); setIsOpen(false); }}>
                                    {opt.icon && <span className="item-icon">{opt.icon}</span>}
                                    <span className="flex-1 truncate">{opt.label}</span>
                                    {opt.count !== undefined && (
                                        opt.pending !== undefined ? (
                                            <span className="item-count-dual">
                                                <span className="count-total">{opt.count}</span>
                                                {opt.pending > 0 && (
                                                    <>
                                                        <span className="count-separator">/</span>
                                                        <span className="count-pending">{opt.pending}</span>
                                                    </>
                                                )}
                                            </span>
                                        ) : (
                                            <span className="item-count">{opt.count}</span>
                                        )
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizeClass = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-2xl', '2xl': 'max-w-4xl' }[size];

            return (
                <div className="modal-base modal-z-600" onClick={onClose}>
                    <div className={`modal-animate bg-white rounded-xl shadow-xl w-full ${sizeClass}`} onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                            <h2 className="text-base font-bold text-gray-800">{title}</h2>
                            <button onClick={onClose} className="touch-btn w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400">
                                <Icons.X />
                            </button>
                        </div>
                        <div className="p-4 max-h-[82vh] overflow-y-auto custom-scroll">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-base modal-z-700" onClick={onClose}>
                    <div className="modal-animate bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 mb-5">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="touch-btn flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm">–û—Ç–º–µ–Ω–∞</button>
                            <button onClick={onConfirm} className="touch-btn flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm">–î–∞</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, isVisible, onClose }) => {
            useEffect(() => { if (isVisible) { const t = setTimeout(onClose, 2500); return () => clearTimeout(t); } }, [isVisible, onClose]);
            if (!isVisible) return null;
            return (
                <div className="fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-3 bg-gray-800 text-white rounded-lg shadow-lg z-800 text-sm font-semibold">
                    {message}
                </div>
            );
        };

        const AutocompleteInput = ({ value, onChange, suggestions, placeholder, label, autoFocus }) => {
            const [showDropdown, setShowDropdown] = useState(false);
            const safeSuggestions = suggestions || [];
            const filtered = useMemo(() => {
                if (!value) return safeSuggestions.slice(0, 5);
                return safeSuggestions.filter(s => s.toLowerCase().includes(value.toLowerCase())).slice(0, 5);
            }, [value, safeSuggestions]);

            return (
                <div className="relative">
                    {label && <label className="block text-xs font-semibold text-gray-500 mb-1">{label}</label>}
                    <input type="text" value={value} onChange={e => onChange(e.target.value)}
                        onFocus={() => setShowDropdown(true)} onBlur={() => setTimeout(() => setShowDropdown(false), 150)}
                        placeholder={placeholder} autoFocus={autoFocus}
                        className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none" />
                    {showDropdown && filtered.length > 0 && (
                        <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-40 overflow-y-auto">
                            {filtered.map((item, idx) => (
                                <button key={idx} type="button" onMouseDown={() => { onChange(item); setShowDropdown(false); }}
                                    className="w-full text-left px-3 py-2 hover:bg-gray-50 text-sm border-b border-gray-50 last:border-0">
                                    {item}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const CheckWizardModal = ({ isOpen, onClose, item, onComplete, directories }) => {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                building: '', floor: '', location: '', responsible: '', hasLabel: null, serialNumber: '', inventoryNote: ''
            });

            const totalSteps = 7;
            const safeDirectories = directories || { rooms: [], people: [], roomsWithBuilding: [] };
            const safeItem = item || {};
            
            const filteredRooms = useMemo(() => {
                const rooms = safeDirectories.rooms || [];
                const roomsWithBuilding = safeDirectories.roomsWithBuilding || [];
                if (!formData.building) return rooms;
                const roomsForBuilding = roomsWithBuilding.filter(r => r && r.building === formData.building).map(r => r.name);
                return roomsForBuilding.length > 0 ? roomsForBuilding : rooms;
            }, [safeDirectories.rooms, safeDirectories.roomsWithBuilding, formData.building]);
            
            const safePeople = useMemo(() => safeDirectories.people || [], [safeDirectories.people]);

            useEffect(() => {
                if (isOpen && item) {
                    setStep(1);
                    setFormData({
                        building: item.building || '', floor: item.floor || '', location: item.location || '',
                        responsible: item.responsible || '', hasLabel: item.hasLabel, serialNumber: item.serialNumber || '', inventoryNote: item.inventoryNote || ''
                    });
                }
            }, [isOpen, item]);

            if (!isOpen || !item) return null;

            const floors = formData.building ? (buildingsConfig[formData.building]?.floors || []) : [];

            const canProceed = () => {
                switch (step) {
                    case 1: return !!formData.building;
                    case 2: return !!formData.floor;
                    case 5: return formData.hasLabel !== null;
                    default: return true;
                }
            };

            const nextStep = () => { if (step < totalSteps) setStep(step + 1); else onComplete(formData); };
            const prevStep = () => { if (step > 1) setStep(step - 1); };

            const renderStepContent = () => {
                switch (step) {
                    case 1:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–í –∫–∞–∫–æ–º –∑–¥–∞–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?</p>
                                <button type="button" onClick={() => setFormData(prev => ({ ...prev, building: '–ù–∞–Ω—Å–µ–Ω–∞', floor: '' }))}
                                    className={`touch-btn w-full py-4 rounded-xl font-bold text-base ${formData.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                    üè´ –ù–∞–Ω—Å–µ–Ω–∞ (3 —ç—Ç–∞–∂–∞)
                                </button>
                                <button type="button" onClick={() => setFormData(prev => ({ ...prev, building: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞', floor: '' }))}
                                    className={`touch-btn w-full py-4 rounded-xl font-bold text-base ${formData.building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                    üè¢ –ë–æ—Ç–∞–Ω–∏—á–∫–∞ (2 —ç—Ç–∞–∂–∞)
                                </button>
                            </div>
                        );
                    case 2:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–ù–∞ –∫–∞–∫–æ–º —ç—Ç–∞–∂–µ?</p>
                                <div className="grid grid-cols-3 gap-3">
                                    {floors.map(f => (
                                        <button key={f} type="button" onClick={() => setFormData(prev => ({ ...prev, floor: f }))}
                                            className={`touch-btn py-4 rounded-xl font-bold text-xl ${formData.floor === f ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                            {f}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );
                    case 3:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–ù–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞</p>
                                <AutocompleteInput value={formData.location} onChange={v => setFormData(prev => ({ ...prev, location: v }))} 
                                    suggestions={filteredRooms} placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞..." autoFocus />
                            </div>
                        );
                    case 4:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</p>
                                <AutocompleteInput value={formData.responsible} onChange={v => setFormData(prev => ({ ...prev, responsible: v }))} 
                                    suggestions={safePeople} placeholder="–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ..." autoFocus />
                            </div>
                        );
                    case 5:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–ë–∏—Ä–∫–∞ –µ—Å—Ç—å –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏?</p>
                                <button type="button" onClick={() => setFormData(prev => ({ ...prev, hasLabel: true }))}
                                    className={`touch-btn w-full py-4 rounded-xl font-bold text-base ${formData.hasLabel === true ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                    ‚úì –î–∞, –µ—Å—Ç—å –±–∏—Ä–∫–∞
                                </button>
                                <button type="button" onClick={() => setFormData(prev => ({ ...prev, hasLabel: false }))}
                                    className={`touch-btn w-full py-4 rounded-xl font-bold text-base ${formData.hasLabel === false ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                    ‚úó –ù–µ—Ç –±–∏—Ä–∫–∏
                                </button>
                            </div>
                        );
                    case 6:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)</p>
                                <input type="text" value={formData.serialNumber} onChange={e => setFormData(prev => ({ ...prev, serialNumber: e.target.value }))}
                                    placeholder="S/N" className="w-full px-4 py-3 border border-gray-200 rounded-xl text-center font-mono text-lg" autoFocus />
                            </div>
                        );
                    case 7:
                        return (
                            <div className="space-y-3">
                                <p className="text-center text-gray-600 text-sm mb-4">–ó–∞–º–µ—Ç–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</p>
                                <textarea value={formData.inventoryNote} onChange={e => setFormData(prev => ({ ...prev, inventoryNote: e.target.value }))}
                                    placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏..." rows={3}
                                    className="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm resize-none" autoFocus />
                            </div>
                        );
                    default: return null;
                }
            };

            const stepTitles = ['–ó–¥–∞–Ω–∏–µ', '–≠—Ç–∞–∂', '–ö–∞–±–∏–Ω–µ—Ç', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–ë–∏—Ä–∫–∞', '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä', '–ó–∞–º–µ—Ç–∫–∞'];

            return (
                <div className="modal-base modal-z-600" onClick={onClose}>
                    <div className="modal-animate bg-white rounded-xl shadow-xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <div className="px-4 py-3 border-b border-gray-100">
                            <div className="flex items-center justify-between mb-2">
                                <h2 className="text-base font-bold text-gray-800">–ü—Ä–æ–≤–µ—Ä–∫–∞: {stepTitles[step-1]}</h2>
                                <button onClick={onClose} className="touch-btn w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400"><Icons.X /></button>
                            </div>
                            <div className="step-indicator">
                                {Array.from({ length: totalSteps }, (_, i) => (
                                    <div key={i} className={`step-dot ${i + 1 === step ? 'active' : i + 1 < step ? 'completed' : ''}`} />
                                ))}
                            </div>
                            <div className="p-2 bg-blue-50 rounded-lg text-center">
                                <span className="font-mono font-bold text-blue-700 text-sm">{item.invNumber}</span>
                                <p className="text-xs text-gray-600 truncate">{item.name}</p>
                            </div>
                        </div>
                        <div className="p-4">{renderStepContent()}</div>
                        <div className="px-4 pb-4 flex gap-2">
                            {step > 1 && <button onClick={prevStep} className="touch-btn flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold">‚Üê –ù–∞–∑–∞–¥</button>}
                            <button onClick={nextStep} disabled={!canProceed()}
                                className={`touch-btn flex-1 py-3 rounded-xl font-semibold ${canProceed() ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                {step === totalSteps ? '‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–î–∞–ª–µ–µ ‚Üí'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫–∞–±–∏–Ω–µ—Ç–∞
        const RoomDevicesModal = ({ isOpen, onClose, building, floor, room, equipment, onViewItem }) => {
            if (!isOpen) return null;

            const devices = equipment.filter(item =>
                item.building === building && item.location === room
            );
            const checkedCount = devices.filter(d => d.checked || d.writeOff).length;

            // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫–∞–±–∏–Ω–µ—Ç–∞
            const handlePrintRoom = () => {
                const printContent = `
                    <!DOCTYPE html>
                    <html><head>
                        <meta charset="UTF-8">
                        <title>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - ${room} (${building})</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
                            .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                            .header h1 { font-size: 18px; margin-bottom: 5px; }
                            .header .subtitle { color: #666; font-size: 14px; }
                            .info-row { display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
                            .info-item { text-align: center; }
                            .info-label { font-size: 10px; color: #666; }
                            .info-value { font-weight: bold; font-size: 14px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background: #4a5568; color: white; font-size: 11px; }
                            td { font-size: 11px; }
                            tr:nth-child(even) { background: #f9f9f9; }
                            .status-checked { color: #16a34a; font-weight: bold; }
                            .status-writeoff { color: #dc2626; font-weight: bold; }
                            .status-pending { color: #d97706; }
                            .inv-number { font-family: monospace; font-weight: bold; color: #1d4ed8; }
                            .footer { margin-top: 20px; text-align: center; font-size: 10px; color: #999; }
                            @media print { body { padding: 10px; } }
                        </style>
                    </head><body>
                        <div class="header">
                            <h1>üìç –ö–∞–±–∏–Ω–µ—Ç ${room}</h1>
                            <div class="subtitle">–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Äî ${building}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-item">
                                <div class="info-label">–ó–¥–∞–Ω–∏–µ</div>
                                <div class="info-value">${building}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–≠—Ç–∞–∂</div>
                                <div class="info-value">${floor}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
                                <div class="info-value">${devices.length}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                                <div class="info-value" style="color: #16a34a;">${checkedCount}</div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">‚Ññ</th>
                                    <th style="width: 100px;">–ò–Ω–≤. –Ω–æ–º–µ—Ä</th>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                    <th style="width: 80px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th style="width: 100px;">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                                    <th style="width: 70px;">–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${devices.map((d, i) => `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td class="inv-number">${d.invNumber || '-'}</td>
                                        <td>${d.name}</td>
                                        <td>${d.category || '-'}</td>
                                        <td>${d.responsible || '-'}</td>
                                        <td class="${d.writeOff ? 'status-writeoff' : d.checked ? 'status-checked' : 'status-pending'}">
                                            ${d.writeOff ? '–°–ø–∏—Å–∞–Ω–∏–µ' : d.checked ? '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="footer">
                            –î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')} | –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102
                        </div>
                    </body></html>
                `;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`üìç –ö–∞–±–∏–Ω–µ—Ç ${room}`} size="lg">
                    <div>
                        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */}
                        <div className="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                            <span className={`text-lg ${building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'text-blue-500' : 'text-green-500'}`}>
                                {building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'}
                            </span>
                            <div className="flex-1">
                                <div className="font-semibold text-gray-800">{building}</div>
                                <div className="text-xs text-gray-500">{floor} —ç—Ç–∞–∂</div>
                            </div>
                            <div className="text-right flex items-center gap-3">
                                <div>
                                    <div className="text-sm font-bold text-gray-700">{devices.length} —É—Å—Ç—Ä.</div>
                                    <div className="text-xs text-green-600">{checkedCount} –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                                </div>
                                {devices.length > 0 && (
                                    <button
                                        onClick={handlePrintRoom}
                                        className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm flex items-center gap-1"
                                        title="–ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞"
                                    >
                                        üñ®Ô∏è –ü–µ—á–∞—Ç—å
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */}
                        {devices.length === 0 ? (
                            <div className="text-center py-8 text-gray-400">
                                <div className="text-4xl mb-2">üì¶</div>
                                <div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            </div>
                        ) : (
                            <div className="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                                {devices.map(device => {
                                    const config = categoryConfig[device.category] || defaultCatConfig;
                                    return (
                                        <div 
                                            key={device.id}
                                            onClick={() => { onClose(); onViewItem(device); }}
                                            className={`device-item ${device.writeOff ? 'writeoff' : device.checked ? 'checked' : ''}`}
                                        >
                                            <div className="flex items-start gap-3">
                                                <div className={`w-8 h-8 rounded flex items-center justify-center text-sm flex-shrink-0 ${
                                                    device.writeOff ? 'bg-red-100 text-red-600' :
                                                    device.checked ? 'bg-green-100 text-green-600' :
                                                    'bg-gray-100 text-gray-600'
                                                }`}>
                                                    {device.writeOff ? 'üìù' : device.checked ? '‚úì' : config.icon}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-mono font-bold">
                                                            {device.invNumber}
                                                        </span>
                                                        <span className={`text-xs font-semibold ${
                                                            device.writeOff ? 'text-red-600' :
                                                            device.checked ? 'text-green-600' :
                                                            'text-amber-600'
                                                        }`}>
                                                            {device.writeOff ? '–°–ø–∏—Å–∞–Ω–∏–µ' : device.checked ? '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç'}
                                                        </span>
                                                    </div>
                                                    <div className="text-sm text-gray-800 line-clamp-2">{device.name}</div>
                                                    {device.responsible && (
                                                        <div className="text-xs text-gray-500 mt-1">üë§ {device.responsible}</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫
        const NotesModal = ({ isOpen, onClose, equipment, onViewItem }) => {
            const [filter, setFilter] = useState('all'); // all, note, inventoryNote
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedNotes, setSelectedNotes] = useState(new Set());

            if (!isOpen) return null;

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∑–∞–º–µ—Ç–∫–∏
            const toggleNoteSelection = (itemId, e) => {
                e.stopPropagation();
                setSelectedNotes(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(itemId)) {
                        newSet.delete(itemId);
                    } else {
                        newSet.add(itemId);
                    }
                    return newSet;
                });
            };

            // –í—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å –≤—Å–µ
            const toggleSelectAll = (items) => {
                if (selectedNotes.size === items.length) {
                    setSelectedNotes(new Set());
                } else {
                    setSelectedNotes(new Set(items.map(i => i.id)));
                }
            };

            // –ü–µ—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫
            const handlePrintSelected = () => {
                const selectedItems = equipment.filter(item => selectedNotes.has(item.id));
                if (selectedItems.length === 0) return;

                const date = new Date().toLocaleDateString('ru-RU');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ó–∞–º–µ—Ç–∫–∏</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333;font-size:12px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #10b981}');
                printWindow.document.write('.header h1{font-size:20px;color:#047857;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:14px;color:#6b7280;font-weight:normal}');
                printWindow.document.write('.note-item{margin-bottom:15px;padding:15px;border:1px solid #d1d5db;border-radius:8px;break-inside:avoid;background:#fafafa}');
                printWindow.document.write('.note-header{display:flex;align-items:center;gap:15px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #e5e7eb}');
                printWindow.document.write('.inv-number{font-family:monospace;font-weight:bold;color:#1f2937;font-size:14px;background:#dbeafe;padding:4px 10px;border-radius:4px}');
                printWindow.document.write('.item-name{font-size:13px;color:#374151;font-weight:500}');
                printWindow.document.write('.item-location{font-size:11px;color:#6b7280}');
                printWindow.document.write('.note-content{padding:10px;border-radius:6px;margin-top:8px}');
                printWindow.document.write('.note-type-note{background:#fef3c7;border-left:3px solid #f59e0b}');
                printWindow.document.write('.note-type-inventory{background:#d1fae5;border-left:3px solid #10b981}');
                printWindow.document.write('.note-label{font-size:10px;font-weight:600;color:#6b7280;margin-bottom:4px;text-transform:uppercase}');
                printWindow.document.write('.note-text{font-size:12px;color:#1f2937;line-height:1.5;white-space:pre-wrap}');
                printWindow.document.write('.footer{margin-top:25px;text-align:center;font-size:10px;color:#9ca3af;padding-top:15px;border-top:1px solid #e5e7eb}');
                printWindow.document.write('@media print{body{padding:15px}@page{margin:15mm;size:A4}.note-item{box-shadow:none}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>üìù –ó–ê–ú–ï–¢–ö–ò –ö –û–ë–û–†–£–î–û–í–ê–ù–ò–Æ</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Ä¢ ' + date + ' ‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: ' + selectedItems.length + '</h2></div>');

                selectedItems.forEach(item => {
                    const hasNote = item.note && item.note.trim() && item.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞';
                    const hasInventoryNote = item.inventoryNote && item.inventoryNote.trim();

                    printWindow.document.write('<div class="note-item">');
                    printWindow.document.write('<div class="note-header">');
                    printWindow.document.write('<span class="inv-number">' + (item.invNumber || '‚Äî') + '</span>');
                    printWindow.document.write('<div><div class="item-name">' + (item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + '</div>');
                    printWindow.document.write('<div class="item-location">' + [item.building, item.floor ? '–≠—Ç–∞–∂ ' + item.floor : '', item.location].filter(Boolean).join(' ‚Ä¢ ') + '</div></div>');
                    printWindow.document.write('</div>');

                    if (hasNote) {
                        printWindow.document.write('<div class="note-content note-type-note">');
                        printWindow.document.write('<div class="note-label">üìã –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>');
                        printWindow.document.write('<div class="note-text">' + item.note.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>');
                        printWindow.document.write('</div>');
                    }

                    if (hasInventoryNote) {
                        printWindow.document.write('<div class="note-content note-type-inventory">');
                        printWindow.document.write('<div class="note-label">‚úèÔ∏è –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞</div>');
                        printWindow.document.write('<div class="note-text">' + item.inventoryNote.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>');
                        printWindow.document.write('</div>');
                    }

                    printWindow.document.write('</div>');
                });

                printWindow.document.write('<div class="footer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();
            };

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏
            const itemsWithNotes = equipment.filter(item => {
                const hasNote = item.note && item.note.trim() && item.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞';
                const hasInventoryNote = item.inventoryNote && item.inventoryNote.trim();
                if (filter === 'note') return hasNote;
                if (filter === 'inventoryNote') return hasInventoryNote;
                return hasNote || hasInventoryNote;
            });

            // –ü–æ–∏—Å–∫
            const filteredItems = itemsWithNotes.filter(item => {
                if (!searchQuery.trim()) return true;
                const q = searchQuery.toLowerCase();
                return item.name?.toLowerCase().includes(q) ||
                       item.invNumber?.toLowerCase().includes(q) ||
                       item.note?.toLowerCase().includes(q) ||
                       item.inventoryNote?.toLowerCase().includes(q);
            });

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É –∑–∞–º–µ—Ç–∫–∏
            const noteStats = {
                all: equipment.filter(i => (i.note && i.note.trim() && i.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞') || (i.inventoryNote && i.inventoryNote.trim())).length,
                note: equipment.filter(i => i.note && i.note.trim() && i.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞').length,
                inventoryNote: equipment.filter(i => i.inventoryNote && i.inventoryNote.trim()).length
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üìù –í—Å–µ –∑–∞–º–µ—Ç–∫–∏" size="lg">
                    <div className="space-y-4">
                        {/* –§–∏–ª—å—Ç—Ä—ã */}
                        <div className="flex gap-2 flex-wrap">
                            <button
                                onClick={() => setFilter('all')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${filter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                –í—Å–µ ({noteStats.all})
                            </button>
                            <button
                                onClick={() => setFilter('note')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${filter === 'note' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                üìã –ü—Ä–∏–º–µ—á–∞–Ω–∏—è ({noteStats.note})
                            </button>
                            <button
                                onClick={() => setFilter('inventoryNote')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${filter === 'inventoryNote' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                ‚úèÔ∏è –ò–Ω–≤–µ–Ω—Ç. –∑–∞–º–µ—Ç–∫–∏ ({noteStats.inventoryNote})
                            </button>
                        </div>

                        {/* –ü–æ–∏—Å–∫ */}
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º..."
                            className="w-full p-2.5 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm"
                        />

                        {/* –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –∏ –ø–µ—á–∞—Ç–∏ */}
                        {filteredItems.length > 0 && (
                            <div className="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-lg border border-gray-200">
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => toggleSelectAll(filteredItems)}
                                        className="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-200 hover:bg-gray-300 text-gray-700 transition-all"
                                    >
                                        {selectedNotes.size === filteredItems.length ? '‚òê –°–Ω—è—Ç—å –≤—Å—ë' : '‚òë –í—ã–±—Ä–∞—Ç—å –≤—Å—ë'}
                                    </button>
                                    {selectedNotes.size > 0 && (
                                        <span className="text-sm text-gray-500">
                                            –í—ã–±—Ä–∞–Ω–æ: <strong className="text-blue-600">{selectedNotes.size}</strong>
                                        </span>
                                    )}
                                </div>
                                <button
                                    onClick={handlePrintSelected}
                                    disabled={selectedNotes.size === 0}
                                    className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${
                                        selectedNotes.size > 0
                                            ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                    }`}
                                >
                                    üñ®Ô∏è –ü–µ—á–∞—Ç—å
                                </button>
                            </div>
                        )}

                        {/* –°–ø–∏—Å–æ–∫ */}
                        <div className="max-h-96 overflow-y-auto custom-scroll space-y-2">
                            {filteredItems.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <div className="text-4xl mb-2">üìù</div>
                                    <div>–ó–∞–º–µ—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                                </div>
                            ) : (
                                filteredItems.map(item => {
                                    const config = categoryConfig[item.category] || defaultCatConfig;
                                    const hasNote = item.note && item.note.trim() && item.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞';
                                    const hasInventoryNote = item.inventoryNote && item.inventoryNote.trim();

                                    const isSelected = selectedNotes.has(item.id);

                                    return (
                                        <div
                                            key={item.id}
                                            onClick={() => { onClose(); onViewItem(item); }}
                                            className={`p-3 rounded-xl hover:bg-gray-100 cursor-pointer transition-colors border ${
                                                isSelected ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-200'
                                            }`}
                                        >
                                            <div className="flex items-start gap-3">
                                                {/* –ß–µ–∫–±–æ–∫—Å */}
                                                <div
                                                    onClick={(e) => toggleNoteSelection(item.id, e)}
                                                    className={`w-6 h-6 rounded-md flex items-center justify-center flex-shrink-0 cursor-pointer border-2 transition-all ${
                                                        isSelected
                                                            ? 'bg-blue-600 border-blue-600 text-white'
                                                            : 'bg-white border-gray-300 hover:border-blue-400'
                                                    }`}
                                                >
                                                    {isSelected && <span className="text-sm">‚úì</span>}
                                                </div>
                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg flex-shrink-0 ${
                                                    item.writeOff ? 'bg-red-100 text-red-600' :
                                                    item.checked ? 'bg-green-100 text-green-600' :
                                                    'bg-blue-100 text-blue-600'
                                                }`}>
                                                    {config.icon}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-mono font-bold">
                                                            {item.invNumber}
                                                        </span>
                                                        {item.building && (
                                                            <span className="text-xs text-gray-500">
                                                                {item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'} {item.building}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-sm text-gray-800 font-medium line-clamp-1 mb-2">{item.name}</div>

                                                    {/* –ó–∞–º–µ—Ç–∫–∏ */}
                                                    {hasNote && (
                                                        <div className="flex items-start gap-2 mb-1 p-2 bg-amber-50 rounded-lg border border-amber-200">
                                                            <span className="text-amber-500 flex-shrink-0">üìã</span>
                                                            <div className="text-xs text-amber-800 line-clamp-2">{item.note}</div>
                                                        </div>
                                                    )}
                                                    {hasInventoryNote && (
                                                        <div className="flex items-start gap-2 p-2 bg-green-50 rounded-lg border border-green-200">
                                                            <span className="text-green-500 flex-shrink-0">‚úèÔ∏è</span>
                                                            <div className="text-xs text-green-800 line-clamp-2">{item.inventoryNote}</div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>

                        {/* –°—á—ë—Ç—á–∏–∫ */}
                        {filteredItems.length > 0 && (
                            <div className="text-center text-xs text-gray-400">
                                –ü–æ–∫–∞–∑–∞–Ω–æ: {filteredItems.length} –∏–∑ {noteStats.all}
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };

        // ===== –ú–û–î–£–õ–¨ –ö–ê–†–¢–†–ò–î–ñ–ï–ô: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ =====
        const CartridgesModal = ({
            isOpen, onClose, tab, setTab,
            cartridgeModels, setCartridgeModels,
            cartridgeStock, setCartridgeStock,
            cartridgeHistory, setCartridgeHistory,
            manualCartridgeMapping, setManualCartridgeMapping,
            equipment, directories, showToast
        }) => {
            const [stockFilter, setStockFilter] = useState('all');
            const [historyFilter, setHistoryFilter] = useState({ search: '', dateFrom: '', dateTo: '' });
            const [showAddStock, setShowAddStock] = useState(false);
            const [showAddHistory, setShowAddHistory] = useState(false);
            const [editingStockModelId, setEditingStockModelId] = useState(null);
            const [addStockForm, setAddStockForm] = useState({ modelId: '', quantity: 1 });
            const [addHistoryForm, setAddHistoryForm] = useState({
                date: new Date().toISOString().split('T')[0],
                printerId: '',
                printerName: '',
                location: '',
                responsible: '',
                selectedCartridges: [], // –ú–∞—Å—Å–∏–≤ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π
                notes: ''
            });
            const [printerSearch, setPrinterSearch] = useState('');
            const [selectedRoom, setSelectedRoom] = useState('');
            const [showAddModel, setShowAddModel] = useState(false);
            const [newModelForm, setNewModelForm] = useState({ name: '', type: 'black', pageYield: '', avgPrice: '', compatiblePrinters: '', minStock: '2', replacementDays: '90' });
            const [editingHistoryId, setEditingHistoryId] = useState(null);
            const [editHistoryForm, setEditHistoryForm] = useState(null);
            const [editingModelId, setEditingModelId] = useState(null);
            const [editModelForm, setEditModelForm] = useState(null);
            const [showPurchaseEditor, setShowPurchaseEditor] = useState(false);
            const [purchaseOrder, setPurchaseOrder] = useState([]);
            const [showManualMapping, setShowManualMapping] = useState(false);
            const [mappingPrinter, setMappingPrinter] = useState(null);
            const [selectedCartridgeForMapping, setSelectedCartridgeForMapping] = useState('');

            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä—ã –∏–∑ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
            const printers = useMemo(() =>
                equipment.filter(item => item.category === '–ü—Ä–∏–Ω—Ç–µ—Ä—ã –∏ –ú–§–£' && !item.writeOff),
            [equipment]);

            const roomsFromPrinters = useMemo(() => {
                const rooms = [...new Set(printers.map(p => p.location).filter(Boolean))];
                return rooms.sort();
            }, [printers]);

            const filteredPrinters = useMemo(() => {
                let filtered = printers;
                if (selectedRoom) filtered = filtered.filter(p => p.location === selectedRoom);
                if (printerSearch) {
                    const q = printerSearch.toLowerCase();
                    filtered = filtered.filter(p =>
                        p.name.toLowerCase().includes(q) ||
                        p.invNumber?.toLowerCase().includes(q) ||
                        p.location?.toLowerCase().includes(q) ||
                        p.responsible?.toLowerCase().includes(q)
                    );
                }
                return filtered;
            }, [printers, selectedRoom, printerSearch]);

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞
            const getCompatibleCartridges = useCallback((printerName, printerId = null) => {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–∏–Ω—Ç–µ—Ä–∞
                const autoCompatible = cartridgeModels.filter(m =>
                    m.compatiblePrinters.some(p =>
                        printerName.toLowerCase().includes(p.toLowerCase()) ||
                        p.toLowerCase().includes(printerName.toLowerCase().split(' ').slice(0, 3).join(' '))
                    )
                );

                // –ï—Å–ª–∏ –µ—Å—Ç—å printerId, –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä—É—á–Ω—É—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏
                if (printerId && manualCartridgeMapping[printerId]) {
                    const manualIds = manualCartridgeMapping[printerId];
                    const manualCartridges = cartridgeModels.filter(m => manualIds.includes(m.id));

                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ä—É—á–Ω—ã–µ, —É–±–∏—Ä–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã
                    const combined = [...autoCompatible];
                    manualCartridges.forEach(mc => {
                        if (!combined.find(c => c.id === mc.id)) {
                            combined.push(mc);
                        }
                    });
                    return combined;
                }

                return autoCompatible;
            }, [cartridgeModels, manualCartridgeMapping]);

            // –ü–æ–¥—Å—á—ë—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ –ø–æ –º–æ–¥–µ–ª—è–º
            const stockByModel = useMemo(() => {
                const result = {};
                cartridgeStock.forEach(s => {
                    if (!result[s.modelId]) result[s.modelId] = { quantity: 0, minQuantity: s.minQuantity || 2 };
                    result[s.modelId].quantity += s.quantity;
                    if (s.minQuantity) result[s.modelId].minQuantity = s.minQuantity;
                });
                return result;
            }, [cartridgeStock]);

            // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–æ—Å—Ç–∞—Ç–æ–∫ <= –º–∏–Ω–∏–º—É–º–∞)
            const criticalItems = useMemo(() => {
                return cartridgeModels.filter(m => {
                    const stock = stockByModel[m.id];
                    const currentQty = stock?.quantity || 0;
                    const minQty = m.minStock || 2; // –ò—Å–ø–æ–ª—å–∑—É–µ–º minStock –∏–∑ –º–æ–¥–µ–ª–∏ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞
                    return currentQty <= minQty;
                });
            }, [cartridgeModels, stockByModel]);

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
            const filteredHistory = useMemo(() => {
                return cartridgeHistory.filter(h => {
                    if (historyFilter.search) {
                        const q = historyFilter.search.toLowerCase();
                        const model = cartridgeModels.find(m => m.id === h.cartridgeModelId);
                        if (!h.printerName?.toLowerCase().includes(q) &&
                            !h.location?.toLowerCase().includes(q) &&
                            !h.responsible?.toLowerCase().includes(q) &&
                            !model?.name.toLowerCase().includes(q)) return false;
                    }
                    if (historyFilter.dateFrom && h.date < historyFilter.dateFrom) return false;
                    if (historyFilter.dateTo && h.date > historyFilter.dateTo) return false;
                    return true;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [cartridgeHistory, historyFilter, cartridgeModels]);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
            const monthlyStats = useMemo(() => {
                const stats = {};
                cartridgeHistory.forEach(h => {
                    const month = h.date.substring(0, 7); // YYYY-MM
                    if (!stats[month]) stats[month] = { total: 0, byModel: {} };
                    stats[month].total++;
                    const key = h.cartridgeModelId;
                    stats[month].byModel[key] = (stats[month].byModel[key] || 0) + 1;
                });
                return Object.entries(stats).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 12);
            }, [cartridgeHistory]);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
            const printerCartridgeStats = useMemo(() => {
                return printers.map(printer => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º getCompatibleCartridges –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π (–∞–≤—Ç–æ + —Ä—É—á–Ω—ã–µ)
                    const compatible = getCompatibleCartridges(printer.name, printer.id);
                    const stockInfo = compatible.map(m => {
                        const stock = stockByModel[m.id];
                        return { model: m, quantity: stock?.quantity || 0 };
                    });
                    const totalStock = stockInfo.reduce((sum, s) => sum + s.quantity, 0);
                    const hasLow = stockInfo.some(s => s.quantity <= 2);
                    const hasEmpty = stockInfo.some(s => s.quantity === 0);
                    const replacements = cartridgeHistory.filter(h => h.printerId === printer.id).length;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä—É—á–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∫–∏
                    const hasManualMappings = manualCartridgeMapping[printer.id]?.length > 0;

                    return { printer, compatible, stockInfo, totalStock, hasLow, hasEmpty, replacements, hasManualMappings };
                });
            }, [printers, stockByModel, cartridgeHistory, getCompatibleCartridges, manualCartridgeMapping]);

            // –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ–Ω –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π
            const forecastData = useMemo(() => {
                const forecasts = [];
                const today = new Date();

                printers.forEach(printer => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º getCompatibleCartridges –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π (–∞–≤—Ç–æ + —Ä—É—á–Ω—ã–µ)
                    const compatible = getCompatibleCartridges(printer.name, printer.id);

                    compatible.forEach(model => {
                        // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–º–µ–Ω—É —ç—Ç–æ–≥–æ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –Ω–∞ —ç—Ç–æ–º –ø—Ä–∏–Ω—Ç–µ—Ä–µ
                        const lastReplacement = cartridgeHistory
                            .filter(h => h.printerId === printer.id && h.cartridgeModelId === model.id)
                            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

                        if (lastReplacement) {
                            const lastDate = new Date(lastReplacement.date);
                            const replacementDays = model.replacementDays || 90;
                            const nextDate = new Date(lastDate);
                            nextDate.setDate(nextDate.getDate() + replacementDays);

                            const daysUntilReplacement = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                            const stock = stockByModel[model.id];
                            const currentStock = stock?.quantity || 0;

                            forecasts.push({
                                printer,
                                model,
                                lastReplacement: lastDate,
                                nextReplacement: nextDate,
                                daysUntilReplacement,
                                currentStock,
                                isOverdue: daysUntilReplacement < 0,
                                isUrgent: daysUntilReplacement >= 0 && daysUntilReplacement <= 14,
                                isWarning: daysUntilReplacement > 14 && daysUntilReplacement <= 30
                            });
                        }
                    });
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ -> —Å—Ä–æ—á–Ω—ã–µ -> –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -> –æ—Å—Ç–∞–ª—å–Ω—ã–µ
                return forecasts.sort((a, b) => {
                    if (a.isOverdue && !b.isOverdue) return -1;
                    if (!a.isOverdue && b.isOverdue) return 1;
                    if (a.isUrgent && !b.isUrgent) return -1;
                    if (!a.isUrgent && b.isUrgent) return 1;
                    if (a.isWarning && !b.isWarning) return -1;
                    if (!a.isWarning && b.isWarning) return 1;
                    return a.daysUntilReplacement - b.daysUntilReplacement;
                });
            }, [printers, cartridgeHistory, stockByModel, getCompatibleCartridges]);

            // –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ö—É–∫–æ–≤!)
            if (!isOpen) return null;

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥
            const handleAddStock = () => {
                if (!addStockForm.modelId || addStockForm.quantity < 1) return;
                const existing = cartridgeStock.find(s => s.modelId === addStockForm.modelId);
                if (existing) {
                    setCartridgeStock(prev => prev.map(s =>
                        s.modelId === addStockForm.modelId
                            ? { ...s, quantity: s.quantity + addStockForm.quantity, lastUpdated: new Date().toISOString() }
                            : s
                    ));
                } else {
                    setCartridgeStock(prev => [...prev, {
                        id: `stock_${Date.now()}`,
                        modelId: addStockForm.modelId,
                        quantity: addStockForm.quantity,
                        minQuantity: 2,
                        lastUpdated: new Date().toISOString()
                    }]);
                }
                showToast('üì¶ –ö–∞—Ä—Ç—Ä–∏–¥–∂–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–∫–ª–∞–¥');
                setAddStockForm({ modelId: '', quantity: 1 });
                setShowAddStock(false);
            };

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ
            const handleAdjustStock = (modelId, newQuantity) => {
                if (newQuantity < 0) return;

                setCartridgeStock(prev => {
                    const existing = prev.find(s => s.modelId === modelId);
                    if (existing) {
                        if (newQuantity === 0) {
                            // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 0
                            return prev.filter(s => s.modelId !== modelId);
                        }
                        return prev.map(s =>
                            s.modelId === modelId
                                ? { ...s, quantity: newQuantity, lastUpdated: new Date().toISOString() }
                                : s
                        );
                    } else if (newQuantity > 0) {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –µ—ë –Ω–µ –±—ã–ª–æ
                        return [...prev, {
                            id: `stock_${Date.now()}`,
                            modelId,
                            quantity: newQuantity,
                            minQuantity: 2,
                            lastUpdated: new Date().toISOString()
                        }];
                    }
                    return prev;
                });
                showToast('‚úÖ –û—Å—Ç–∞—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
            };

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é (–∑–∞–º–µ–Ω–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞)
            const handleAddHistory = () => {
                if (addHistoryForm.selectedCartridges.length === 0 || !addHistoryForm.date) return;

                const timestamp = Date.now();
                const newEntries = [];

                // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞
                addHistoryForm.selectedCartridges.forEach((modelId, index) => {
                    const newEntry = {
                        id: `hist_${timestamp}_${index}`,
                        date: addHistoryForm.date,
                        printerId: addHistoryForm.printerId,
                        printerName: addHistoryForm.printerName,
                        location: addHistoryForm.location,
                        responsible: addHistoryForm.responsible,
                        cartridgeModelId: modelId,
                        notes: addHistoryForm.notes,
                        createdAt: new Date().toISOString()
                    };
                    newEntries.push(newEntry);

                    // –°–ø–∏—Å—ã–≤–∞–µ–º —Å–æ —Å–∫–ª–∞–¥–∞ 1 –∫–∞—Ä—Ç—Ä–∏–¥–∂ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏
                    setCartridgeStock(prev => prev.map(s =>
                        s.modelId === modelId && s.quantity > 0
                            ? { ...s, quantity: s.quantity - 1, lastUpdated: new Date().toISOString() }
                            : s
                    ));
                });

                setCartridgeHistory(prev => [...newEntries, ...prev]);

                const count = addHistoryForm.selectedCartridges.length;
                showToast(`‚úÖ –ó–∞–º–µ–Ω–∞ ${count} ${count === 1 ? '–∫–∞—Ä—Ç—Ä–∏–¥–∂–∞' : count < 5 ? '–∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π' : '–∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π'} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞`);

                setAddHistoryForm({
                    date: new Date().toISOString().split('T')[0],
                    printerId: '', printerName: '', location: '', responsible: '',
                    selectedCartridges: [], notes: ''
                });
                setShowAddHistory(false);
            };

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞
            const handleAddModel = () => {
                if (!newModelForm.name) return;
                const newModel = {
                    id: `custom_${Date.now()}`,
                    name: newModelForm.name,
                    type: newModelForm.type,
                    pageYield: parseInt(newModelForm.pageYield) || 0,
                    avgPrice: parseInt(newModelForm.avgPrice) || 0,
                    compatiblePrinters: newModelForm.compatiblePrinters.split(',').map(s => s.trim()).filter(Boolean),
                    minStock: parseInt(newModelForm.minStock) || 2,
                    replacementDays: parseInt(newModelForm.replacementDays) || 90
                };
                setCartridgeModels(prev => [...prev, newModel]);
                showToast('‚úÖ –ú–æ–¥–µ–ª—å –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                setNewModelForm({ name: '', type: 'black', pageYield: '', avgPrice: '', compatiblePrinters: '', minStock: '2', replacementDays: '90' });
                setShowAddModel(false);
            };

            const startEditHistory = (h) => {
                setEditingHistoryId(h.id);
                setEditHistoryForm({ ...h });
            };

            const saveEditHistory = () => {
                if (!editHistoryForm) return;
                setCartridgeHistory(prev => prev.map(h => h.id === editingHistoryId ? { ...editHistoryForm } : h));
                setEditingHistoryId(null);
                setEditHistoryForm(null);
                showToast('‚úÖ –ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            };

            const deleteHistoryEntry = (id) => {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
                setCartridgeHistory(prev => prev.filter(h => h.id !== id));
                showToast('üóëÔ∏è –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            };

            const startEditModel = (m) => {
                setEditingModelId(m.id);
                setEditModelForm({ ...m, compatiblePrinters: m.compatiblePrinters.join(', ') });
            };

            const saveEditModel = () => {
                if (!editModelForm) return;
                const updated = {
                    ...editModelForm,
                    pageYield: parseInt(editModelForm.pageYield) || 0,
                    avgPrice: parseInt(editModelForm.avgPrice) || 0,
                    compatiblePrinters: editModelForm.compatiblePrinters.split(',').map(s => s.trim()).filter(Boolean),
                    minStock: parseInt(editModelForm.minStock) || 2,
                    replacementDays: parseInt(editModelForm.replacementDays) || 90
                };
                setCartridgeModels(prev => prev.map(m => m.id === editingModelId ? updated : m));
                setEditingModelId(null);
                setEditModelForm(null);
                showToast('‚úÖ –ú–æ–¥–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            };

            const deleteModel = (id) => {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞?')) return;
                setCartridgeModels(prev => prev.filter(m => m.id !== id));
                showToast('üóëÔ∏è –ú–æ–¥–µ–ª—å —É–¥–∞–ª–µ–Ω–∞');
            };

            const openPurchaseEditor = () => {
                const items = criticalItems.map(m => {
                    const stock = stockByModel[m.id];
                    const currentQty = stock?.quantity || 0;
                    const minQty = m.minStock || 2; // –ò—Å–ø–æ–ª—å–∑—É–µ–º minStock –∏–∑ –º–æ–¥–µ–ª–∏ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞
                    // –ó–∞–∫–∞–∑—ã–≤–∞–µ–º –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –º–∏–Ω–∏–º—É–º–∞, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∞—Å
                    const orderQty = Math.max(minQty * 2 - currentQty, minQty);
                    return { model: m, currentQty, minQty, orderQty, include: true };
                }).filter(i => i.orderQty > 0);
                setPurchaseOrder(items);
                setShowPurchaseEditor(true);
            };

            const printPurchaseOrder = () => {
                const itemsToOrder = purchaseOrder.filter(i => i.include);
                if (itemsToOrder.length === 0) return;

                const date = new Date().toLocaleDateString('ru-RU');
                const printWindow = window.open('', '_blank');

                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333;font-size:12px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #6366f1}');
                printWindow.document.write('.header h1{font-size:18px;color:#4f46e5;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:14px;color:#6b7280;font-weight:normal}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;margin-bottom:20px}');
                printWindow.document.write('th{background:#4f46e5;color:white;padding:10px;text-align:left;font-size:11px}');
                printWindow.document.write('td{padding:10px;border:1px solid #e5e7eb}');
                printWindow.document.write('tr:nth-child(even){background:#f9fafb}');
                printWindow.document.write('.color-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}');
                printWindow.document.write('.color-black{background:#1a1a1a;color:white}');
                printWindow.document.write('.color-cyan{background:#0891b2;color:white}');
                printWindow.document.write('.color-magenta{background:#be185d;color:white}');
                printWindow.document.write('.color-yellow{background:#ca8a04;color:white}');
                printWindow.document.write('.signatures{margin-top:40px;display:flex;justify-content:space-between}');
                printWindow.document.write('.signature-line{width:200px;border-top:1px solid #333;padding-top:5px;font-size:11px;color:#6b7280}');
                printWindow.document.write('@media print{body{padding:15mm}@page{margin:15mm;size:A4}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>üñ®Ô∏è –ó–ê–Ø–í–ö–ê –ù–ê –ó–ê–ö–£–ü–ö–£ –ö–ê–†–¢–†–ò–î–ñ–ï–ô</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Ä¢ ' + date + '</h2></div>');
                printWindow.document.write('<table><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞</th><th>–¶–≤–µ—Ç</th><th>–ù–∞ —Å–∫–ª–∞–¥–µ</th><th>–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å</th><th>–ó–∞–∫–∞–∑–∞—Ç—å</th></tr></thead><tbody>');

                itemsToOrder.forEach((item, idx) => {
                    const colorInfo = cartridgeColors[item.model.type];
                    printWindow.document.write('<tr>');
                    printWindow.document.write('<td>' + (idx + 1) + '</td>');
                    printWindow.document.write('<td><strong>' + item.model.name + '</strong></td>');
                    printWindow.document.write('<td><span class="color-badge color-' + item.model.type + '">' + colorInfo.name + '</span></td>');
                    printWindow.document.write('<td style="text-align:center">' + item.currentQty + ' —à—Ç.</td>');
                    printWindow.document.write('<td style="text-align:center;color:#6b7280">' + item.minQty + ' —à—Ç.</td>');
                    printWindow.document.write('<td style="text-align:center;font-weight:bold;color:#dc2626">' + item.orderQty + ' —à—Ç.</td>');
                    printWindow.document.write('</tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<div class="signatures"><div class="signature-line">–°–æ—Å—Ç–∞–≤–∏–ª: _______________</div><div class="signature-line">–£—Ç–≤–µ—Ä–¥–∏–ª: _______________</div></div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();
                setShowPurchaseEditor(false);
            };

            // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É
            const openManualMapping = (printer) => {
                setMappingPrinter(printer);
                setSelectedCartridgeForMapping('');
                setShowManualMapping(true);
            };

            // –î–æ–±–∞–≤–∏—Ç—å —Ä—É—á–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É
            const addManualMapping = () => {
                if (!selectedCartridgeForMapping || !mappingPrinter) return;

                setManualCartridgeMapping(prev => {
                    const printerId = mappingPrinter.id;
                    const existing = prev[printerId] || [];

                    // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
                    if (existing.includes(selectedCartridgeForMapping)) {
                        showToast('‚ö†Ô∏è –≠—Ç–æ—Ç –∫–∞—Ä—Ç—Ä–∏–¥–∂ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω');
                        return prev;
                    }

                    return {
                        ...prev,
                        [printerId]: [...existing, selectedCartridgeForMapping]
                    };
                });

                showToast('‚úÖ –ö–∞—Ä—Ç—Ä–∏–¥–∂ –¥–æ–±–∞–≤–ª–µ–Ω –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É');
                setSelectedCartridgeForMapping('');
                setShowManualMapping(false);
            };

            // –£–¥–∞–ª–∏—Ç—å —Ä—É—á–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –æ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–∞
            const removeManualMapping = (printerId, cartridgeId) => {
                setManualCartridgeMapping(prev => {
                    const existing = prev[printerId] || [];
                    const updated = existing.filter(id => id !== cartridgeId);

                    if (updated.length === 0) {
                        // –£–¥–∞–ª—è–µ–º –∫–ª—é—á –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–æ–∫
                        const newMapping = { ...prev };
                        delete newMapping[printerId];
                        return newMapping;
                    }

                    return {
                        ...prev,
                        [printerId]: updated
                    };
                });

                showToast('üóëÔ∏è –ö–∞—Ä—Ç—Ä–∏–¥–∂ —É–¥–∞–ª–µ–Ω');
            };

            return (
                <React.Fragment>
                <Modal isOpen={isOpen} onClose={onClose} title="üñ®Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞–º–∏" size="xl">
                    <div className="space-y-4">
                        {/* –í–∫–ª–∞–¥–∫–∏ */}
                        <div className="flex gap-1 p-1 bg-gray-100 rounded-lg">
                            {[
                                { id: 'stock', label: 'üì¶ –°–∫–ª–∞–¥', badge: criticalItems.length },
                                { id: 'forecast', label: 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑', badge: forecastData.filter(f => f.isOverdue || f.isUrgent).length },
                                { id: 'printers', label: 'üñ®Ô∏è –ü—Ä–∏–Ω—Ç–µ—Ä—ã', badge: printers.length },
                                { id: 'history', label: 'üìã –ò—Å—Ç–æ—Ä–∏—è', badge: cartridgeHistory.length },
                                { id: 'stats', label: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
                                { id: 'catalog', label: 'üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫' }
                            ].map(t => (
                                <button
                                    key={t.id}
                                    onClick={() => setTab(t.id)}
                                    className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-2 ${
                                        tab === t.id
                                            ? 'bg-white text-blue-600 shadow-sm'
                                            : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    {t.label}
                                    {t.badge > 0 && (
                                        <span className={`px-1.5 py-0.5 rounded-full text-xs ${
                                            t.id === 'stock' || t.id === 'forecast' ? 'bg-red-100 text-red-600' : 'bg-gray-200 text-gray-600'
                                        }`}>{t.badge}</span>
                                    )}
                                </button>
                            ))}
                        </div>

                        {/* –í–∫–ª–∞–¥–∫–∞: –°–∫–ª–∞–¥ */}
                        {tab === 'stock' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex gap-2">
                                        <button onClick={() => setStockFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${stockFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
                                            –í—Å–µ
                                        </button>
                                        <button onClick={() => setStockFilter('critical')} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${stockFilter === 'critical' ? 'bg-red-600 text-white' : 'bg-gray-100'}`}>
                                            üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ ({criticalItems.length})
                                        </button>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowAddStock(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
                                            ‚ûï –ü—Ä–∏—Ö–æ–¥
                                        </button>
                                        <button onClick={openPurchaseEditor} disabled={criticalItems.length === 0} className={`px-4 py-2 rounded-lg text-sm font-medium ${criticalItems.length > 0 ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-200 text-gray-400'}`}>
                                            üìÑ –ó–∞—è–≤–∫–∞
                                        </button>
                                    </div>
                                </div>

                                {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥ */}
                                {showAddStock && (
                                    <div className="p-4 bg-green-50 rounded-xl border border-green-200 space-y-3">
                                        <div className="flex items-center justify-between">
                                            <span className="font-semibold text-green-800">–ü—Ä–∏—Ö–æ–¥ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</span>
                                            <button onClick={() => setShowAddStock(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <select value={addStockForm.modelId} onChange={e => setAddStockForm(prev => ({ ...prev, modelId: e.target.value }))}
                                                className="px-3 py-2 border rounded-lg text-sm">
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂...</option>
                                                {cartridgeModels.map(m => (
                                                    <option key={m.id} value={m.id}>{m.name}</option>
                                                ))}
                                            </select>
                                            <input type="number" min="1" value={addStockForm.quantity} onChange={e => setAddStockForm(prev => ({ ...prev, quantity: parseInt(e.target.value) || 1 }))}
                                                className="px-3 py-2 border rounded-lg text-sm" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" />
                                        </div>
                                        <button onClick={handleAddStock} className="w-full py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                            –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥
                                        </button>
                                    </div>
                                )}

                                {/* –°–ø–∏—Å–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ */}
                                <div className="max-h-80 overflow-y-auto space-y-2">
                                    {cartridgeModels
                                        .filter(m => stockFilter === 'all' || criticalItems.includes(m))
                                        .map(model => {
                                            const stock = stockByModel[model.id];
                                            const qty = stock?.quantity || 0;
                                            const minQty = model.minStock || 2; // –ò—Å–ø–æ–ª—å–∑—É–µ–º minStock –∏–∑ –º–æ–¥–µ–ª–∏
                                            const status = qty === 0 ? 'empty' : qty <= minQty ? 'low' : 'ok';
                                            const colorInfo = cartridgeColors[model.type];

                                            return (
                                                <div key={model.id} className={`p-3 rounded-xl border flex items-center gap-3 ${
                                                    status === 'empty' ? 'bg-red-50 border-red-200' :
                                                    status === 'low' ? 'bg-amber-50 border-amber-200' :
                                                    'bg-gray-50 border-gray-200'
                                                }`}>
                                                    <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold"
                                                        style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                        {colorInfo.short}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-medium text-sm text-gray-900 truncate">{model.name}</div>
                                                        <div className="text-xs text-gray-500">~{model.pageYield.toLocaleString()} —Å—Ç—Ä.</div>
                                                    </div>

                                                    {editingStockModelId === model.id ? (
                                                        <div className="flex items-center gap-2">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                defaultValue={qty}
                                                                className="w-20 px-2 py-1 border rounded text-sm text-center"
                                                                onKeyDown={(e) => {
                                                                    if (e.key === 'Enter') {
                                                                        handleAdjustStock(model.id, parseInt(e.target.value) || 0);
                                                                        setEditingStockModelId(null);
                                                                    } else if (e.key === 'Escape') {
                                                                        setEditingStockModelId(null);
                                                                    }
                                                                }}
                                                                autoFocus
                                                            />
                                                            <button
                                                                onClick={() => setEditingStockModelId(null)}
                                                                className="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <>
                                                            <div className={`text-lg font-bold ${
                                                                status === 'empty' ? 'text-red-600' :
                                                                status === 'low' ? 'text-amber-600' :
                                                                'text-green-600'
                                                            }`}>
                                                                {qty} —à—Ç.
                                                            </div>
                                                            <div className="text-xs text-gray-400">
                                                                –º–∏–Ω: {minQty}
                                                            </div>
                                                            <button
                                                                onClick={() => setEditingStockModelId(model.id)}
                                                                className="p-1.5 text-blue-600 hover:bg-blue-100 rounded"
                                                                title="–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                                                            >
                                                                ‚úèÔ∏è
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            );
                                        })}
                                </div>
                            </div>
                        )}

                        {/* –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ–≥–Ω–æ–∑ */}
                        {tab === 'forecast' && (
                            <div className="space-y-4">
                                <div className="text-sm text-gray-500 mb-3">
                                    –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã—Ö –∑–∞–º–µ–Ω: {forecastData.length} ‚Ä¢
                                    <span className="text-red-600 font-semibold ml-2">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {forecastData.filter(f => f.isOverdue).length}</span> ‚Ä¢
                                    <span className="text-orange-600 font-semibold ml-2">–°—Ä–æ—á–Ω–æ (‚â§14 –¥–Ω): {forecastData.filter(f => f.isUrgent).length}</span>
                                </div>

                                {forecastData.length === 0 ? (
                                    <div className="text-center py-12 text-gray-400">
                                        <div className="text-5xl mb-3">üîÆ</div>
                                        <div className="text-lg font-medium">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                                        <div className="text-sm mt-2">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∑–∞–º–µ–Ω—ã –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
                                    </div>
                                ) : (
                                    <div className="max-h-96 overflow-y-auto space-y-3">
                                        {forecastData.map((forecast, idx) => {
                                            const colorInfo = cartridgeColors[forecast.model.type];
                                            const bgClass = forecast.isOverdue ? 'bg-red-50 border-red-300' :
                                                          forecast.isUrgent ? 'bg-orange-50 border-orange-300' :
                                                          forecast.isWarning ? 'bg-yellow-50 border-yellow-300' :
                                                          'bg-gray-50 border-gray-200';

                                            return (
                                                <div key={idx} className={`p-4 rounded-xl border-2 ${bgClass}`}>
                                                    <div className="flex items-start gap-3">
                                                        {/* –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ */}
                                                        <div className="text-2xl">üñ®Ô∏è</div>

                                                        {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-semibold text-sm text-gray-900">{forecast.printer.name}</div>
                                                            <div className="text-xs text-gray-500 mt-0.5">
                                                                {forecast.printer.location && <span className="mr-2">üìç {forecast.printer.location}</span>}
                                                                {forecast.printer.responsible && <span>üë§ {forecast.printer.responsible}</span>}
                                                            </div>

                                                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ */}
                                                            <div className="mt-2 flex items-center gap-2">
                                                                <span className="w-6 h-6 rounded flex items-center justify-center font-bold text-xs"
                                                                    style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                                    {colorInfo.short}
                                                                </span>
                                                                <span className="text-sm text-gray-700">{forecast.model.name}</span>
                                                            </div>

                                                            {/* –î–∞—Ç—ã */}
                                                            <div className="mt-2 text-xs text-gray-600 space-y-1">
                                                                <div>–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–º–µ–Ω–∞: <span className="font-medium">{forecast.lastReplacement.toLocaleDateString('ru-RU')}</span></div>
                                                                <div>–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–º–µ–Ω—ã: <span className="font-medium">{forecast.nextReplacement.toLocaleDateString('ru-RU')}</span></div>
                                                            </div>
                                                        </div>

                                                        {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–æ–∫–∞—Ö –∏ –æ—Å—Ç–∞—Ç–∫–∞—Ö */}
                                                        <div className="flex flex-col items-end gap-2">
                                                            {/* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π */}
                                                            <div className={`px-3 py-2 rounded-lg text-center ${
                                                                forecast.isOverdue ? 'bg-red-600 text-white' :
                                                                forecast.isUrgent ? 'bg-orange-500 text-white' :
                                                                forecast.isWarning ? 'bg-yellow-500 text-white' :
                                                                'bg-blue-500 text-white'
                                                            }`}>
                                                                <div className="text-xl font-bold">
                                                                    {forecast.isOverdue ? `‚àí${Math.abs(forecast.daysUntilReplacement)}` : forecast.daysUntilReplacement}
                                                                </div>
                                                                <div className="text-[9px] leading-tight">
                                                                    {forecast.isOverdue ? '–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : '–¥–Ω–µ–π'}
                                                                </div>
                                                            </div>

                                                            {/* –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ */}
                                                            <div className={`px-2 py-1 rounded text-xs font-semibold ${
                                                                forecast.currentStock === 0 ? 'bg-red-100 text-red-700' :
                                                                forecast.currentStock <= 2 ? 'bg-orange-100 text-orange-700' :
                                                                'bg-green-100 text-green-700'
                                                            }`}>
                                                                –°–∫–ª–∞–¥: {forecast.currentStock} —à—Ç
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* –í–∫–ª–∞–¥–∫–∞: –ò—Å—Ç–æ—Ä–∏—è */}
                        {tab === 'history' && (
                            <div className="space-y-4">
                                <div className="flex items-center gap-2 flex-wrap">
                                    <input type="text" value={historyFilter.search} onChange={e => setHistoryFilter(prev => ({ ...prev, search: e.target.value }))}
                                        placeholder="üîç –ü–æ–∏—Å–∫..." className="flex-1 min-w-48 px-3 py-2 border rounded-lg text-sm" />
                                    <input type="date" value={historyFilter.dateFrom} onChange={e => setHistoryFilter(prev => ({ ...prev, dateFrom: e.target.value }))}
                                        className="px-3 py-2 border rounded-lg text-sm" />
                                    <span className="text-gray-400">‚Äî</span>
                                    <input type="date" value={historyFilter.dateTo} onChange={e => setHistoryFilter(prev => ({ ...prev, dateTo: e.target.value }))}
                                        className="px-3 py-2 border rounded-lg text-sm" />
                                    <button onClick={() => {
                                        setShowAddHistory(true);
                                        setPrinterSearch('');
                                        setSelectedRoom('');
                                    }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                        ‚ûï –ó–∞–º–µ–Ω–∞
                                    </button>
                                </div>

                                {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω—ã */}
                                {showAddHistory && (
                                    <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 space-y-3">
                                        <div className="flex items-center justify-between">
                                            <span className="font-semibold text-blue-800">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–º–µ–Ω—ã –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞</span>
                                            <button onClick={() => setShowAddHistory(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                        </div>
                                        {/* –®–∞–≥ 1: –î–∞—Ç–∞ –∏ –ö–∞–±–∏–Ω–µ—Ç */}
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="date" value={addHistoryForm.date} onChange={e => setAddHistoryForm(prev => ({ ...prev, date: e.target.value }))}
                                                className="px-3 py-2 border rounded-lg text-sm" />
                                            <div>
                                                <select value={selectedRoom} onChange={e => {
                                                    setSelectedRoom(e.target.value);
                                                    setAddHistoryForm(prev => ({ ...prev, printerId: '', printerName: '', location: e.target.value }));
                                                }} className="w-full px-3 py-2 border rounded-lg text-sm">
                                                    <option value="">–í—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã</option>
                                                    {roomsFromPrinters.map(room => (
                                                        <option key={room} value={room}>{room}</option>
                                                    ))}
                                                </select>
                                                {selectedRoom && (
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        –ü—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: {filteredPrinters.length}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* –®–∞–≥ 2: –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä –ø—Ä–∏–Ω—Ç–µ—Ä–∞ */}
                                        <div className="space-y-2">
                                            <input type="text" value={printerSearch} onChange={e => setPrinterSearch(e.target.value)}
                                                placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∏–Ω–≤.–Ω–æ–º–µ—Ä, –∫–∞–±–∏–Ω–µ—Ç, –§–ò–û)..."
                                                className="w-full px-3 py-2 border rounded-lg text-sm" />
                                            <select value={addHistoryForm.printerId} onChange={e => {
                                                const printer = printers.find(p => p.id === e.target.value);
                                                setAddHistoryForm(prev => ({
                                                    ...prev,
                                                    printerId: e.target.value,
                                                    printerName: printer?.name || '',
                                                    location: printer?.location || prev.location,
                                                    responsible: printer?.responsible || prev.responsible
                                                }));
                                                if (printer && !selectedRoom) {
                                                    setSelectedRoom(printer.location || '');
                                                }
                                            }} className="w-full px-3 py-2 border rounded-lg text-sm">
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä...</option>
                                                {filteredPrinters.length === 0 && (printerSearch || selectedRoom) ? (
                                                    <option disabled>–ü—Ä–∏–Ω—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>
                                                ) : filteredPrinters.map(p => (
                                                    <option key={p.id} value={p.id}>
                                                        {p.name} {p.invNumber ? `(${p.invNumber})` : ''} {p.location ? `‚Ä¢ ${p.location}` : ''}
                                                    </option>
                                                ))}
                                            </select>
                                            {filteredPrinters.length === 0 && !printerSearch && !selectedRoom && (
                                                <div className="text-xs text-gray-500">
                                                    üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞–±–∏–Ω–µ—Ç—É –∏–ª–∏ –ø–æ–∏—Å–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞
                                                </div>
                                            )}
                                        </div>

                                        {/* –®–∞–≥ 3: –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) */}
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="text" value={addHistoryForm.location} onChange={e => setAddHistoryForm(prev => ({ ...prev, location: e.target.value }))}
                                                placeholder="–ö–∞–±–∏–Ω–µ—Ç" className="px-3 py-2 border rounded-lg text-sm bg-gray-50" list="locations-list" />
                                            <datalist id="locations-list">
                                                {directories.rooms?.map(r => <option key={r} value={r} />)}
                                            </datalist>
                                            <input type="text" value={addHistoryForm.responsible} onChange={e => setAddHistoryForm(prev => ({ ...prev, responsible: e.target.value }))}
                                                placeholder="–§–ò–û" className="px-3 py-2 border rounded-lg text-sm bg-gray-50" list="people-list" />
                                            <datalist id="people-list">
                                                {directories.people?.map(p => <option key={p} value={p} />)}
                                            </datalist>
                                        </div>

                                        {/* –í—ã–±–æ—Ä –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä) */}
                                        <div className="border rounded-lg p-3 bg-gray-50">
                                            <div className="text-xs font-semibold text-gray-600 mb-2">
                                                –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã:
                                                {addHistoryForm.selectedCartridges.length > 0 && (
                                                    <span className="ml-2 px-2 py-0.5 bg-blue-500 text-white rounded-full text-xs">
                                                        {addHistoryForm.selectedCartridges.length}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {addHistoryForm.printerName ? (
                                                    <>
                                                        {/* –°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏ */}
                                                        {(() => {
                                                            const compatible = getCompatibleCartridges(addHistoryForm.printerName);
                                                            if (compatible.length > 0) {
                                                                return (
                                                                    <>
                                                                        <div className="text-xs font-semibold text-blue-600 mb-1">–°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ:</div>
                                                                        {compatible.map(m => {
                                                                            const isSelected = addHistoryForm.selectedCartridges.includes(m.id);
                                                                            const colorKey = m.type === 'black' ? 'K' : m.type === 'cyan' ? 'C' : m.type === 'magenta' ? 'M' : m.type === 'yellow' ? 'Y' : 'K';
                                                                            const colorInfo = cartridgeColors[colorKey];
                                                                            const stock = stockByModel[m.id];
                                                                            return (
                                                                                <label key={m.id} className={`flex items-center gap-2 p-2 rounded cursor-pointer transition ${isSelected ? 'bg-blue-100 border-2 border-blue-500' : 'bg-white border border-gray-200 hover:bg-gray-50'}`}>
                                                                                    <input type="checkbox"
                                                                                        checked={isSelected}
                                                                                        onChange={e => {
                                                                                            if (e.target.checked) {
                                                                                                setAddHistoryForm(prev => ({ ...prev, selectedCartridges: [...prev.selectedCartridges, m.id] }));
                                                                                            } else {
                                                                                                setAddHistoryForm(prev => ({ ...prev, selectedCartridges: prev.selectedCartridges.filter(id => id !== m.id) }));
                                                                                            }
                                                                                        }}
                                                                                        className="rounded" />
                                                                                    <span className="w-5 h-5 rounded flex items-center justify-center text-xs font-bold flex-shrink-0"
                                                                                        style={{ backgroundColor: colorInfo?.bg, color: colorInfo?.color }}>{colorInfo?.short}</span>
                                                                                    <span className="flex-1 text-xs font-medium text-gray-800">{m.name}</span>
                                                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${stock?.quantity > 0 ? (stock.quantity <= 2 ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700') : 'bg-red-100 text-red-700'}`}>
                                                                                        {stock?.quantity || 0} —à—Ç
                                                                                    </span>
                                                                                </label>
                                                                            );
                                                                        })}
                                                                    </>
                                                                );
                                                            }
                                                            return null;
                                                        })()}
                                                    </>
                                                ) : (
                                                    <div className="text-xs text-gray-500 py-2">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä</div>
                                                )}
                                            </div>
                                        </div>

                                        <input type="text" value={addHistoryForm.notes} onChange={e => setAddHistoryForm(prev => ({ ...prev, notes: e.target.value }))}
                                            placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" className="w-full px-3 py-2 border rounded-lg text-sm" />
                                        <button onClick={handleAddHistory}
                                            disabled={addHistoryForm.selectedCartridges.length === 0}
                                            className={`w-full py-2 rounded-lg font-medium transition ${
                                                addHistoryForm.selectedCartridges.length > 0
                                                    ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                            }`}>
                                            {addHistoryForm.selectedCartridges.length > 0
                                                ? `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ–Ω—É (${addHistoryForm.selectedCartridges.length})`
                                                : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏'}
                                        </button>
                                    </div>
                                )}

                                {/* –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */}
                                <div className="max-h-72 overflow-y-auto space-y-2">
                                    {filteredHistory.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            <div className="text-4xl mb-2">üìã</div>
                                            <div>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ–Ω –ø—É—Å—Ç–∞</div>
                                        </div>
                                    ) : filteredHistory.map(h => {
                                        const model = cartridgeModels.find(m => m.id === h.cartridgeModelId);
                                        const isEditing = editingHistoryId === h.id;
                                        return (
                                            <div key={h.id} className="p-3 bg-gray-50 rounded-xl border border-gray-200">
                                                {isEditing ? (
                                                    <div className="space-y-3">
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <input type="date" value={editHistoryForm.date}
                                                                onChange={e => setEditHistoryForm(prev => ({ ...prev, date: e.target.value }))}
                                                                className="px-2 py-1 border rounded text-xs" />
                                                            <select value={editHistoryForm.printerId}
                                                                onChange={e => {
                                                                    const printer = printers.find(p => p.id === e.target.value);
                                                                    setEditHistoryForm(prev => ({ ...prev, printerId: e.target.value, printerName: printer?.name || '' }));
                                                                }}
                                                                className="px-2 py-1 border rounded text-xs">
                                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä...</option>
                                                                {printers.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                            </select>
                                                            <input type="text" value={editHistoryForm.location}
                                                                onChange={e => setEditHistoryForm(prev => ({ ...prev, location: e.target.value }))}
                                                                placeholder="–ö–∞–±–∏–Ω–µ—Ç" className="px-2 py-1 border rounded text-xs" />
                                                            <input type="text" value={editHistoryForm.responsible}
                                                                onChange={e => setEditHistoryForm(prev => ({ ...prev, responsible: e.target.value }))}
                                                                placeholder="–§–ò–û" className="px-2 py-1 border rounded text-xs" />
                                                        </div>
                                                        <select value={editHistoryForm.cartridgeModelId}
                                                            onChange={e => setEditHistoryForm(prev => ({ ...prev, cartridgeModelId: e.target.value }))}
                                                            className="w-full px-2 py-1 border rounded text-xs">
                                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂...</option>
                                                            {cartridgeModels.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                                        </select>
                                                        <input type="text" value={editHistoryForm.notes || ''}
                                                            onChange={e => setEditHistoryForm(prev => ({ ...prev, notes: e.target.value }))}
                                                            placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" className="w-full px-2 py-1 border rounded text-xs" />
                                                        <div className="flex gap-2">
                                                            <button onClick={saveEditHistory} className="flex-1 py-1.5 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700">
                                                                ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                                            </button>
                                                            <button onClick={() => { setEditingHistoryId(null); setEditHistoryForm(null); }}
                                                                className="flex-1 py-1.5 bg-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-400">
                                                                ‚úï –û—Ç–º–µ–Ω–∞
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex items-start gap-3">
                                                        <div className="text-center">
                                                            <div className="text-xs text-gray-500">{new Date(h.date).toLocaleDateString('ru-RU')}</div>
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-medium text-sm text-gray-900">{model?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞—Ä—Ç—Ä–∏–¥–∂'}</div>
                                                            <div className="text-xs text-gray-500 mt-0.5">
                                                                {h.printerName && <span className="mr-2">üñ®Ô∏è {h.printerName}</span>}
                                                                {h.location && <span className="mr-2">üìç {h.location}</span>}
                                                                {h.responsible && <span>üë§ {h.responsible}</span>}
                                                            </div>
                                                            {h.notes && <div className="text-xs text-gray-400 mt-1 italic">{h.notes}</div>}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {model && (() => {
                                                                const colorKey = model.type === 'black' ? 'K' :
                                                                                model.type === 'cyan' ? 'C' :
                                                                                model.type === 'magenta' ? 'M' :
                                                                                model.type === 'yellow' ? 'Y' : 'K';
                                                                const info = cartridgeColors[colorKey];
                                                                return (
                                                                    <span className="w-5 h-5 rounded flex items-center justify-center text-xs font-bold"
                                                                        style={{ backgroundColor: info?.bg, color: info?.color }}>{info?.short}</span>
                                                                );
                                                            })()}
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => startEditHistory(h)} className="p-1.5 text-blue-600 hover:bg-blue-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                                            <button onClick={() => deleteHistoryEntry(h.id)} className="p-1.5 text-red-600 hover:bg-red-100 rounded" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                {filteredHistory.length > 0 && (
                                    <div className="text-center text-xs text-gray-400">
                                        –ü–æ–∫–∞–∑–∞–Ω–æ: {filteredHistory.length} –∑–∞–ø–∏—Å–µ–π
                                    </div>
                                )}
                            </div>
                        )}

                        {/* –í–∫–ª–∞–¥–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                        {tab === 'stats' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="p-4 bg-blue-50 rounded-xl text-center">
                                        <div className="text-3xl font-bold text-blue-600">{cartridgeHistory.length}</div>
                                        <div className="text-xs text-gray-500">–í—Å–µ–≥–æ –∑–∞–º–µ–Ω</div>
                                    </div>
                                    <div className="p-4 bg-green-50 rounded-xl text-center">
                                        <div className="text-3xl font-bold text-green-600">{Object.values(stockByModel).reduce((sum, s) => sum + s.quantity, 0)}</div>
                                        <div className="text-xs text-gray-500">–ù–∞ —Å–∫–ª–∞–¥–µ</div>
                                    </div>
                                    <div className="p-4 bg-red-50 rounded-xl text-center">
                                        <div className="text-3xl font-bold text-red-600">{criticalItems.length}</div>
                                        <div className="text-xs text-gray-500">–ö—Ä–∏—Ç–∏—á–Ω–æ</div>
                                    </div>
                                </div>

                                <div className="p-4 bg-gray-50 rounded-xl">
                                    <div className="font-semibold text-sm mb-3">üìÖ –†–∞—Å—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {monthlyStats.length === 0 ? (
                                            <div className="text-center py-4 text-gray-400 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                                        ) : monthlyStats.map(([month, data]) => {
                                            const [year, m] = month.split('-');
                                            const monthName = new Date(year, parseInt(m) - 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
                                            return (
                                                <div key={month} className="flex items-center gap-3">
                                                    <div className="w-32 text-sm text-gray-600">{monthName}</div>
                                                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                                                        <div className="bg-blue-500 rounded-full h-4" style={{ width: `${Math.min(100, data.total * 10)}%` }}></div>
                                                    </div>
                                                    <div className="w-12 text-right font-semibold text-sm">{data.total}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {monthlyStats.length >= 3 && (
                                    <div className="p-4 bg-purple-50 rounded-xl">
                                        <div className="font-semibold text-sm mb-2">üìà –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–∞</div>
                                        <div className="text-xs text-gray-600">
                                            {(() => {
                                                const avg = monthlyStats.slice(0, 3).reduce((sum, [, d]) => sum + d.total, 0) / Math.min(3, monthlyStats.length);
                                                return (
                                                    <>
                                                        <div>–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –∑–∞ 3 –º–µ—Å: <strong>{avg.toFixed(1)}</strong> –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π/–º–µ—Å</div>
                                                        <div>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–≤–∞—Ä—Ç–∞–ª: <strong>{Math.round(avg * 3)}</strong> –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</div>
                                                        <div>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≥–æ–¥: <strong>{Math.round(avg * 12)}</strong> –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* –í–∫–ª–∞–¥–∫–∞: –ü—Ä–∏–Ω—Ç–µ—Ä—ã/–ú–§–£ */}
                        {tab === 'printers' && (
                            <div className="space-y-4">
                                <div className="text-sm text-gray-500 mb-3">
                                    –ü—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –≤—Å–µ–≥–æ: {printers.length} ‚Ä¢ –ó–∞–º–µ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {cartridgeHistory.length}
                                </div>
                                <div className="max-h-96 overflow-y-auto space-y-3">
                                    {printerCartridgeStats.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            <div className="text-4xl mb-2">üñ®Ô∏è</div>
                                            <div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞—Ö</div>
                                        </div>
                                    ) : printerCartridgeStats.map(stat => (
                                        <div key={stat.printer.id} className={`p-4 rounded-xl border-2 ${stat.hasEmpty ? 'bg-red-50 border-red-300' : stat.hasLow ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-200'}`}>
                                            <div className="flex items-start gap-3">
                                                <div className="text-3xl">üñ®Ô∏è</div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-semibold text-sm text-gray-900">{stat.printer.name}</div>
                                                    <div className="text-xs text-gray-500 mt-0.5">
                                                        {stat.printer.invNumber && <span className="mr-2">üìã {stat.printer.invNumber}</span>}
                                                        {stat.printer.location && <span className="mr-2">üìç {stat.printer.location}</span>}
                                                        {stat.printer.responsible && <span>üë§ {stat.printer.responsible}</span>}
                                                    </div>

                                                    {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞—Ö */}
                                                    <div className="mt-3 space-y-2">
                                                        <div className="flex items-center justify-between">
                                                            <div className="text-xs font-semibold text-gray-700">–°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏:</div>
                                                            <button
                                                                onClick={() => openManualMapping(stat.printer)}
                                                                className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                                                title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—Ä–∏–¥–∂ –≤—Ä—É—á–Ω—É—é"
                                                            >
                                                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                                                            </button>
                                                        </div>
                                                        {stat.compatible.length === 0 ? (
                                                            <div className="text-xs text-gray-400 italic">
                                                                –ö–∞—Ä—Ç—Ä–∏–¥–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å" –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏.
                                                            </div>
                                                        ) : (
                                                            <div className="space-y-1.5">
                                                                {stat.stockInfo.map(info => {
                                                                    const colorInfo = cartridgeColors[info.model.type];
                                                                    const isManual = manualCartridgeMapping[stat.printer.id]?.includes(info.model.id);
                                                                    return (
                                                                        <div key={info.model.id} className="flex items-center gap-2 text-xs">
                                                                            <span className="w-6 h-6 rounded flex items-center justify-center font-bold text-xs"
                                                                                style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                                                {colorInfo.short}
                                                                            </span>
                                                                            <span className="flex-1 text-gray-700">{info.model.name}</span>
                                                                            {isManual && (
                                                                                <span className="px-1.5 py-0.5 text-[10px] bg-purple-100 text-purple-700 rounded" title="–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é">
                                                                                    —Ä—É—á–Ω.
                                                                                </span>
                                                                            )}
                                                                            <span className={`px-2 py-0.5 rounded-full font-semibold ${
                                                                                info.quantity === 0 ? 'bg-red-100 text-red-700' :
                                                                                info.quantity <= 2 ? 'bg-yellow-100 text-yellow-700' :
                                                                                'bg-green-100 text-green-700'
                                                                            }`}>
                                                                                {info.quantity} —à—Ç
                                                                            </span>
                                                                            {isManual && (
                                                                                <button
                                                                                    onClick={() => removeManualMapping(stat.printer.id, info.model.id)}
                                                                                    className="p-1 text-red-600 hover:bg-red-100 rounded"
                                                                                    title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É"
                                                                                >
                                                                                    ‚úï
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* –°—á—ë—Ç—á–∏–∫ –∑–∞–º–µ–Ω */}
                                                <div className="flex flex-col items-center gap-1">
                                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center ${
                                                        stat.hasEmpty ? 'bg-red-500' :
                                                        stat.hasLow ? 'bg-yellow-500' :
                                                        'bg-green-500'
                                                    }`}>
                                                        <div className="text-center text-white">
                                                            <div className="text-2xl font-bold">{stat.totalStock}</div>
                                                            <div className="text-[8px] leading-none">–∫–∞—Ä—Ç—Ä.</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-gray-500 text-center mt-1">
                                                        <div className="font-semibold">{stat.replacements}</div>
                                                        <div className="text-[10px]">–∑–∞–º–µ–Ω</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* –í–∫–ª–∞–¥–∫–∞: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ */}
                        {tab === 'catalog' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-500">–í—Å–µ–≥–æ –º–æ–¥–µ–ª–µ–π: {cartridgeModels.length}</span>
                                    <button onClick={() => setShowAddModel(true)} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å
                                    </button>
                                </div>

                                {showAddModel && (
                                    <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 space-y-3">
                                        <div className="flex items-center justify-between">
                                            <span className="font-semibold text-blue-800">–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞</span>
                                            <button onClick={() => setShowAddModel(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="text" value={newModelForm.name} onChange={e => setNewModelForm(prev => ({ ...prev, name: e.target.value }))}
                                                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (HP 85A)" className="px-3 py-2 border rounded-lg text-sm" />
                                            <select value={newModelForm.type} onChange={e => setNewModelForm(prev => ({ ...prev, type: e.target.value }))}
                                                className="px-3 py-2 border rounded-lg text-sm">
                                                {Object.entries(cartridgeColors).map(([key, info]) => (
                                                    <option key={key} value={key}>{info.name}</option>
                                                ))}
                                            </select>
                                            <input type="number" value={newModelForm.pageYield} onChange={e => setNewModelForm(prev => ({ ...prev, pageYield: e.target.value }))}
                                                placeholder="–†–µ—Å—É—Ä—Å (—Å—Ç—Ä–∞–Ω–∏—Ü)" className="px-3 py-2 border rounded-lg text-sm" />
                                        </div>
                                        <input type="text" value={newModelForm.compatiblePrinters} onChange={e => setNewModelForm(prev => ({ ...prev, compatiblePrinters: e.target.value }))}
                                            placeholder="–°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" className="w-full px-3 py-2 border rounded-lg text-sm" />
                                        <button onClick={handleAddModel} className="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                            –î–æ–±–∞–≤–∏—Ç—å
                                        </button>
                                    </div>
                                )}

                                <div className="max-h-72 overflow-y-auto space-y-2">
                                    {cartridgeModels.map(model => {
                                        const colorInfo = cartridgeColors[model.type];
                                        const isEditing = editingModelId === model.id;
                                        return (
                                            <div key={model.id} className="p-3 bg-gray-50 rounded-xl border border-gray-200">
                                                {isEditing ? (
                                                    <div className="space-y-3">
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <input type="text" value={editModelForm.name}
                                                                onChange={e => setEditModelForm(prev => ({ ...prev, name: e.target.value }))}
                                                                placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="px-2 py-1 border rounded text-xs" />
                                                            <select value={editModelForm.type}
                                                                onChange={e => setEditModelForm(prev => ({ ...prev, type: e.target.value }))}
                                                                className="px-2 py-1 border rounded text-xs">
                                                                {Object.entries(cartridgeColors).map(([key, info]) => (
                                                                    <option key={key} value={key}>{info.name}</option>
                                                                ))}
                                                            </select>
                                                            <input type="number" value={editModelForm.pageYield}
                                                                onChange={e => setEditModelForm(prev => ({ ...prev, pageYield: e.target.value }))}
                                                                placeholder="–†–µ—Å—É—Ä—Å (—Å—Ç—Ä–∞–Ω–∏—Ü)" className="px-2 py-1 border rounded text-xs" />
                                                        </div>
                                                        <input type="text" value={editModelForm.compatiblePrinters}
                                                            onChange={e => setEditModelForm(prev => ({ ...prev, compatiblePrinters: e.target.value }))}
                                                            placeholder="–°–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" className="w-full px-2 py-1 border rounded text-xs" />
                                                        <div className="flex gap-2">
                                                            <button onClick={saveEditModel} className="flex-1 py-1.5 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700">
                                                                ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                                            </button>
                                                            <button onClick={() => { setEditingModelId(null); setEditModelForm(null); }}
                                                                className="flex-1 py-1.5 bg-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-400">
                                                                ‚úï –û—Ç–º–µ–Ω–∞
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold"
                                                            style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                            {colorInfo.short}
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="font-medium text-sm">{model.name}</div>
                                                            <div className="text-xs text-gray-500">
                                                                ~{model.pageYield.toLocaleString()} —Å—Ç—Ä.
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => startEditModel(model)} className="p-1.5 text-blue-600 hover:bg-blue-100 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                                            <button onClick={() => deleteModel(model.id)} className="p-1.5 text-red-600 hover:bg-red-100 rounded" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </Modal>

                {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É */}
                {showPurchaseEditor && (
                    <Modal isOpen={showPurchaseEditor} onClose={() => setShowPurchaseEditor(false)} title="üìù –†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É" size="lg">
                        <div className="space-y-4">
                            <div className="text-sm text-gray-600">
                                –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–∫–ª—é—á–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏.
                            </div>

                            <div className="max-h-96 overflow-y-auto space-y-2">
                                {purchaseOrder.map((item, idx) => {
                                    const colorInfo = cartridgeColors[item.model.type];
                                    return (
                                        <div key={idx} className="p-3 bg-gray-50 rounded-xl border border-gray-200">
                                            <div className="flex items-center gap-3">
                                                <input type="checkbox" checked={item.include}
                                                    onChange={e => setPurchaseOrder(prev => prev.map((p, i) => i === idx ? { ...p, include: e.target.checked } : p))}
                                                    className="w-5 h-5 rounded" />
                                                <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold"
                                                    style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                    {colorInfo.short}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium text-sm">{item.model.name}</div>
                                                    <div className="text-xs text-gray-500">
                                                        –ù–∞ —Å–∫–ª–∞–¥–µ: {item.currentQty} —à—Ç
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs text-gray-500">–ó–∞–∫–∞–∑–∞—Ç—å:</span>
                                                    <input type="number" min="1" value={item.orderQty}
                                                        onChange={e => setPurchaseOrder(prev => prev.map((p, i) => i === idx ? { ...p, orderQty: parseInt(e.target.value) || 1 } : p))}
                                                        className="w-16 px-2 py-1 border rounded text-sm text-center" />
                                                    <span className="text-xs text-gray-500">—à—Ç</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="p-4 bg-blue-50 rounded-xl">
                                <div className="text-sm text-gray-600 text-center">
                                    –í—ã–±—Ä–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <strong>{purchaseOrder.filter(i => i.include).length}</strong>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={printPurchaseOrder} disabled={purchaseOrder.filter(i => i.include).length === 0}
                                    className={`flex-1 py-3 rounded-lg text-sm font-medium ${
                                        purchaseOrder.filter(i => i.include).length > 0
                                            ? 'bg-purple-600 text-white hover:bg-purple-700'
                                            : 'bg-gray-200 text-gray-400'
                                    }`}>
                                    üñ®Ô∏è –ü–µ—á–∞—Ç—å –∑–∞—è–≤–∫–∏
                                </button>
                                <button onClick={() => setShowPurchaseEditor(false)} className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </Modal>
                )}

                {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É */}
                {showManualMapping && mappingPrinter && (
                    <Modal isOpen={true} onClose={() => setShowManualMapping(false)} title={`–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—Ä–∏–¥–∂ –∫ ${mappingPrinter.name}`} size="md">
                        <div className="space-y-4">
                            <div className="text-sm text-gray-600">
                                –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ —ç—Ç–æ–º—É –ø—Ä–∏–Ω—Ç–µ—Ä—É:
                            </div>

                            <select
                                value={selectedCartridgeForMapping}
                                onChange={e => setSelectedCartridgeForMapping(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg text-sm"
                            >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂...</option>
                                {cartridgeModels
                                    .filter(m => {
                                        // –§–∏–ª—å—Ç—Ä—É–µ–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∏
                                        const existingCompatible = getCompatibleCartridges(mappingPrinter.name, mappingPrinter.id);
                                        return !existingCompatible.find(c => c.id === m.id);
                                    })
                                    .map(m => (
                                        <option key={m.id} value={m.id}>
                                            {m.name} ({cartridgeColors[m.type]?.name})
                                        </option>
                                    ))
                                }
                            </select>

                            {selectedCartridgeForMapping && (() => {
                                const model = cartridgeModels.find(m => m.id === selectedCartridgeForMapping);
                                if (!model) return null;
                                const colorInfo = cartridgeColors[model.type];
                                const stock = stockByModel[model.id];
                                return (
                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold"
                                                style={{ backgroundColor: colorInfo.bg, color: colorInfo.color }}>
                                                {colorInfo.short}
                                            </div>
                                            <div className="flex-1">
                                                <div className="font-medium text-sm">{model.name}</div>
                                                <div className="text-xs text-gray-500">
                                                    –†–µ—Å—É—Ä—Å: {model.pageYield.toLocaleString()} —Å—Ç—Ä
                                                </div>
                                            </div>
                                            <div className={`px-2 py-1 rounded text-xs font-semibold ${
                                                (stock?.quantity || 0) === 0 ? 'bg-red-100 text-red-700' :
                                                (stock?.quantity || 0) <= 2 ? 'bg-yellow-100 text-yellow-700' :
                                                'bg-green-100 text-green-700'
                                            }`}>
                                                {stock?.quantity || 0} —à—Ç
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            <div className="flex gap-3">
                                <button
                                    onClick={addManualMapping}
                                    disabled={!selectedCartridgeForMapping}
                                    className={`flex-1 py-2 rounded-lg text-sm font-medium ${
                                        selectedCartridgeForMapping
                                            ? 'bg-blue-600 text-white hover:bg-blue-700'
                                            : 'bg-gray-200 text-gray-400'
                                    }`}
                                >
                                    ‚úÖ –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                                <button
                                    onClick={() => setShowManualMapping(false)}
                                    className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300"
                                >
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </Modal>
                )}
            </React.Fragment>
        );
        };

        const StatsModal = ({ isOpen, onClose, stats, equipment }) => {
            const byCategory = useMemo(() => {
                const result = {};
                equipment.forEach(item => {
                    if (!result[item.category]) result[item.category] = { total: 0, checked: 0 };
                    result[item.category].total++;
                    if (item.checked || item.writeOff) result[item.category].checked++;
                });
                return Object.entries(result).sort((a, b) => b[1].total - a[1].total);
            }, [equipment]);

            const byBuilding = useMemo(() => {
                const result = { '–ù–∞–Ω—Å–µ–Ω–∞': { total: 0, checked: 0 }, '–ë–æ—Ç–∞–Ω–∏—á–∫–∞': { total: 0, checked: 0 }, '–ù–µ —É–∫–∞–∑–∞–Ω–æ': { total: 0, checked: 0 } };
                equipment.forEach(item => {
                    const b = item.building || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    if (!result[b]) result[b] = { total: 0, checked: 0 };
                    result[b].total++;
                    if (item.checked || item.writeOff) result[b].checked++;
                });
                return result;
            }, [equipment]);

            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" size="lg">
                    <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-3">
                            <div className="stat-card text-center">
                                <div className="text-3xl font-bold text-blue-600">{stats.total}</div>
                                <div className="text-xs text-gray-500 font-semibold">–í—Å–µ–≥–æ</div>
                            </div>
                            <div className="stat-card text-center">
                                <div className="text-3xl font-bold text-green-600">{stats.checked}</div>
                                <div className="text-xs text-gray-500 font-semibold">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                            </div>
                            <div className="stat-card text-center">
                                <div className="text-3xl font-bold text-amber-600">{stats.pending}</div>
                                <div className="text-xs text-gray-500 font-semibold">–û–∂–∏–¥–∞–µ—Ç</div>
                            </div>
                            <div className="stat-card text-center">
                                <div className="text-3xl font-bold text-red-600">{stats.writeOff}</div>
                                <div className="text-xs text-gray-500 font-semibold">–°–ø–∏—Å–∞–Ω–∏–µ</div>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-700 mb-3">–ü–æ –∑–¥–∞–Ω–∏—è–º</h3>
                            {Object.entries(byBuilding).map(([building, data]) => (
                                <div key={building} className="flex items-center gap-3 mb-2">
                                    <span className="text-lg">{building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'üè¢' : '‚ùì'}</span>
                                    <span className="flex-1 text-sm font-medium">{building}</span>
                                    <div className="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-green-500 rounded-full" style={{ width: `${data.total > 0 ? (data.checked / data.total) * 100 : 0}%` }} />
                                    </div>
                                    <span className="text-xs text-gray-500 w-16 text-right">{data.checked}/{data.total}</span>
                                </div>
                            ))}
                        </div>

                        <div>
                            <h3 className="font-bold text-gray-700 mb-3">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                            {byCategory.map(([category, data]) => {
                                const config = categoryConfig[category] || defaultCatConfig;
                                return (
                                    <div key={category} className="flex items-center gap-3 mb-2">
                                        <span className="text-lg">{config.icon}</span>
                                        <span className="flex-1 text-sm font-medium truncate">{category}</span>
                                        <div className="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div className="h-full rounded-full" style={{ width: `${data.total > 0 ? (data.checked / data.total) * 100 : 0}%`, background: config.color }} />
                                        </div>
                                        <span className="text-xs text-gray-500 w-16 text-right">{data.checked}/{data.total}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </Modal>
            );
        };

        const HistoryModal = ({ isOpen, onClose, history, onViewItem }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üìú –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π" size="md">
                    {history.length === 0 ? (
                        <div className="text-center py-8 text-gray-400">
                            <div className="text-4xl mb-2">üìú</div>
                            <p className="text-sm">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
                        </div>
                    ) : (
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {history.map((entry, idx) => (
                                <div key={idx} onClick={() => entry.item && onViewItem(entry.item)} 
                                    className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm ${
                                        entry.action === 'check' ? 'bg-green-100 text-green-600' :
                                        entry.action === 'writeoff' ? 'bg-red-100 text-red-600' :
                                        entry.action === 'undo' ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-600'
                                    }`}>
                                        {entry.action === 'check' ? '‚úì' : entry.action === 'writeoff' ? 'üìù' : entry.action === 'undo' ? '‚Ü©' : '‚ûï'}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="font-mono text-xs font-bold text-gray-700">{entry.invNumber}</div>
                                        <div className="text-xs text-gray-400">{entry.time}</div>
                                    </div>
                                    <span className="text-xs text-gray-500">{entry.actionText}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </Modal>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        const AnalyticsModal = ({ isOpen, onClose, equipment, onPrintReconciliation }) => {
            const currentYear = new Date().getFullYear();

            // –ê–Ω–∞–ª–∏–∑ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
            const ageAnalysis = useMemo(() => {
                const ranges = { '–î–æ 3 –ª–µ—Ç': 0, '3-5 –ª–µ—Ç': 0, '5-10 –ª–µ—Ç': 0, '–°—Ç–∞—Ä—à–µ 10 –ª–µ—Ç': 0, '–ë–µ–∑ –¥–∞—Ç—ã': 0 };
                equipment.forEach(item => {
                    if (!item.date) { ranges['–ë–µ–∑ –¥–∞—Ç—ã']++; return; }
                    const parts = item.date.split('.');
                    if (parts.length !== 3) { ranges['–ë–µ–∑ –¥–∞—Ç—ã']++; return; }
                    const year = parseInt(parts[2]);
                    const age = currentYear - year;
                    if (age < 3) ranges['–î–æ 3 –ª–µ—Ç']++;
                    else if (age < 5) ranges['3-5 –ª–µ—Ç']++;
                    else if (age < 10) ranges['5-10 –ª–µ—Ç']++;
                    else ranges['–°—Ç–∞—Ä—à–µ 10 –ª–µ—Ç']++;
                });
                return ranges;
            }, [equipment, currentYear]);

            // –ü—Ä–æ–≥–Ω–æ–∑ —Å–ø–∏—Å–∞–Ω–∏—è (–∏–∑–Ω–æ—Å 100% –∏–ª–∏ —Å—Ä–æ–∫ –≤—ã—à–µ–ª)
            const writeOffForecast = useMemo(() => {
                return equipment.filter(item => {
                    if (item.writeOff) return false; // –£–∂–µ —Å–ø–∏—Å–∞–Ω–æ
                    // –ò–∑–Ω–æ—Å 100%
                    if (item.wear === '100,00' || item.wear === '100.00' || item.wear === '100') return true;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ —Å–ª—É–∂–±—ã
                    if (item.date && item.term) {
                        const parts = item.date.split('.');
                        if (parts.length === 3) {
                            const startYear = parseInt(parts[2]);
                            const termMonths = parseInt(item.term) || 0;
                            const endYear = startYear + Math.floor(termMonths / 12);
                            if (currentYear >= endYear) return true;
                        }
                    }
                    return false;
                }).sort((a, b) => (a.category || '').localeCompare(b.category || '', 'ru'));
            }, [equipment, currentYear]);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–¥–∞–Ω–∏—è–º
            const buildingStats = useMemo(() => {
                const stats = {};
                equipment.forEach(item => {
                    const b = item.building || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    if (!stats[b]) stats[b] = { total: 0, checked: 0, writeOff: 0 };
                    stats[b].total++;
                    if (item.checked) stats[b].checked++;
                    if (item.writeOff) stats[b].writeOff++;
                });
                return stats;
            }, [equipment]);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
            const yearStats = useMemo(() => {
                const stats = {};
                equipment.forEach(item => {
                    if (!item.date) return;
                    const parts = item.date.split('.');
                    if (parts.length === 3) {
                        const year = parts[2];
                        if (!stats[year]) stats[year] = 0;
                        stats[year]++;
                    }
                });
                return Object.entries(stats).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 10);
            }, [equipment]);

            const maxYearCount = Math.max(...yearStats.map(([, count]) => count), 1);

            if (!isOpen) return null;

            const total = equipment.length;
            const checked = equipment.filter(i => i.checked && !i.writeOff).length;
            const writeOff = equipment.filter(i => i.writeOff).length;
            const pending = equipment.filter(i => !i.checked && !i.writeOff).length;
            const noLabel = equipment.filter(i => i.hasLabel === false).length;
            const progress = total > 0 ? Math.round((checked + writeOff) / total * 100) : 0;

            const ageColors = { '–î–æ 3 –ª–µ—Ç': '#38a169', '3-5 –ª–µ—Ç': '#3182ce', '5-10 –ª–µ—Ç': '#d69e2e', '–°—Ç–∞—Ä—à–µ 10 –ª–µ—Ç': '#e53e3e', '–ë–µ–∑ –¥–∞—Ç—ã': '#a0aec0' };
            const totalWithDate = Object.entries(ageAnalysis).filter(([k]) => k !== '–ë–µ–∑ –¥–∞—Ç—ã').reduce((sum, [, v]) => sum + v, 0);

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞" size="lg">
                    <div className="space-y-6 max-h-[70vh] overflow-y-auto">

                        {/* –î–∞—à–±–æ—Ä–¥ */}
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">üìä –î–∞—à–±–æ—Ä–¥</h3>

                            {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
                            <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-xl">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-semibold text-gray-700">–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</span>
                                    <span className="text-2xl font-bold text-green-600">{progress}%</span>
                                </div>
                                <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all duration-500" style={{ width: `${progress}%` }} />
                                </div>
                                <div className="flex justify-between mt-2 text-xs text-gray-500">
                                    <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {checked + writeOff} –∏–∑ {total}</span>
                                    <span>–û—Å—Ç–∞–ª–æ—Å—å: {pending}</span>
                                </div>
                            </div>

                            {/* –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ */}
                            <div className="grid grid-cols-4 gap-2">
                                <div className="text-center p-3 bg-blue-50 rounded-lg">
                                    <div className="text-2xl font-bold text-blue-600">{total}</div>
                                    <div className="text-xs text-gray-500">–í—Å–µ–≥–æ</div>
                                </div>
                                <div className="text-center p-3 bg-green-50 rounded-lg">
                                    <div className="text-2xl font-bold text-green-600">{checked}</div>
                                    <div className="text-xs text-gray-500">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                                </div>
                                <div className="text-center p-3 bg-amber-50 rounded-lg">
                                    <div className="text-2xl font-bold text-amber-600">{pending}</div>
                                    <div className="text-xs text-gray-500">–û–∂–∏–¥–∞–µ—Ç</div>
                                </div>
                                <div className="text-center p-3 bg-red-50 rounded-lg">
                                    <div className="text-2xl font-bold text-red-600">{writeOff}</div>
                                    <div className="text-xs text-gray-500">–°–ø–∏—Å–∞–Ω–æ</div>
                                </div>
                            </div>

                            {/* –ü–æ –∑–¥–∞–Ω–∏—è–º - –º–∏–Ω–∏ –≥—Ä–∞—Ñ–∏–∫ */}
                            <div className="mt-4 grid grid-cols-2 gap-3">
                                {Object.entries(buildingStats).filter(([b]) => b !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ').map(([building, data]) => (
                                    <div key={building} className="p-3 bg-gray-50 rounded-lg">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span>{building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'}</span>
                                            <span className="font-semibold text-sm">{building}</span>
                                        </div>
                                        <div className="text-lg font-bold text-gray-700">{data.total} –µ–¥.</div>
                                        <div className="h-1.5 bg-gray-200 rounded-full mt-1">
                                            <div className="h-full bg-green-500 rounded-full" style={{ width: `${data.total > 0 ? (data.checked / data.total) * 100 : 0}%` }} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* –ê–Ω–∞–ª–∏–∑ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É */}
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">üìÖ –ê–Ω–∞–ª–∏–∑ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É</h3>
                            <div className="space-y-2">
                                {Object.entries(ageAnalysis).filter(([k]) => k !== '–ë–µ–∑ –¥–∞—Ç—ã').map(([range, count]) => (
                                    <div key={range} className="flex items-center gap-3">
                                        <span className="w-28 text-sm font-medium text-gray-600">{range}</span>
                                        <div className="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                                            <div className="h-full rounded-full flex items-center justify-end pr-2 text-xs text-white font-bold"
                                                style={{ width: `${totalWithDate > 0 ? (count / totalWithDate) * 100 : 0}%`, background: ageColors[range], minWidth: count > 0 ? '40px' : '0' }}>
                                                {count > 0 && count}
                                            </div>
                                        </div>
                                        <span className="w-12 text-right text-xs text-gray-500">{totalWithDate > 0 ? Math.round((count / totalWithDate) * 100) : 0}%</span>
                                    </div>
                                ))}
                            </div>
                            {ageAnalysis['–ë–µ–∑ –¥–∞—Ç—ã'] > 0 && (
                                <div className="mt-2 text-xs text-gray-400">* –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—ã: {ageAnalysis['–ë–µ–∑ –¥–∞—Ç—ã']} –µ–¥.</div>
                            )}
                        </div>

                        {/* –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π –ø–æ –≥–æ–¥–∞–º */}
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">üìà –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ –≥–æ–¥–∞–º</h3>
                            <div className="flex items-end gap-1 h-32 p-3 bg-gray-50 rounded-lg">
                                {yearStats.map(([year, count]) => (
                                    <div key={year} className="flex-1 flex flex-col items-center">
                                        <div className="w-full bg-blue-500 rounded-t transition-all hover:bg-blue-600"
                                            style={{ height: `${(count / maxYearCount) * 100}%`, minHeight: '4px' }}
                                            title={`${year}: ${count} –µ–¥.`} />
                                        <span className="text-xs text-gray-500 mt-1 transform -rotate-45 origin-top-left">{year.slice(2)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* –ü—Ä–æ–≥–Ω–æ–∑ —Å–ø–∏—Å–∞–Ω–∏—è */}
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                ‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Å–ø–∏—Å–∞–Ω–∏—è
                                <span className="px-2 py-0.5 bg-red-100 text-red-600 rounded-full text-xs font-bold">{writeOffForecast.length}</span>
                            </h3>
                            {writeOffForecast.length === 0 ? (
                                <div className="text-center py-4 text-gray-400 text-sm">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è</div>
                            ) : (
                                <div className="space-y-2 max-h-48 overflow-y-auto">
                                    {writeOffForecast.slice(0, 20).map(item => (
                                        <div key={item.id} className="flex items-center gap-3 p-2 bg-red-50 rounded-lg text-sm">
                                            <span className="font-mono text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">{item.invNumber}</span>
                                            <span className="flex-1 truncate text-gray-700">{item.name}</span>
                                            <span className="text-xs text-red-500 whitespace-nowrap">
                                                {item.wear === '100,00' || item.wear === '100.00' ? '–ò–∑–Ω–æ—Å 100%' : '–°—Ä–æ–∫ –≤—ã—à–µ–ª'}
                                            </span>
                                        </div>
                                    ))}
                                    {writeOffForecast.length > 20 && (
                                        <div className="text-center text-xs text-gray-400">...–∏ –µ—â—ë {writeOffForecast.length - 20}</div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* –ü—Ä–æ–±–ª–µ–º—ã */}
                        {noLabel > 0 && (
                            <div className="p-3 bg-amber-50 rounded-lg border border-amber-200">
                                <div className="flex items-center gap-2 text-amber-700">
                                    <span>‚ö†Ô∏è</span>
                                    <span className="font-semibold">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</span>
                                    <span className="font-bold">{noLabel} –µ–¥. –±–µ–∑ –±–∏—Ä–∫–∏</span>
                                </div>
                            </div>
                        )}

                        {/* –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∞ —Å–≤–µ—Ä–∫–∏ */}
                        <button
                            onClick={onPrintReconciliation}
                            className="w-full py-4 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all"
                        >
                            üìã –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç —Å–≤–µ—Ä–∫–∏
                        </button>
                    </div>
                </Modal>
            );
        };

        const ExportModal = ({ isOpen, onClose, onExportExcel, onExportCheckedReport, onPrintNotFound, onOpenFilterReport, onExportJSON, onImport, onClearAll }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç" size="sm">
                    <div className="space-y-3">
                        <button onClick={onExportExcel} className="touch-btn w-full py-4 bg-green-100 hover:bg-green-200 text-green-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üìä</span>
                            <div className="text-left">
                                <div>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</div>
                                <div className="text-xs opacity-75">CSV —Ñ–∞–π–ª –¥–ª—è —Ç–∞–±–ª–∏—Ü</div>
                            </div>
                        </button>
                        <button onClick={onExportCheckedReport} className="touch-btn w-full py-4 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üìÑ</span>
                            <div className="text-left">
                                <div>–û—Ç—á—ë—Ç PDF</div>
                                <div className="text-xs opacity-75">–ö—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á—ë—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏</div>
                            </div>
                        </button>
                        <button onClick={onPrintNotFound} className="touch-btn w-full py-4 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üîç</span>
                            <div className="text-left">
                                <div>–ü–æ–∏—Å–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</div>
                                <div className="text-xs opacity-75">–ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö</div>
                            </div>
                        </button>
                        <button onClick={onOpenFilterReport} className="touch-btn w-full py-4 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üìã</span>
                            <div className="text-left">
                                <div>–û—Ç—á—ë—Ç –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</div>
                                <div className="text-xs opacity-75">–ü–æ –§–ò–û, –∫–∞–±–∏–Ω–µ—Ç—É –∏–ª–∏ —ç—Ç–∞–∂—É</div>
                            </div>
                        </button>
                        <hr className="my-2" />
                        <button onClick={onExportJSON} className="touch-btn w-full py-4 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üíæ</span>
                            <div className="text-left">
                                <div>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</div>
                                <div className="text-xs opacity-75">JSON —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏</div>
                            </div>
                        </button>
                        <button onClick={onImport} className="touch-btn w-full py-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-semibold flex items-center justify-center gap-3">
                            <span className="text-2xl">üì•</span>
                            <div className="text-left">
                                <div>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                                <div className="text-xs opacity-75">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON —Ñ–∞–π–ª</div>
                            </div>
                        </button>
                        <hr className="my-2" />
                        <button onClick={onClearAll} className="touch-btn w-full py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-semibold text-sm">
                            üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </Modal>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á—ë—Ç–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
        const ReportFilterModal = ({ isOpen, onClose, filterType, filterValue, filterBuilding, onFilterTypeChange, onFilterValueChange, onBuildingChange, onPrint, uniqueResponsibles, uniqueLocations, uniqueBuildings, uniqueYears, getFloorsByBuilding, getLocationsByBuilding }) => {
            if (!isOpen) return null;

            // –¢—Ä–µ–±—É—é—Ç –≤—ã–±–æ—Ä–∞ –∑–¥–∞–Ω–∏—è: location –∏ floor
            const needsBuilding = filterType === 'floor' || filterType === 'location';

            const getOptions = () => {
                switch (filterType) {
                    case 'responsible': return uniqueResponsibles;
                    case 'location': return filterBuilding ? getLocationsByBuilding(filterBuilding) : [];
                    case 'floor': return filterBuilding ? getFloorsByBuilding(filterBuilding) : [];
                    case 'year': return uniqueYears;
                    default: return [];
                }
            };

            const getPlaceholder = () => {
                switch (filterType) {
                    case 'responsible': return '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ';
                    case 'location': return filterBuilding ? '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–±–∏–Ω–µ—Ç' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
                    case 'floor': return filterBuilding ? '–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂' : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
                    case 'year': return '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥';
                    default: return '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
                }
            };

            const canPrint = needsBuilding ? (filterBuilding && filterValue) : filterValue;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üìã –û—Ç—á—ë—Ç –ø–æ —Ñ–∏–ª—å—Ç—Ä—É" size="sm">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">–¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞</label>
                            <div className="grid grid-cols-4 gap-2">
                                <button
                                    onClick={() => { onFilterTypeChange('responsible'); onFilterValueChange(''); onBuildingChange(''); }}
                                    className={`py-3 px-1 rounded-lg text-xs font-medium transition-all ${filterType === 'responsible' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    üë§ –§–ò–û
                                </button>
                                <button
                                    onClick={() => { onFilterTypeChange('location'); onFilterValueChange(''); onBuildingChange(''); }}
                                    className={`py-3 px-1 rounded-lg text-xs font-medium transition-all ${filterType === 'location' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    üö™ –ö–∞–±–∏–Ω–µ—Ç
                                </button>
                                <button
                                    onClick={() => { onFilterTypeChange('floor'); onFilterValueChange(''); onBuildingChange(''); }}
                                    className={`py-3 px-1 rounded-lg text-xs font-medium transition-all ${filterType === 'floor' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    üè¢ –≠—Ç–∞–∂
                                </button>
                                <button
                                    onClick={() => { onFilterTypeChange('year'); onFilterValueChange(''); onBuildingChange(''); }}
                                    className={`py-3 px-1 rounded-lg text-xs font-medium transition-all ${filterType === 'year' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    üìÖ –ì–æ–¥
                                </button>
                            </div>
                        </div>

                        {needsBuilding && (
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">üè´ –ó–¥–∞–Ω–∏–µ</label>
                                <select
                                    value={filterBuilding}
                                    onChange={(e) => { onBuildingChange(e.target.value); onFilterValueChange(''); }}
                                    className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 text-base"
                                >
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</option>
                                    {uniqueBuildings.map(b => (
                                        <option key={b} value={b}>{b}</option>
                                    ))}
                                </select>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                {filterType === 'responsible' ? 'üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π' : filterType === 'location' ? 'üö™ –ö–∞–±–∏–Ω–µ—Ç' : filterType === 'year' ? 'üìÖ –ì–æ–¥ –≤–≤–æ–¥–∞' : 'üìç –≠—Ç–∞–∂'}
                            </label>
                            <select
                                value={filterValue}
                                onChange={(e) => onFilterValueChange(e.target.value)}
                                disabled={needsBuilding && !filterBuilding}
                                className={`w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 text-base ${needsBuilding && !filterBuilding ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                            >
                                <option value="">{getPlaceholder()}</option>
                                {getOptions().map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                            {getOptions().length === 0 && !needsBuilding && (
                                <p className="mt-2 text-sm text-amber-600">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä–∞</p>
                            )}
                            {needsBuilding && filterBuilding && getOptions().length === 0 && (
                                <p className="mt-2 text-sm text-amber-600">‚ö†Ô∏è –í —ç—Ç–æ–º –∑–¥–∞–Ω–∏–∏ –Ω–µ—Ç {filterType === 'floor' ? '—ç—Ç–∞–∂–µ–π' : '–∫–∞–±–∏–Ω–µ—Ç–æ–≤'} —Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º</p>
                            )}
                        </div>

                        <button
                            onClick={() => onPrint(filterType, filterValue, filterBuilding)}
                            disabled={!canPrint}
                            className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${canPrint ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                        >
                            üñ®Ô∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å
                        </button>
                    </div>
                </Modal>
            );
        };

        const SettingsModal = ({ isOpen, onClose, stats }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏" size="sm">
                    <div className="space-y-4">
                        <div className="p-4 bg-amber-50 rounded-xl">
                            <h3 className="font-bold text-amber-800 mb-2">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</h3>
                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between">
                                    <span>–ë–µ–∑ –∑–¥–∞–Ω–∏—è:</span>
                                    <span className="font-bold text-amber-600">{stats.noBuilding}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>–ë–µ–∑ –±–∏—Ä–∫–∏:</span>
                                    <span className="font-bold text-red-600">{stats.noLabel}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:</span>
                                    <span className="font-bold text-amber-600">{stats.pending}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-4 bg-gray-50 rounded-xl">
                            <h3 className="font-bold text-gray-700 mb-2">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            <div className="space-y-1 text-sm text-gray-600">
                                <div className="flex justify-between">
                                    <span>–í–µ—Ä—Å–∏—è:</span>
                                    <span>7.1</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</span>
                                    <span>{stats.total}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>–° —Å–µ—Ä–∏–π–Ω—ã–º–∏ ‚Ññ:</span>
                                    <span>{stats.withSerial}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π / –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—É–ø–æ–∫
        const ProcurementNeedsModal = ({ isOpen, onClose, needs, setNeeds, directories, showToast }) => {
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');
            const [newNeed, setNewNeed] = useState({
                item: '',
                quantity: 1,
                building: '–ù–∞–Ω—Å–µ–Ω–∞',
                floor: '',
                room: '',
                responsible: '',
                priority: 'medium',
                notes: ''
            });

            const handleAddNeed = () => {
                if (!newNeed.item.trim()) {
                    showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                    return;
                }
                const need = {
                    id: 'need_' + Date.now(),
                    ...newNeed,
                    item: newNeed.item.trim(),
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                setNeeds(prev => [need, ...prev]);
                setNewNeed({ item: '', quantity: 1, building: '–ù–∞–Ω—Å–µ–Ω–∞', floor: '', room: '', responsible: '', priority: 'medium', notes: '' });
                setShowAddForm(false);
                showToast('–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            };

            const handleUpdateNeed = (id, updates) => {
                setNeeds(prev => prev.map(n => n.id === id ? { ...n, ...updates, updatedAt: new Date().toISOString() } : n));
            };

            const handleDeleteNeed = (id) => {
                setNeeds(prev => prev.filter(n => n.id !== id));
                showToast('–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
            };

            const handleMarkPurchased = (id) => {
                handleUpdateNeed(id, { status: 'purchased', purchasedAt: new Date().toISOString() });
                showToast('–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ');
            };

            const filteredNeeds = useMemo(() => {
                if (filterStatus === 'all') return needs;
                return needs.filter(n => n.status === filterStatus);
            }, [needs, filterStatus]);

            const stats = useMemo(() => ({
                total: needs.length,
                pending: needs.filter(n => n.status === 'pending').length,
                purchased: needs.filter(n => n.status === 'purchased').length,
                highPriority: needs.filter(n => n.priority === 'high' && n.status === 'pending').length
            }), [needs]);

            const handlePrintNeeds = () => {
                const pendingNeeds = needs.filter(n => n.status === 'pending');
                if (pendingNeeds.length === 0) {
                    showToast('–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π');
                    return;
                }
                const date = new Date().toLocaleDateString('ru-RU');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞–∫—É–ø–∫–∏</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333;font-size:12px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #3182ce}');
                printWindow.document.write('.header h1{font-size:18px;color:#2c5282;margin-bottom:5px}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:11px}');
                printWindow.document.write('th{background:#2c5282;color:white;padding:8px;text-align:left;font-weight:600}');
                printWindow.document.write('td{padding:8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.priority-high{color:#e53e3e;font-weight:bold}');
                printWindow.document.write('.priority-medium{color:#d69e2e}');
                printWindow.document.write('.priority-low{color:#718096}');
                printWindow.document.write('.footer{margin-top:20px;text-align:center;font-size:10px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4 portrait}}');
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="header"><h1>–ü–û–¢–†–ï–ë–ù–û–°–¢–ò –î–õ–Ø –ó–ê–ö–£–ü–ö–ò</h1><p>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Ä¢ ' + date + '</p></div>');
                printWindow.document.write('<table><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–ö–∞–±–∏–Ω–µ—Ç</th><th>–î–ª—è –∫–æ–≥–æ</th><th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead><tbody>');

                pendingNeeds.sort((a, b) => {
                    const priorityOrder = { high: 0, medium: 1, low: 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }).forEach((need, idx) => {
                    const priorityText = need.priority === 'high' ? '–°–†–û–ß–ù–û' : need.priority === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–ù–∏–∑–∫–∏–π';
                    const priorityClass = 'priority-' + need.priority;
                    const location = [need.building, need.floor ? need.floor + ' —ç—Ç.' : '', need.room].filter(Boolean).join(', ');
                    printWindow.document.write('<tr><td>' + (idx + 1) + '</td><td>' + need.item + '</td><td>' + need.quantity + '</td><td>' + (location || '-') + '</td><td>' + (need.responsible || '-') + '</td><td class="' + priorityClass + '">' + priorityText + '</td><td>' + (need.notes || '-') + '</td></tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<div class="footer">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: ' + pendingNeeds.length + ' ‚Ä¢ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();
                showToast('–ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π');
            };

            if (!isOpen) return null;

            const priorityColors = { high: 'bg-red-100 text-red-700 border-red-300', medium: 'bg-yellow-100 text-yellow-700 border-yellow-300', low: 'bg-gray-100 text-gray-600 border-gray-300' };
            const priorityLabels = { high: '–°—Ä–æ—á–Ω–æ', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π' };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ / –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫" size="lg">
                    <div className="space-y-4">
                        {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                        <div className="grid grid-cols-4 gap-2">
                            <div className="text-center p-2 bg-gray-100 rounded-lg">
                                <div className="text-lg font-bold text-gray-700">{stats.total}</div>
                                <div className="text-xs text-gray-500">–í—Å–µ–≥–æ</div>
                            </div>
                            <div className="text-center p-2 bg-amber-100 rounded-lg">
                                <div className="text-lg font-bold text-amber-700">{stats.pending}</div>
                                <div className="text-xs text-amber-600">–û–∂–∏–¥–∞–µ—Ç</div>
                            </div>
                            <div className="text-center p-2 bg-green-100 rounded-lg">
                                <div className="text-lg font-bold text-green-700">{stats.purchased}</div>
                                <div className="text-xs text-green-600">–ó–∞–∫—É–ø–ª–µ–Ω–æ</div>
                            </div>
                            <div className="text-center p-2 bg-red-100 rounded-lg">
                                <div className="text-lg font-bold text-red-700">{stats.highPriority}</div>
                                <div className="text-xs text-red-600">–°—Ä–æ—á–Ω–æ</div>
                            </div>
                        </div>

                        {/* –ö–Ω–æ–ø–∫–∏ */}
                        <div className="flex gap-2 flex-wrap">
                            <button onClick={() => setShowAddForm(true)} className="touch-btn px-4 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å
                            </button>
                            <button onClick={handlePrintNeeds} className="touch-btn px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm">
                                –ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞
                            </button>
                        </div>

                        {/* –§–∏–ª—å—Ç—Ä */}
                        <div className="flex gap-2">
                            <button onClick={() => setFilterStatus('all')} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${filterStatus === 'all' ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-600'}`}>–í—Å–µ</button>
                            <button onClick={() => setFilterStatus('pending')} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${filterStatus === 'pending' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600'}`}>–û–∂–∏–¥–∞–µ—Ç</button>
                            <button onClick={() => setFilterStatus('purchased')} className={`px-3 py-1.5 rounded-lg text-xs font-semibold ${filterStatus === 'purchased' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>–ó–∞–∫—É–ø–ª–µ–Ω–æ</button>
                        </div>

                        {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
                        {showAddForm && (
                            <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 space-y-3">
                                <h4 className="font-bold text-gray-800">–ù–æ–≤–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å</h4>
                                <input
                                    type="text"
                                    value={newNeed.item}
                                    onChange={e => setNewNeed(prev => ({ ...prev, item: e.target.value }))}
                                    placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ù–∞—É—à–Ω–∏–∫–∏, –ö–æ–ª–æ–Ω–∫–∏)"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    autoFocus
                                />
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                        <input type="number" min="1" value={newNeed.quantity} onChange={e => setNewNeed(prev => ({ ...prev, quantity: parseInt(e.target.value) || 1 }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                        <select value={newNeed.priority} onChange={e => setNewNeed(prev => ({ ...prev, priority: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="low">–ù–∏–∑–∫–∏–π</option>
                                            <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                                            <option value="high">–°—Ä–æ—á–Ω–æ</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–ó–¥–∞–Ω–∏–µ</label>
                                        <select value={newNeed.building} onChange={e => setNewNeed(prev => ({ ...prev, building: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="–ù–∞–Ω—Å–µ–Ω–∞">–ù–∞–Ω—Å–µ–Ω–∞</option>
                                            <option value="–ë–æ—Ç–∞–Ω–∏—á–∫–∞">–ë–æ—Ç–∞–Ω–∏—á–∫–∞</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–≠—Ç–∞–∂</label>
                                        <select value={newNeed.floor} onChange={e => setNewNeed(prev => ({ ...prev, floor: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="">‚Äî</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–∞–±–∏–Ω–µ—Ç</label>
                                        <input type="text" list="rooms-list" value={newNeed.room} onChange={e => setNewNeed(prev => ({ ...prev, room: e.target.value }))} placeholder="–ö–∞–±–∏–Ω–µ—Ç" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                        <datalist id="rooms-list">{directories.rooms?.map(r => <option key={r} value={r} />)}</datalist>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">–î–ª—è –∫–æ–≥–æ (–§–ò–û)</label>
                                        <input type="text" list="people-list" value={newNeed.responsible} onChange={e => setNewNeed(prev => ({ ...prev, responsible: e.target.value }))} placeholder="–§–ò–û" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                        <datalist id="people-list">{directories.people?.map(p => <option key={p} value={p} />)}</datalist>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                                    <textarea value={newNeed.notes} onChange={e => setNewNeed(prev => ({ ...prev, notes: e.target.value }))} placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="2" />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleAddNeed} className="touch-btn flex-1 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                                    <button onClick={() => setShowAddForm(false)} className="touch-btn flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        )}

                        {/* –°–ø–∏—Å–æ–∫ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π */}
                        <div className="space-y-2 max-h-80 overflow-y-auto custom-scroll">
                            {filteredNeeds.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <div className="text-4xl mb-2">üìã</div>
                                    <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                                </div>
                            ) : (
                                filteredNeeds.map(need => (
                                    <div key={need.id} className={`p-3 bg-white rounded-lg border-l-4 card-shadow ${need.status === 'purchased' ? 'border-l-green-500 opacity-60' : need.priority === 'high' ? 'border-l-red-500' : need.priority === 'medium' ? 'border-l-yellow-500' : 'border-l-gray-400'}`}>
                                        <div className="flex items-start justify-between gap-2">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 flex-wrap mb-1">
                                                    <span className="font-semibold text-gray-800">{need.item}</span>
                                                    {need.quantity > 1 && <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">x{need.quantity}</span>}
                                                    <span className={`text-xs px-1.5 py-0.5 rounded border ${priorityColors[need.priority]}`}>{priorityLabels[need.priority]}</span>
                                                    {need.status === 'purchased' && <span className="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">–ó–∞–∫—É–ø–ª–µ–Ω–æ</span>}
                                                </div>
                                                <div className="text-xs text-gray-500 space-x-2">
                                                    {need.responsible && <span>üë§ {need.responsible}</span>}
                                                    {(need.building || need.room) && <span>üìç {[need.building, need.floor ? need.floor + ' —ç—Ç.' : '', need.room].filter(Boolean).join(', ')}</span>}
                                                </div>
                                                {need.notes && <p className="text-xs text-gray-400 mt-1 italic">{need.notes}</p>}
                                                <p className="text-xs text-gray-300 mt-1">{new Date(need.createdAt).toLocaleDateString('ru-RU')}</p>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                {need.status === 'pending' && (
                                                    <button onClick={() => handleMarkPurchased(need.id)} className="touch-btn px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–∫—É–ø–ª–µ–Ω–æ">‚úì</button>
                                                )}
                                                {need.status === 'purchased' && (
                                                    <button onClick={() => handleUpdateNeed(need.id, { status: 'pending' })} className="touch-btn px-2 py-1 bg-amber-500 text-white rounded text-xs font-semibold" title="–í–µ—Ä–Ω—É—Ç—å –≤ –æ–∂–∏–¥–∞–Ω–∏–µ">‚Ü©</button>
                                                )}
                                                <button onClick={() => handleDeleteNeed(need.id)} className="touch-btn px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold" title="–£–¥–∞–ª–∏—Ç—å">‚úó</button>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </Modal>
            );
        };

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–ª–∞–¥–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ (–º–µ–ª–æ—á—ë–≤–∫–∞)
        const ConsumablesModal = ({ isOpen, onClose, stock, setStock, history, setHistory, directories, showToast }) => {
            const [activeTab, setActiveTab] = useState('stock');
            const [showAddForm, setShowAddForm] = useState(false);
            const [showIssueForm, setShowIssueForm] = useState(null); // id —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –≤—ã–¥–∞—á–∏
            const [filterCategory, setFilterCategory] = useState('all');
            const [newItem, setNewItem] = useState({
                name: '',
                category: 'flash',
                quantity: 1,
                notes: ''
            });
            const [issueForm, setIssueForm] = useState({
                quantity: 1,
                building: '–ù–∞–Ω—Å–µ–Ω–∞',
                floor: '',
                room: '',
                recipient: '',
                notes: ''
            });

            const categories = [
                { id: 'flash', name: '–§–ª–µ—à–∫–∏', icon: 'üíæ' },
                { id: 'mouse', name: '–ú—ã—à–∫–∏', icon: 'üñ±Ô∏è' },
                { id: 'keyboard', name: '–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã', icon: '‚å®Ô∏è' },
                { id: 'ssd', name: 'SSD', icon: 'üíΩ' },
                { id: 'hdd', name: 'HDD', icon: 'üíø' },
                { id: 'ram', name: '–ü–∞–º—è—Ç—å (RAM)', icon: 'üß©' },
                { id: 'cable', name: '–ö–∞–±–µ–ª–∏', icon: 'üîå' },
                { id: 'headphones', name: '–ù–∞—É—à–Ω–∏–∫–∏', icon: 'üéß' },
                { id: 'other', name: '–ü—Ä–æ—á–µ–µ', icon: 'üì¶' }
            ];

            const getCategoryInfo = (catId) => categories.find(c => c.id === catId) || { name: catId, icon: 'üì¶' };

            const handleAddItem = () => {
                if (!newItem.name.trim()) {
                    showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                    return;
                }
                const item = {
                    id: 'cons_' + Date.now(),
                    ...newItem,
                    name: newItem.name.trim(),
                    quantity: parseInt(newItem.quantity) || 1,
                    createdAt: new Date().toISOString()
                };
                setStock(prev => [item, ...prev]);
                setNewItem({ name: '', category: 'flash', quantity: 1, notes: '' });
                setShowAddForm(false);
                showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥');
            };

            const handleUpdateQuantity = (id, delta) => {
                setStock(prev => prev.map(item => {
                    if (item.id === id) {
                        const newQty = Math.max(0, (item.quantity || 0) + delta);
                        return { ...item, quantity: newQty };
                    }
                    return item;
                }));
            };

            const handleDeleteItem = (id) => {
                setStock(prev => prev.filter(item => item.id !== id));
                showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω —Å–æ —Å–∫–ª–∞–¥–∞');
            };

            const handleIssue = (itemId) => {
                const item = stock.find(i => i.id === itemId);
                if (!item) return;

                if (!issueForm.recipient.trim()) {
                    showToast('–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                    return;
                }

                const issueQty = parseInt(issueForm.quantity) || 1;
                if (issueQty > item.quantity) {
                    showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ');
                    return;
                }

                // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
                setStock(prev => prev.map(i => {
                    if (i.id === itemId) {
                        return { ...i, quantity: i.quantity - issueQty };
                    }
                    return i;
                }));

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –≤—ã–¥–∞—á
                const historyEntry = {
                    id: 'issue_' + Date.now(),
                    itemId,
                    itemName: item.name,
                    category: item.category,
                    quantity: issueQty,
                    ...issueForm,
                    recipient: issueForm.recipient.trim(),
                    issuedAt: new Date().toISOString()
                };
                setHistory(prev => [historyEntry, ...prev]);

                setShowIssueForm(null);
                setIssueForm({ quantity: 1, building: '–ù–∞–Ω—Å–µ–Ω–∞', floor: '', room: '', recipient: '', notes: '' });
                showToast(`–í—ã–¥–∞–Ω–æ: ${item.name} x${issueQty}`);
            };

            const filteredStock = useMemo(() => {
                if (filterCategory === 'all') return stock;
                return stock.filter(item => item.category === filterCategory);
            }, [stock, filterCategory]);

            const stats = useMemo(() => ({
                totalItems: stock.length,
                totalQuantity: stock.reduce((sum, item) => sum + (item.quantity || 0), 0),
                lowStock: stock.filter(item => item.quantity > 0 && item.quantity <= 2).length,
                outOfStock: stock.filter(item => item.quantity === 0).length,
                issuedToday: history.filter(h => {
                    const issued = new Date(h.issuedAt);
                    const today = new Date();
                    return issued.toDateString() === today.toDateString();
                }).length
            }), [stock, history]);

            const handlePrintStock = () => {
                const itemsInStock = stock.filter(item => item.quantity > 0);
                if (itemsInStock.length === 0) {
                    showToast('–°–∫–ª–∞–¥ –ø—É—Å—Ç');
                    return;
                }
                const date = new Date().toLocaleDateString('ru-RU');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–°–∫–ª–∞–¥ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333;font-size:12px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #805ad5}');
                printWindow.document.write('.header h1{font-size:18px;color:#553c9a;margin-bottom:5px}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:11px}');
                printWindow.document.write('th{background:#553c9a;color:white;padding:8px;text-align:left;font-weight:600}');
                printWindow.document.write('td{padding:8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.low-stock{background:#fff5f5;color:#c53030}');
                printWindow.document.write('.footer{margin-top:20px;text-align:center;font-size:10px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4 portrait}}');
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="header"><h1>–°–ö–õ–ê–î –†–ê–°–•–û–î–ù–ò–ö–û–í</h1><p>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Ä¢ ' + date + '</p></div>');
                printWindow.document.write('<table><thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–æ–ª-–≤–æ</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead><tbody>');

                itemsInStock.forEach((item, idx) => {
                    const cat = getCategoryInfo(item.category);
                    const lowClass = item.quantity <= 2 ? ' class="low-stock"' : '';
                    printWindow.document.write('<tr' + lowClass + '><td>' + (idx + 1) + '</td><td>' + item.name + '</td><td>' + cat.icon + ' ' + cat.name + '</td><td>' + item.quantity + '</td><td>' + (item.notes || '-') + '</td></tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<div class="footer">–í—Å–µ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π: ' + itemsInStock.length + ' ‚Ä¢ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + stats.totalQuantity + ' ‚Ä¢ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();
                showToast('–ü–µ—á–∞—Ç—å —Å–∫–ª–∞–¥–∞');
            };

            const handlePrintHistory = () => {
                if (history.length === 0) {
                    showToast('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞');
                    return;
                }
                const date = new Date().toLocaleDateString('ru-RU');
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞—á</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333;font-size:12px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #2f855a}');
                printWindow.document.write('.header h1{font-size:18px;color:#276749;margin-bottom:5px}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:11px}');
                printWindow.document.write('th{background:#276749;color:white;padding:8px;text-align:left;font-weight:600}');
                printWindow.document.write('td{padding:8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.footer{margin-top:20px;text-align:center;font-size:10px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4 landscape}}');
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="header"><h1>–ò–°–¢–û–†–ò–Ø –í–´–î–ê–ß –†–ê–°–•–û–î–ù–ò–ö–û–í</h1><p>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 ‚Ä¢ ' + date + '</p></div>');
                printWindow.document.write('<table><thead><tr><th>‚Ññ</th><th>–î–∞—Ç–∞</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–ö–∞–±–∏–Ω–µ—Ç</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead><tbody>');

                history.forEach((entry, idx) => {
                    const issuedDate = new Date(entry.issuedAt).toLocaleDateString('ru-RU');
                    const location = [entry.building, entry.floor ? entry.floor + ' —ç—Ç.' : '', entry.room].filter(Boolean).join(', ');
                    printWindow.document.write('<tr><td>' + (idx + 1) + '</td><td>' + issuedDate + '</td><td>' + entry.itemName + '</td><td>' + entry.quantity + '</td><td>' + entry.recipient + '</td><td>' + (location || '-') + '</td><td>' + (entry.notes || '-') + '</td></tr>');
                });

                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<div class="footer">–í—Å–µ–≥–æ –≤—ã–¥–∞—á: ' + history.length + ' ‚Ä¢ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();
                showToast('–ü–µ—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–¥–∞—á');
            };

            if (!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="–°–∫–ª–∞–¥ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤" size="lg">
                    <div className="space-y-4">
                        {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                        <div className="grid grid-cols-5 gap-2">
                            <div className="text-center p-2 bg-purple-100 rounded-lg">
                                <div className="text-lg font-bold text-purple-700">{stats.totalItems}</div>
                                <div className="text-xs text-purple-600">–ü–æ–∑–∏—Ü–∏–π</div>
                            </div>
                            <div className="text-center p-2 bg-blue-100 rounded-lg">
                                <div className="text-lg font-bold text-blue-700">{stats.totalQuantity}</div>
                                <div className="text-xs text-blue-600">–í—Å–µ–≥–æ —à—Ç.</div>
                            </div>
                            <div className="text-center p-2 bg-amber-100 rounded-lg">
                                <div className="text-lg font-bold text-amber-700">{stats.lowStock}</div>
                                <div className="text-xs text-amber-600">–ú–∞–ª–æ</div>
                            </div>
                            <div className="text-center p-2 bg-red-100 rounded-lg">
                                <div className="text-lg font-bold text-red-700">{stats.outOfStock}</div>
                                <div className="text-xs text-red-600">–ù–µ—Ç</div>
                            </div>
                            <div className="text-center p-2 bg-green-100 rounded-lg">
                                <div className="text-lg font-bold text-green-700">{stats.issuedToday}</div>
                                <div className="text-xs text-green-600">–í—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
                            </div>
                        </div>

                        {/* –í–∫–ª–∞–¥–∫–∏ */}
                        <div className="flex gap-2 border-b border-gray-200 pb-2">
                            <button onClick={() => setActiveTab('stock')} className={`px-4 py-2 rounded-t-lg text-sm font-semibold ${activeTab === 'stock' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                üì¶ –°–∫–ª–∞–¥
                            </button>
                            <button onClick={() => setActiveTab('history')} className={`px-4 py-2 rounded-t-lg text-sm font-semibold ${activeTab === 'history' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                üìã –ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞—á ({history.length})
                            </button>
                        </div>

                        {activeTab === 'stock' && (
                            <>
                                {/* –ö–Ω–æ–ø–∫–∏ */}
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={() => setShowAddForm(true)} className="touch-btn px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold text-sm">
                                        + –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥
                                    </button>
                                    <button onClick={handlePrintStock} className="touch-btn px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm">
                                        üñ®Ô∏è –ü–µ—á–∞—Ç—å
                                    </button>
                                </div>

                                {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º */}
                                <div className="flex gap-1 flex-wrap">
                                    <button onClick={() => setFilterCategory('all')} className={`px-2 py-1 rounded text-xs font-semibold ${filterCategory === 'all' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'}`}>–í—Å–µ</button>
                                    {categories.map(cat => (
                                        <button key={cat.id} onClick={() => setFilterCategory(cat.id)} className={`px-2 py-1 rounded text-xs font-semibold ${filterCategory === cat.id ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            {cat.icon}
                                        </button>
                                    ))}
                                </div>

                                {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
                                {showAddForm && (
                                    <div className="p-4 bg-purple-50 rounded-xl border border-purple-200 space-y-3">
                                        <h4 className="font-bold text-gray-800">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</h4>
                                        <input
                                            type="text"
                                            value={newItem.name}
                                            onChange={e => setNewItem(prev => ({ ...prev, name: e.target.value }))}
                                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: USB Flash 32GB)"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                            autoFocus
                                        />
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                                <select value={newItem.category} onChange={e => setNewItem(prev => ({ ...prev, category: e.target.value }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                    {categories.map(cat => (
                                                        <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                                <input type="number" min="1" value={newItem.quantity} onChange={e => setNewItem(prev => ({ ...prev, quantity: parseInt(e.target.value) || 1 }))} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-500 mb-1">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                                            <input type="text" value={newItem.notes} onChange={e => setNewItem(prev => ({ ...prev, notes: e.target.value }))} placeholder="–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={handleAddItem} className="touch-btn flex-1 py-2 bg-purple-600 text-white rounded-lg font-semibold text-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                                            <button onClick={() => setShowAddForm(false)} className="touch-btn flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm">–û—Ç–º–µ–Ω–∞</button>
                                        </div>
                                    </div>
                                )}

                                {/* –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ */}
                                <div className="space-y-2 max-h-72 overflow-y-auto custom-scroll">
                                    {filteredStock.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            <div className="text-4xl mb-2">üì¶</div>
                                            <p>–°–∫–ª–∞–¥ –ø—É—Å—Ç</p>
                                        </div>
                                    ) : (
                                        filteredStock.map(item => {
                                            const cat = getCategoryInfo(item.category);
                                            const isLow = item.quantity > 0 && item.quantity <= 2;
                                            const isEmpty = item.quantity === 0;
                                            return (
                                                <div key={item.id} className={`p-3 bg-white rounded-lg border-l-4 card-shadow ${isEmpty ? 'border-l-red-500 opacity-60' : isLow ? 'border-l-amber-500' : 'border-l-purple-500'}`}>
                                                    {showIssueForm === item.id ? (
                                                        <div className="space-y-2">
                                                            <div className="font-semibold text-gray-800 text-sm">{cat.icon} {item.name}</div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–æ–ª-–≤–æ (–º–∞–∫—Å: {item.quantity})</label>
                                                                    <input type="number" min="1" max={item.quantity} value={issueForm.quantity} onChange={e => setIssueForm(prev => ({ ...prev, quantity: Math.min(parseInt(e.target.value) || 1, item.quantity) }))} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" />
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–ü–æ–ª—É—á–∞—Ç–µ–ª—å*</label>
                                                                    <input type="text" list="cons-people-list" value={issueForm.recipient} onChange={e => setIssueForm(prev => ({ ...prev, recipient: e.target.value }))} placeholder="–§–ò–û" className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" />
                                                                    <datalist id="cons-people-list">{directories.people?.map(p => <option key={p} value={p} />)}</datalist>
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                <select value={issueForm.building} onChange={e => setIssueForm(prev => ({ ...prev, building: e.target.value }))} className="px-2 py-1.5 border border-gray-300 rounded text-xs">
                                                                    <option value="–ù–∞–Ω—Å–µ–Ω–∞">–ù–∞–Ω—Å–µ–Ω–∞</option>
                                                                    <option value="–ë–æ—Ç–∞–Ω–∏—á–∫–∞">–ë–æ—Ç–∞–Ω–∏—á–∫–∞</option>
                                                                </select>
                                                                <select value={issueForm.floor} onChange={e => setIssueForm(prev => ({ ...prev, floor: e.target.value }))} className="px-2 py-1.5 border border-gray-300 rounded text-xs">
                                                                    <option value="">–≠—Ç–∞–∂</option>
                                                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                                                                </select>
                                                                <input type="text" list="cons-rooms-list" value={issueForm.room} onChange={e => setIssueForm(prev => ({ ...prev, room: e.target.value }))} placeholder="–ö–∞–±." className="px-2 py-1.5 border border-gray-300 rounded text-xs" />
                                                                <datalist id="cons-rooms-list">{directories.rooms?.map(r => <option key={r} value={r} />)}</datalist>
                                                            </div>
                                                            <input type="text" value={issueForm.notes} onChange={e => setIssueForm(prev => ({ ...prev, notes: e.target.value }))} placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" />
                                                            <div className="flex gap-2">
                                                                <button onClick={() => handleIssue(item.id)} className="touch-btn flex-1 py-1.5 bg-green-600 text-white rounded text-xs font-semibold">–í—ã–¥–∞—Ç—å</button>
                                                                <button onClick={() => setShowIssueForm(null)} className="touch-btn flex-1 py-1.5 bg-gray-200 text-gray-700 rounded text-xs font-semibold">–û—Ç–º–µ–Ω–∞</button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center justify-between gap-2">
                                                            <div className="flex-1">
                                                                <div className="flex items-center gap-2 flex-wrap mb-1">
                                                                    <span className="text-lg">{cat.icon}</span>
                                                                    <span className="font-semibold text-gray-800">{item.name}</span>
                                                                    <span className={`text-xs px-1.5 py-0.5 rounded font-mono ${isEmpty ? 'bg-red-100 text-red-700' : isLow ? 'bg-amber-100 text-amber-700' : 'bg-purple-100 text-purple-700'}`}>
                                                                        {item.quantity} —à—Ç
                                                                    </span>
                                                                </div>
                                                                <div className="text-xs text-gray-400">{cat.name}{item.notes ? ' ‚Ä¢ ' + item.notes : ''}</div>
                                                            </div>
                                                            <div className="flex items-center gap-1">
                                                                <button onClick={() => handleUpdateQuantity(item.id, -1)} disabled={item.quantity <= 0} className="touch-btn w-7 h-7 bg-gray-200 rounded text-sm font-bold disabled:opacity-40">‚àí</button>
                                                                <button onClick={() => handleUpdateQuantity(item.id, 1)} className="touch-btn w-7 h-7 bg-gray-200 rounded text-sm font-bold">+</button>
                                                                {item.quantity > 0 && (
                                                                    <button onClick={() => setShowIssueForm(item.id)} className="touch-btn px-2 py-1 bg-green-500 text-white rounded text-xs font-semibold ml-1" title="–í—ã–¥–∞—Ç—å">üì§</button>
                                                                )}
                                                                <button onClick={() => handleDeleteItem(item.id)} className="touch-btn w-7 h-7 bg-red-500 text-white rounded text-xs font-semibold ml-1" title="–£–¥–∞–ª–∏—Ç—å">‚úó</button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'history' && (
                            <>
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={handlePrintHistory} className="touch-btn px-4 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm">
                                        üñ®Ô∏è –ü–µ—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏–∏
                                    </button>
                                </div>

                                <div className="space-y-2 max-h-80 overflow-y-auto custom-scroll">
                                    {history.length === 0 ? (
                                        <div className="text-center py-8 text-gray-400">
                                            <div className="text-4xl mb-2">üìã</div>
                                            <p>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞—á –ø—É—Å—Ç–∞</p>
                                        </div>
                                    ) : (
                                        history.map(entry => {
                                            const cat = getCategoryInfo(entry.category);
                                            const issuedDate = new Date(entry.issuedAt);
                                            const location = [entry.building, entry.floor ? entry.floor + ' —ç—Ç.' : '', entry.room].filter(Boolean).join(', ');
                                            return (
                                                <div key={entry.id} className="p-3 bg-white rounded-lg border-l-4 border-l-green-500 card-shadow">
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                                                <span>{cat.icon}</span>
                                                                <span className="font-semibold text-gray-800">{entry.itemName}</span>
                                                                <span className="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">x{entry.quantity}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-500 space-x-2">
                                                                <span>üë§ {entry.recipient}</span>
                                                                {location && <span>üìç {location}</span>}
                                                            </div>
                                                            {entry.notes && <p className="text-xs text-gray-400 mt-1 italic">{entry.notes}</p>}
                                                            <p className="text-xs text-gray-300 mt-1">{issuedDate.toLocaleDateString('ru-RU')} {issuedDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </Modal>
            );
        };

        const App = () => {
            const contentRef = useRef(null);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
            const hasLocalData = Boolean(localStorage.getItem('inv_102_data_v12'));

            const [equipment, setEquipment] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_data_v12');
                    if (saved) return JSON.parse(saved);
                } catch (e) { console.error(e); }
                return [];
            });

            const [directories, setDirectories] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_dirs_v12');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        return { rooms: parsed.rooms || [], people: parsed.people || [], roomsWithBuilding: parsed.roomsWithBuilding || [] };
                    }
                } catch (e) { console.error(e); }
                return { rooms: [], people: [], roomsWithBuilding: [] };
            });

            const [history, setHistory] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_history');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            // ===== –°–û–°–¢–û–Ø–ù–ò–Ø –ú–û–î–£–õ–Ø –ö–ê–†–¢–†–ò–î–ñ–ï–ô =====
            const [cartridgeModels, setCartridgeModels] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_cartridge_models');
                    if (saved) return JSON.parse(saved);
                } catch (e) { console.error(e); }
                return [];
            });

            const [cartridgeStock, setCartridgeStock] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_cartridge_stock');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            const [cartridgeHistory, setCartridgeHistory] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_cartridge_history');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            // –†—É—á–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π –∫ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º: { printerId: [cartridgeModelIds] }
            const [manualCartridgeMapping, setManualCartridgeMapping] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_manual_cartridge_mapping');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });

            const [cartridgesModal, setCartridgesModal] = useState({ open: false, tab: 'stock' });
            const [cartridgeReplaceModal, setCartridgeReplaceModal] = useState({ open: false, printer: null });

            // –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ / –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫
            const [procurementNeeds, setProcurementNeeds] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_procurement_needs');
                    if (saved) return JSON.parse(saved);
                } catch (e) {}
                return [];
            });
            const [procurementModal, setProcurementModal] = useState({ open: false });

            // –°–∫–ª–∞–¥ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ (–º–µ–ª–æ—á—ë–≤–∫–∞: —Ñ–ª–µ—à–∫–∏, –º—ã—à–∫–∏, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, SSD, HDD, RAM)
            const [consumablesStock, setConsumablesStock] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_consumables_stock');
                    if (saved) return JSON.parse(saved);
                } catch (e) {}
                return [];
            });
            const [consumablesHistory, setConsumablesHistory] = useState(() => {
                try {
                    const saved = localStorage.getItem('inv_102_consumables_history');
                    if (saved) return JSON.parse(saved);
                } catch (e) {}
                return [];
            });
            const [consumablesModal, setConsumablesModal] = useState({ open: false });

            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [activeCategory, setActiveCategory] = useState('–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
            const [activeFilter, setActiveFilter] = useState('all');
            const [activeBuilding, setActiveBuilding] = useState('–í—Å–µ –∑–¥–∞–Ω–∏—è');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [selectionMode, setSelectionMode] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [toast, setToast] = useState({ visible: false, message: '' });
            const [confirmModal, setConfirmModal] = useState({ open: false, title: '', message: '', onConfirm: null });
            const [detailsModal, setDetailsModal] = useState({ open: false, item: null });
            const [editModal, setEditModal] = useState({ open: false, item: null, isNew: false });
            const [checkWizardModal, setCheckWizardModal] = useState({ open: false, item: null });
            const [quickSearchModal, setQuickSearchModal] = useState({ open: false, query: '' });
            const [roomsModal, setRoomsModal] = useState({ open: false, newRoom: '', newRoomBuilding: '–ù–∞–Ω—Å–µ–Ω–∞' });
            const [peopleModal, setPeopleModal] = useState({ open: false, newPerson: '' });
            const [infoModal, setInfoModal] = useState({ open: false });
            const [statsModal, setStatsModal] = useState({ open: false });
            const [historyModal, setHistoryModal] = useState({ open: false });
            const [notesModal, setNotesModal] = useState({ open: false });
            const [exportModal, setExportModal] = useState({ open: false });
            const [settingsModal, setSettingsModal] = useState({ open: false });
            const [analyticsModal, setAnalyticsModal] = useState({ open: false });
            // –ù–û–í–û–ï: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫–∞–±–∏–Ω–µ—Ç–∞
            const [roomDevicesModal, setRoomDevicesModal] = useState({ open: false, building: '', floor: '', room: '' });
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç—á—ë—Ç–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É (–§–ò–û/–∫–∞–±–∏–Ω–µ—Ç/—ç—Ç–∞–∂)
            const [reportFilterModal, setReportFilterModal] = useState({ open: false, filterType: 'responsible', filterValue: '', filterBuilding: '' });

            const [detailsForm, setDetailsForm] = useState({ serialNumber: '', location: '', responsible: '', inventoryNote: '', hasLabel: null, building: '', floor: '' });
            const [editForm, setEditForm] = useState({ name: '', invNumber: '', date: '', category: '', newCategory: '', note: '', building: '', floor: '' });

            useEffect(() => { localStorage.setItem('inv_102_data_v12', JSON.stringify(equipment)); }, [equipment]);
            useEffect(() => { localStorage.setItem('inv_102_dirs_v12', JSON.stringify(directories)); }, [directories]);
            useEffect(() => { localStorage.setItem('inv_102_history', JSON.stringify(history.slice(0, 50))); }, [history]);
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π
            useEffect(() => { localStorage.setItem('inv_102_cartridge_models', JSON.stringify(cartridgeModels)); }, [cartridgeModels]);
            useEffect(() => { localStorage.setItem('inv_102_cartridge_stock', JSON.stringify(cartridgeStock)); }, [cartridgeStock]);
            useEffect(() => { localStorage.setItem('inv_102_cartridge_history', JSON.stringify(cartridgeHistory)); }, [cartridgeHistory]);
            useEffect(() => { localStorage.setItem('inv_102_manual_cartridge_mapping', JSON.stringify(manualCartridgeMapping)); }, [manualCartridgeMapping]);
            useEffect(() => { localStorage.setItem('inv_102_procurement_needs', JSON.stringify(procurementNeeds)); }, [procurementNeeds]);
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
            useEffect(() => { localStorage.setItem('inv_102_consumables_stock', JSON.stringify(consumablesStock)); }, [consumablesStock]);
            useEffect(() => { localStorage.setItem('inv_102_consumables_history', JSON.stringify(consumablesHistory)); }, [consumablesHistory]);

            const addToHistory = useCallback((action, item, actionText) => {
                setHistory(prev => [{
                    action, invNumber: item.invNumber, actionText,
                    time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                    item
                }, ...prev].slice(0, 50));
            }, []);

            const stats = useMemo(() => ({
                total: equipment.filter(i => !i.deleted).length,
                checked: equipment.filter(i => (i.checked || i.writeOff) && !i.deleted).length,
                pending: equipment.filter(i => !i.checked && !i.writeOff && !i.deleted).length,
                writeOff: equipment.filter(i => i.writeOff && !i.deleted).length,
                noLabel: equipment.filter(i => i.hasLabel === false && !i.deleted).length,
                deleted: equipment.filter(i => i.deleted).length,
                withSerial: equipment.filter(i => i.serialNumber?.trim() && !i.deleted).length,
                withNotes: equipment.filter(i => i.inventoryNote?.trim() && !i.deleted).length,
                new: equipment.filter(i => i.isUserAdded && !i.deleted).length,
                noBuilding: equipment.filter(i => !i.building && !i.deleted).length,
                byCategory: equipment.filter(i => !i.deleted).reduce((acc, i) => { acc[i.category] = (acc[i.category] || 0) + 1; return acc; }, {}),
                pendingByCategory: equipment.filter(i => !i.checked && !i.writeOff && !i.deleted).reduce((acc, i) => { acc[i.category] = (acc[i.category] || 0) + 1; return acc; }, {}),
                byBuilding: equipment.filter(i => !i.deleted).reduce((acc, i) => { const b = i.building || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'; acc[b] = (acc[b] || 0) + 1; return acc; }, {}),
            }), [equipment]);

            const recentItems = useMemo(() => 
                equipment.filter(i => i.checkedAt).sort((a, b) => new Date(b.checkedAt) - new Date(a.checkedAt)).slice(0, 5),
            [equipment]);

            const problemItems = useMemo(() =>
                equipment.filter(i => i.hasLabel === false || (i.checked && !i.building)),
            [equipment]);

            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫ (–¥–ª—è –±–µ–π–¥–∂–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
            const notesCount = useMemo(() =>
                equipment.filter(i => (i.note && i.note.trim() && i.note !== '–æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∞') || (i.inventoryNote && i.inventoryNote.trim())).length,
            [equipment]);

            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π (–¥–ª—è –±–µ–π–¥–∂–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
            const criticalCartridgesCount = useMemo(() => {
                const stockByModel = {};
                cartridgeStock.forEach(s => {
                    if (!stockByModel[s.modelId]) stockByModel[s.modelId] = { quantity: 0, minQuantity: s.minQuantity || 2 };
                    stockByModel[s.modelId].quantity += s.quantity;
                });
                return cartridgeModels.filter(m => {
                    const stock = stockByModel[m.id];
                    return !stock || stock.quantity <= (stock.minQuantity || 2);
                }).length;
            }, [cartridgeModels, cartridgeStock]);

            const categories = useMemo(() => {
                const others = [...new Set(equipment.map(i => i.category).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru'));
                return ['–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', ...others];
            }, [equipment]);

            const filteredRooms = useMemo(() => {
                const rooms = directories.rooms || [];
                const roomsWithBuilding = directories.roomsWithBuilding || [];
                if (!detailsForm.building) return rooms;
                const roomsForBuilding = roomsWithBuilding.filter(r => r && r.building === detailsForm.building).map(r => r.name);
                return roomsForBuilding.length > 0 ? roomsForBuilding : rooms;
            }, [directories.rooms, directories.roomsWithBuilding, detailsForm.building]);

            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤
            const uniqueResponsibles = useMemo(() =>
                [...new Set(equipment.map(i => i.responsible).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru')),
            [equipment]);

            const uniqueLocations = useMemo(() =>
                [...new Set(equipment.map(i => i.location).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru')),
            [equipment]);

            const uniqueFloors = useMemo(() =>
                [...new Set(equipment.map(i => i.floor).filter(Boolean))].sort((a, b) => String(a).localeCompare(String(b))),
            [equipment]);

            const uniqueBuildings = useMemo(() =>
                [...new Set(equipment.map(i => i.building).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru')),
            [equipment]);

            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ–¥–∞ –≤–≤–æ–¥–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é
            const uniqueYears = useMemo(() => {
                const years = equipment.map(i => {
                    if (!i.date) return null;
                    const parts = i.date.split('.');
                    return parts.length === 3 ? parts[2] : null;
                }).filter(Boolean);
                return [...new Set(years)].sort((a, b) => b.localeCompare(a)); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
            }, [equipment]);

            // –≠—Ç–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–¥–∞–Ω–∏—è
            const getFloorsByBuilding = useCallback((building) => {
                if (!building) return [];
                return [...new Set(equipment.filter(i => i.building === building).map(i => i.floor).filter(Boolean))].sort((a, b) => String(a).localeCompare(String(b)));
            }, [equipment]);

            // –ö–∞–±–∏–Ω–µ—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–¥–∞–Ω–∏—è
            const getLocationsByBuilding = useCallback((building) => {
                if (!building) return [];
                return [...new Set(equipment.filter(i => i.building === building).map(i => i.location).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ru'));
            }, [equipment]);

            const filteredEquipment = useMemo(() => equipment.filter(item => {
                // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∏–Ω–≤.–Ω–æ–º–µ—Ä—É, —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase().trim();
                    const matchName = item.name?.toLowerCase().includes(q);
                    const matchInv = item.invNumber?.toLowerCase().includes(q);
                    const matchSerial = item.serialNumber?.toLowerCase().includes(q);
                    if (!matchName && !matchInv && !matchSerial) return false;
                }

                if (activeBuilding === '–ù–µ —É–∫–∞–∑–∞–Ω–æ' && item.building) return false;
                if (activeBuilding !== '–í—Å–µ –∑–¥–∞–Ω–∏—è' && activeBuilding !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' && item.building !== activeBuilding) return false;
                if (activeCategory !== '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' && item.category !== activeCategory) return false;

                switch (activeFilter) {
                    case 'checked': if (!item.checked && !item.writeOff) return false; break;
                    case 'unchecked': if (item.checked || item.writeOff) return false; break;
                    case 'pending': if (item.checked || item.writeOff || item.deleted) return false; break;
                    case 'writeoff': if (!item.writeOff || item.deleted) return false; break;
                    case 'nolabel': if (item.hasLabel !== false || item.deleted) return false; break;
                    case 'serial': if (!item.serialNumber?.trim() || item.deleted) return false; break;
                    case 'notes': if (!item.inventoryNote?.trim() || item.deleted) return false; break;
                    case 'new': if (!item.isUserAdded || item.deleted) return false; break;
                    case 'deleted': if (!item.deleted) return false; break;
                    default: if (item.deleted) return false; break;
                }
                return true;
            }), [equipment, activeCategory, activeFilter, activeBuilding, searchQuery]);

            const groupedEquipment = useMemo(() => filteredEquipment.reduce((acc, item) => {
                const cat = item.category || '–ü—Ä–æ—á–µ–µ';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {}), [filteredEquipment]);

            const buildingOptions = useMemo(() => [
                { value: '–í—Å–µ –∑–¥–∞–Ω–∏—è', label: '–í—Å–µ –∑–¥–∞–Ω–∏—è', icon: 'üèõÔ∏è', count: stats.total },
                { value: '–ù–∞–Ω—Å–µ–Ω–∞', label: '–ù–∞–Ω—Å–µ–Ω–∞', icon: 'üè´', count: stats.byBuilding['–ù–∞–Ω—Å–µ–Ω–∞'] || 0 },
                { value: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞', label: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞', icon: 'üè¢', count: stats.byBuilding['–ë–æ—Ç–∞–Ω–∏—á–∫–∞'] || 0 },
                { value: '–ù–µ —É–∫–∞–∑–∞–Ω–æ', label: '–ù–µ —É–∫–∞–∑–∞–Ω–æ', icon: '‚ùì', count: stats.noBuilding },
            ], [stats]);

            const categoryOptions = useMemo(() => [
                { value: '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', label: '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', icon: 'üìã', count: stats.total, pending: stats.pending },
                ...categories.filter(c => c !== '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ').map(cat => ({
                    value: cat, label: cat, icon: categoryConfig[cat]?.icon || 'üì¶', count: stats.byCategory[cat] || 0, pending: stats.pendingByCategory[cat] || 0
                }))
            ], [categories, stats]);

            const showToast = useCallback((msg) => setToast({ visible: true, message: msg }), []);
            const showConfirm = useCallback((title, message, onConfirm) => setConfirmModal({ open: true, title, message, onConfirm }), []);

            const goHome = useCallback(() => {
                setActiveCategory('–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ');
                setActiveFilter('all');
                setActiveBuilding('–í—Å–µ –∑–¥–∞–Ω–∏—è');
                setSidebarOpen(false);
                contentRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
            }, []);

            const handleCheckComplete = useCallback((formData) => {
                const item = checkWizardModal.item;
                setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, ...formData, checked: true, writeOff: false, checkedAt: new Date().toISOString() } : i));
                
                if (formData.location && formData.building) {
                    const roomsWithBuilding = directories.roomsWithBuilding || [];
                    const exists = roomsWithBuilding.find(r => r && r.name === formData.location && r.building === formData.building);
                    if (!exists) {
                        setDirectories(prev => ({
                            ...prev,
                            roomsWithBuilding: [...(prev.roomsWithBuilding || []), { name: formData.location, building: formData.building }],
                            rooms: [...new Set([...(prev.rooms || []), formData.location])].sort((a, b) => a.localeCompare(b, 'ru'))
                        }));
                    }
                }
                
                if (formData.responsible) {
                    const people = directories.people || [];
                    if (!people.includes(formData.responsible)) {
                        setDirectories(prev => ({ ...prev, people: [...(prev.people || []), formData.responsible].sort((a, b) => a.localeCompare(b, 'ru')) }));
                    }
                }
                
                addToHistory('check', item, '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ');
                setCheckWizardModal({ open: false, item: null });
                showToast('‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ');
            }, [checkWizardModal.item, directories, showToast, addToHistory]);

            const handleCheck = useCallback((item, undo = false) => {
                if (undo) {
                    showConfirm('–û—Ç–º–µ–Ω–∏—Ç—å?', '–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏?', () => {
                        setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, checked: false, writeOff: false, checkedAt: null } : i));
                        addToHistory('undo', item, '–û—Ç–º–µ–Ω–µ–Ω–æ');
                        setConfirmModal(prev => ({ ...prev, open: false }));
                        showToast('‚Ü© –û—Ç–º–µ–Ω–µ–Ω–æ');
                    });
                } else {
                    setCheckWizardModal({ open: true, item });
                }
            }, [showConfirm, showToast, addToHistory]);

            const handleWriteOff = useCallback((item) => {
                showConfirm('–°–ø–∏—Å–∞—Ç—å?', item.name, () => {
                    setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, writeOff: true, checked: false, checkedAt: new Date().toISOString(), hasLabel: i.hasLabel === null ? true : i.hasLabel } : i));
                    addToHistory('writeoff', item, '–°–ø–∏—Å–∞–Ω–æ');
                    setConfirmModal(prev => ({ ...prev, open: false }));
                    setDetailsModal({ open: false, item: null });
                    showToast('üìù –°–ø–∏—Å–∞–Ω–æ');
                });
            }, [showConfirm, showToast, addToHistory]);

            const handleDelete = useCallback((item) => {
                showConfirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?', `${item.name} –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–£–¥–∞–ª–µ–Ω–Ω—ã–µ"`, () => {
                    setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, deleted: true, deletedAt: new Date().toISOString() } : i));
                    addToHistory('delete', item, '–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–µ');
                    setConfirmModal(prev => ({ ...prev, open: false }));
                    setDetailsModal({ open: false, item: null });
                    showToast('üóëÔ∏è –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–µ');
                });
            }, [showConfirm, showToast, addToHistory]);

            // === –ú–ê–°–°–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò ===
            const toggleSelectItem = useCallback((itemId) => {
                setSelectedItems(prev => {
                    const next = new Set(prev);
                    if (next.has(itemId)) {
                        next.delete(itemId);
                    } else {
                        next.add(itemId);
                    }
                    return next;
                });
            }, []);

            const selectAllVisible = useCallback(() => {
                const ids = filteredEquipment.map(i => i.id);
                setSelectedItems(new Set(ids));
            }, [filteredEquipment]);

            const clearSelection = useCallback(() => {
                setSelectedItems(new Set());
                setSelectionMode(false);
            }, []);

            const bulkCheck = useCallback(() => {
                if (selectedItems.size === 0) return;
                showConfirm(
                    `–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`,
                    '–í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ',
                    () => {
                        setIsLoading(true);
                        setTimeout(() => {
                            setEquipment(prev => prev.map(item => {
                                if (selectedItems.has(item.id) && !item.checked && !item.writeOff) {
                                    return { ...item, checked: true, checkedAt: new Date().toISOString() };
                                }
                                return item;
                            }));
                            setIsLoading(false);
                            clearSelection();
                            setConfirmModal(prev => ({ ...prev, open: false }));
                            showToast(`‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                        }, 100);
                    }
                );
            }, [selectedItems, showConfirm, clearSelection, showToast]);

            const bulkWriteOff = useCallback(() => {
                if (selectedItems.size === 0) return;
                showConfirm(
                    `–°–ø–∏—Å–∞—Ç—å ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`,
                    '‚ö†Ô∏è –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —Å–ø–∏—Å–∞–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å.',
                    () => {
                        setIsLoading(true);
                        setTimeout(() => {
                            setEquipment(prev => prev.map(item => {
                                if (selectedItems.has(item.id)) {
                                    return { ...item, writeOff: true, checked: false, checkedAt: new Date().toISOString() };
                                }
                                return item;
                            }));
                            setIsLoading(false);
                            clearSelection();
                            setConfirmModal(prev => ({ ...prev, open: false }));
                            showToast(`üìù –°–ø–∏—Å–∞–Ω–æ: ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                        }, 100);
                    }
                );
            }, [selectedItems, showConfirm, clearSelection, showToast]);

            const bulkUncheck = useCallback(() => {
                if (selectedItems.size === 0) return;
                showConfirm(
                    `–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É —Å ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`,
                    '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–µ—Ä–Ω—É—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å "–û–∂–∏–¥–∞–µ—Ç"',
                    () => {
                        setIsLoading(true);
                        setTimeout(() => {
                            setEquipment(prev => prev.map(item => {
                                if (selectedItems.has(item.id)) {
                                    return { ...item, checked: false, writeOff: false, checkedAt: null };
                                }
                                return item;
                            }));
                            setIsLoading(false);
                            clearSelection();
                            setConfirmModal(prev => ({ ...prev, open: false }));
                            showToast(`‚Ü© –û—Ç–º–µ–Ω–µ–Ω–æ: ${selectedItems.size} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                        }, 100);
                    }
                );
            }, [selectedItems, showConfirm, clearSelection, showToast]);

            // –ü–µ—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
            const bulkPrint = useCallback(() => {
                if (selectedItems.size === 0) return;

                const items = equipment.filter(item => selectedItems.has(item.id));
                const date = new Date().toLocaleDateString('ru-RU');

                // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
                const serialCategories = ['–ù–æ—É—Ç–±—É–∫–∏', '–ö–æ–º–ø—å—é—Ç–µ—Ä—ã –∏ –º–æ–Ω–æ–±–ª–æ–∫–∏'];

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                items.forEach(item => {
                    const category = item.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!byCategory[category]) byCategory[category] = [];
                    byCategory[category].push(item);
                });

                let sectionsHtml = '';
                Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([category, catItems]) => {
                    const showSerial = serialCategories.includes(category);
                    sectionsHtml += '<div class="category-section">';
                    sectionsHtml += '<div class="category-header">' + category + ' (' + catItems.length + ' —à—Ç.)</div>';

                    if (showSerial) {
                        // –¢–∞–±–ª–∏—Ü–∞ —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
                        sectionsHtml += '<table><thead><tr><th style="width:3%">‚Ññ</th><th style="width:10%">–ò–Ω–≤. ‚Ññ</th><th style="width:12%">–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ</th><th style="width:22%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:13%">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th><th style="width:10%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th style="width:15%">–ó–∞–º–µ—Ç–∫–∏</th><th style="width:15%">–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
                    } else {
                        sectionsHtml += '<table><thead><tr><th style="width:3%">‚Ññ</th><th style="width:10%">–ò–Ω–≤. ‚Ññ</th><th style="width:25%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:15%">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th><th style="width:12%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th style="width:20%">–ó–∞–º–µ—Ç–∫–∏</th><th style="width:15%">–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
                    }

                    catItems.sort((a, b) => (a.invNumber || '').localeCompare(b.invNumber || '')).forEach((item, idx) => {
                        const location = [item.building, item.floor ? '—ç—Ç.' + item.floor : '', item.location].filter(Boolean).join(', ') || '-';
                        const status = item.writeOff ? 'üìù –°–ø–∏—Å–∞–Ω–∏–µ' : item.checked ? '‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç';
                        const statusClass = item.writeOff ? 'status-writeoff' : item.checked ? 'status-checked' : 'status-pending';
                        const notes = (item.inventoryNote || '').trim() || '-';

                        if (showSerial) {
                            const serial = (item.serialNumber || '').trim() || '-';
                            sectionsHtml += '<tr><td>' + (idx + 1) + '</td><td class="inv-number">' + (item.invNumber || '-') + '</td><td class="serial-number">' + serial + '</td><td>' + (item.name || '-') + '</td><td class="location">' + location + '</td><td>' + (item.responsible || '-') + '</td><td class="notes">' + notes + '</td><td class="' + statusClass + '">' + status + '</td></tr>';
                        } else {
                            sectionsHtml += '<tr><td>' + (idx + 1) + '</td><td class="inv-number">' + (item.invNumber || '-') + '</td><td>' + (item.name || '-') + '</td><td class="location">' + location + '</td><td>' + (item.responsible || '-') + '</td><td class="notes">' + notes + '</td><td class="' + statusClass + '">' + status + '</td></tr>';
                        }
                    });

                    sectionsHtml += '</tbody></table></div>';
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:15px;color:#333;font-size:11px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #3182ce}');
                printWindow.document.write('.header h1{font-size:20px;color:#2c5282;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:14px;color:#718096;font-weight:normal}');
                printWindow.document.write('.stats{display:flex;justify-content:center;gap:30px;margin-bottom:15px;padding:10px;background:#ebf8ff;border-radius:6px;border:1px solid #90cdf4}');
                printWindow.document.write('.stat-item{text-align:center}.stat-value{font-size:18px;font-weight:bold;color:#2c5282}.stat-label{font-size:10px;color:#718096}');
                printWindow.document.write('.category-section{margin-bottom:15px;break-inside:avoid}');
                printWindow.document.write('.category-header{background:#2c5282;color:white;padding:8px 12px;font-weight:bold;font-size:12px;border-radius:4px 4px 0 0}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:10px}');
                printWindow.document.write('th{background:#edf2f7;padding:6px 8px;text-align:left;font-weight:600;color:#4a5568;border:1px solid #e2e8f0}');
                printWindow.document.write('td{padding:6px 8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.inv-number{font-family:monospace;font-weight:bold;color:#2d3748;white-space:nowrap}');
                printWindow.document.write('.serial-number{font-family:monospace;font-size:9px;color:#4a5568;white-space:nowrap}');
                printWindow.document.write('.location{color:#718096;font-size:9px}');
                printWindow.document.write('.notes{color:#4a5568;font-size:9px;font-style:italic}');
                printWindow.document.write('.status-checked{color:#38a169;font-weight:bold}');
                printWindow.document.write('.status-writeoff{color:#e53e3e;font-weight:bold}');
                printWindow.document.write('.status-pending{color:#d69e2e}');
                printWindow.document.write('.footer{margin-top:20px;text-align:center;font-size:10px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4 portrait}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>üìã –í–´–ë–†–ê–ù–ù–û–ï –û–ë–û–†–£–î–û–í–ê–ù–ò–ï</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</h2></div>');

                const checked = items.filter(i => i.checked && !i.writeOff).length;
                const writeOff = items.filter(i => i.writeOff).length;
                const pending = items.filter(i => !i.checked && !i.writeOff).length;

                printWindow.document.write('<div class="stats">');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + date + '</div><div class="stat-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + items.length + '</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#38a169">' + checked + '</div><div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#d69e2e">' + pending + '</div><div class="stat-label">–û–∂–∏–¥–∞–µ—Ç</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#e53e3e">' + writeOff + '</div><div class="stat-label">–°–ø–∏—Å–∞–Ω–æ</div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write(sectionsHtml);

                printWindow.document.write('<div class="footer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                showToast('üñ®Ô∏è –ü–µ—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π');
            }, [selectedItems, equipment, showToast]);

            // –ü–µ—á–∞—Ç—å —Ä–µ–µ—Å—Ç—Ä–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏
            const printDeletedRegistry = useCallback(() => {
                const deletedItems = equipment.filter(item => item.deleted);
                if (deletedItems.length === 0) {
                    showToast('‚ö†Ô∏è –ù–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤');
                    return;
                }

                const date = new Date().toLocaleDateString('ru-RU');

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                deletedItems.forEach(item => {
                    const category = item.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!byCategory[category]) byCategory[category] = [];
                    byCategory[category].push(item);
                });

                let sectionsHtml = '';
                Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([category, catItems]) => {
                    sectionsHtml += '<div class="category-section">';
                    sectionsHtml += '<div class="category-header">' + category + ' (' + catItems.length + ' —à—Ç.)</div>';
                    sectionsHtml += '<table><thead><tr><th style="width:3%">‚Ññ</th><th style="width:12%">–ò–Ω–≤. ‚Ññ</th><th style="width:30%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:18%">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th><th style="width:15%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th style="width:12%">–î–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è</th><th style="width:10%">–ü–æ–¥–ø–∏—Å—å</th></tr></thead><tbody>';

                    catItems.sort((a, b) => (a.invNumber || '').localeCompare(b.invNumber || '')).forEach((item, idx) => {
                        const location = [item.building, item.floor ? '—ç—Ç.' + item.floor : '', item.location].filter(Boolean).join(', ') || '-';
                        const deletedDate = item.deletedAt ? new Date(item.deletedAt).toLocaleDateString('ru-RU') : '-';
                        sectionsHtml += '<tr><td>' + (idx + 1) + '</td><td class="inv-number">' + (item.invNumber || '-') + '</td><td>' + (item.name || '-') + '</td><td class="location">' + location + '</td><td>' + (item.responsible || '-') + '</td><td style="text-align:center">' + deletedDate + '</td><td></td></tr>';
                    });

                    sectionsHtml += '</tbody></table></div>';
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–†–µ–µ—Å—Ç—Ä —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:15px;color:#333;font-size:11px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #718096}');
                printWindow.document.write('.header h1{font-size:20px;color:#4a5568;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:14px;color:#718096;font-weight:normal}');
                printWindow.document.write('.header h3{font-size:12px;color:#e53e3e;font-weight:bold;margin-top:8px}');
                printWindow.document.write('.stats{display:flex;justify-content:center;gap:30px;margin-bottom:15px;padding:10px;background:#f7fafc;border-radius:6px;border:1px solid #e2e8f0}');
                printWindow.document.write('.stat-item{text-align:center}.stat-value{font-size:18px;font-weight:bold;color:#4a5568}.stat-label{font-size:10px;color:#718096}');
                printWindow.document.write('.category-section{margin-bottom:15px;break-inside:avoid}');
                printWindow.document.write('.category-header{background:#4a5568;color:white;padding:8px 12px;font-weight:bold;font-size:12px;border-radius:4px 4px 0 0}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:10px}');
                printWindow.document.write('th{background:#edf2f7;padding:6px 8px;text-align:left;font-weight:600;color:#4a5568;border:1px solid #cbd5e0}');
                printWindow.document.write('td{padding:6px 8px;border:1px solid #cbd5e0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.inv-number{font-family:monospace;font-weight:bold;color:#2d3748;white-space:nowrap}');
                printWindow.document.write('.location{color:#718096;font-size:9px}');
                printWindow.document.write('.footer{margin-top:20px;text-align:center;font-size:10px;color:#718096}');
                printWindow.document.write('.notice{margin:15px 0;padding:12px;background:#fff5f5;border-left:4px solid #e53e3e;font-size:11px;color:#c53030}');
                printWindow.document.write('@media print{body{padding:10mm}@page{margin:10mm;size:A4 landscape}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>üóëÔ∏è –†–ï–ï–°–¢–† –£–î–ê–õ–ï–ù–ù–û–ì–û –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</h2><h3>–î–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)</h3></div>');

                printWindow.document.write('<div class="stats">');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + date + '</div><div class="stat-label">–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + deletedItems.length + '</div><div class="stat-label">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + Object.keys(byCategory).length + '</div><div class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write('<div class="notice">‚ö†Ô∏è –î–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –≤ —Å–≤—è–∑–∏ —Å –æ—à–∏–±–æ—á–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –ª–∏—Ü–æ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏.</div>');

                printWindow.document.write(sectionsHtml);

                printWindow.document.write('<div class="footer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + ' | –ü–æ–¥–ø–∏—Å—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ: ___________________</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                showToast('üñ®Ô∏è –ü–µ—á–∞—Ç—å —Ä–µ–µ—Å—Ç—Ä–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è');
            }, [equipment, showToast]);

            // –ü–µ—á–∞—Ç—å –æ—Ç—á—ë—Ç–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É (–§–ò–û/–∫–∞–±–∏–Ω–µ—Ç/—ç—Ç–∞–∂)
            const handlePrintFilteredReport = useCallback((filterType, filterValue, filterBuilding) => {
                if (!filterValue) {
                    showToast('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞');
                    return;
                }

                let items = [];
                let title = '';
                let subtitle = '';

                switch (filterType) {
                    case 'responsible':
                        items = equipment.filter(i => i.responsible === filterValue);
                        title = 'üë§ –û–ë–û–†–£–î–û–í–ê–ù–ò–ï –ü–û –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–ú–£';
                        subtitle = filterValue;
                        break;
                    case 'location':
                        items = equipment.filter(i => i.building === filterBuilding && i.location === filterValue);
                        title = 'üö™ –û–ë–û–†–£–î–û–í–ê–ù–ò–ï –ü–û –ö–ê–ë–ò–ù–ï–¢–£';
                        subtitle = filterBuilding + ', –∫–∞–±. ' + filterValue;
                        break;
                    case 'floor':
                        items = equipment.filter(i => i.building === filterBuilding && String(i.floor) === String(filterValue));
                        title = 'üè¢ –û–ë–û–†–£–î–û–í–ê–ù–ò–ï –ü–û –≠–¢–ê–ñ–£';
                        subtitle = filterBuilding + ', ' + filterValue + ' —ç—Ç–∞–∂';
                        break;
                    case 'year':
                        items = equipment.filter(i => {
                            if (!i.date) return false;
                            const parts = i.date.split('.');
                            return parts.length === 3 && parts[2] === filterValue;
                        });
                        title = 'üìÖ –û–ë–û–†–£–î–û–í–ê–ù–ò–ï –ü–û –ì–û–î–£ –í–í–û–î–ê';
                        subtitle = filterValue + ' –≥–æ–¥';
                        break;
                }

                if (items.length === 0) {
                    showToast('üì≠ –ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É');
                    return;
                }

                const date = new Date().toLocaleDateString('ru-RU');

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                items.forEach(item => {
                    const category = item.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!byCategory[category]) byCategory[category] = [];
                    byCategory[category].push(item);
                });

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥–æ–¥ –∏–∑ –¥–∞—Ç—ã (—Ñ–æ—Ä–º–∞—Ç "29.12.2017")
                const getYear = (dateStr) => {
                    if (!dateStr) return '-';
                    const parts = dateStr.split('.');
                    return parts.length === 3 ? parts[2] : '-';
                };

                let sectionsHtml = '';
                Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([category, catItems]) => {
                    sectionsHtml += '<div class="category-section">';
                    sectionsHtml += '<div class="category-header">' + category + ' (' + catItems.length + ' —à—Ç.)</div>';
                    sectionsHtml += '<table><thead><tr><th style="width:3%">‚Ññ</th><th style="width:10%">–ò–Ω–≤. ‚Ññ</th><th style="width:28%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:5%">–ì–æ–¥</th>';
                    if (filterType !== 'location') sectionsHtml += '<th style="width:16%">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>';
                    if (filterType !== 'responsible') sectionsHtml += '<th style="width:13%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>';
                    sectionsHtml += '<th style="width:10%">–°—Ç–∞—Ç—É—Å</th><th style="width:8%">–ë–∏—Ä–∫–∞</th></tr></thead><tbody>';

                    catItems.sort((a, b) => (a.invNumber || '').localeCompare(b.invNumber || '')).forEach((item, idx) => {
                        const location = [item.building, item.floor ? '—ç—Ç.' + item.floor : '', item.location].filter(Boolean).join(', ') || '-';
                        const status = item.writeOff ? 'üìù –°–ø–∏—Å–∞–Ω–æ' : item.checked ? '‚úì OK' : '‚è≥';
                        const statusClass = item.writeOff ? 'status-writeoff' : item.checked ? 'status-checked' : 'status-pending';
                        const labelStatus = item.hasLabel === true ? '‚úì' : item.hasLabel === false ? '‚úó' : '?';
                        const labelClass = item.hasLabel === true ? 'label-yes' : item.hasLabel === false ? 'label-no' : 'label-unknown';
                        const year = getYear(item.date);

                        sectionsHtml += '<tr><td>' + (idx + 1) + '</td><td class="inv-number">' + (item.invNumber || '-') + '</td><td>' + (item.name || '-') + '</td><td class="year-cell">' + year + '</td>';
                        if (filterType !== 'location') sectionsHtml += '<td class="location">' + location + '</td>';
                        if (filterType !== 'responsible') sectionsHtml += '<td>' + (item.responsible || '-') + '</td>';
                        sectionsHtml += '<td class="' + statusClass + '">' + status + '</td>';
                        sectionsHtml += '<td class="' + labelClass + '">' + labelStatus + '</td></tr>';
                    });

                    sectionsHtml += '</tbody></table></div>';
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>' + title + '</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:15px;color:#333;font-size:11px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #805ad5}');
                printWindow.document.write('.header h1{font-size:18px;color:#553c9a;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:16px;color:#6b46c1;font-weight:bold;margin-bottom:5px}');
                printWindow.document.write('.header h3{font-size:12px;color:#718096;font-weight:normal}');
                printWindow.document.write('.stats{display:flex;justify-content:center;gap:25px;margin-bottom:15px;padding:10px;background:#faf5ff;border-radius:6px;border:1px solid #d6bcfa}');
                printWindow.document.write('.stat-item{text-align:center}.stat-value{font-size:18px;font-weight:bold;color:#553c9a}.stat-label{font-size:10px;color:#718096}');
                printWindow.document.write('.category-section{margin-bottom:15px;break-inside:avoid}');
                printWindow.document.write('.category-header{background:#553c9a;color:white;padding:8px 12px;font-weight:bold;font-size:12px;border-radius:4px 4px 0 0}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:10px}');
                printWindow.document.write('th{background:#edf2f7;padding:6px 8px;text-align:left;font-weight:600;color:#4a5568;border:1px solid #e2e8f0}');
                printWindow.document.write('td{padding:6px 8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.inv-number{font-family:monospace;font-weight:bold;color:#2d3748;white-space:nowrap}');
                printWindow.document.write('.year-cell{text-align:center;color:#553c9a;font-weight:600}');
                printWindow.document.write('.location{color:#718096;font-size:9px}');
                printWindow.document.write('.status-checked{color:#38a169;font-weight:bold}');
                printWindow.document.write('.status-writeoff{color:#e53e3e;font-weight:bold}');
                printWindow.document.write('.status-pending{color:#d69e2e}');
                printWindow.document.write('.label-yes{color:#38a169;font-weight:bold;text-align:center}');
                printWindow.document.write('.label-no{color:#e53e3e;font-weight:bold;text-align:center}');
                printWindow.document.write('.label-unknown{color:#a0aec0;text-align:center}');
                printWindow.document.write('.footer{margin-top:20px;padding-top:15px;border-top:1px solid #e2e8f0}');
                printWindow.document.write('.signature-row{display:flex;justify-content:space-between;margin-top:20px}');
                printWindow.document.write('.signature-line{width:45%}.signature-line p{border-bottom:1px solid #333;height:25px}.signature-line span{font-size:9px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>' + title + '</h1><h2>' + subtitle + '</h2><h3>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</h3></div>');

                const checked = items.filter(i => i.checked && !i.writeOff).length;
                const writeOff = items.filter(i => i.writeOff).length;
                const pending = items.filter(i => !i.checked && !i.writeOff).length;
                const noLabel = items.filter(i => i.hasLabel === false).length;

                printWindow.document.write('<div class="stats">');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + date + '</div><div class="stat-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + items.length + '</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#38a169">' + checked + '</div><div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#d69e2e">' + pending + '</div><div class="stat-label">–û–∂–∏–¥–∞–µ—Ç</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#e53e3e">' + writeOff + '</div><div class="stat-label">–°–ø–∏—Å–∞–Ω–æ</div></div>');
                if (noLabel > 0) printWindow.document.write('<div class="stat-item"><div class="stat-value" style="color:#e53e3e">' + noLabel + '</div><div class="stat-label">–ë–µ–∑ –±–∏—Ä–∫–∏</div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write(sectionsHtml);

                printWindow.document.write('<div class="footer">');
                printWindow.document.write('<div class="signature-row"><div class="signature-line"><p></p><span>–ü–æ–¥–ø–∏—Å—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</span></div><div class="signature-line"><p></p><span>–î–∞—Ç–∞</span></div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                setReportFilterModal({ open: false, filterType: 'responsible', filterValue: '', filterBuilding: '' });
                showToast('üìã –û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');
            }, [equipment, showToast]);

            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –º–∞—Å—Ç–µ—Ä–∞
            const quickCheck = useCallback((item) => {
                setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, checked: true, checkedAt: new Date().toISOString() } : i));
                addToHistory('check', item, '–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞');
                showToast('‚úì –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ');
            }, [addToHistory, showToast]);

            // –ë—ã—Å—Ç—Ä–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
            const quickWriteOff = useCallback((item) => {
                showConfirm('–°–ø–∏—Å–∞—Ç—å?', item.name, () => {
                    setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, writeOff: true, checked: false, checkedAt: new Date().toISOString() } : i));
                    addToHistory('writeoff', item, '–ë—ã—Å—Ç—Ä–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ');
                    setConfirmModal(prev => ({ ...prev, open: false }));
                    showToast('üìù –°–ø–∏—Å–∞–Ω–æ');
                });
            }, [showConfirm, addToHistory, showToast]);

            const openDetails = useCallback((item) => {
                setDetailsForm({
                    serialNumber: item.serialNumber || '', location: item.location || '', responsible: item.responsible || '',
                    inventoryNote: item.inventoryNote || '', hasLabel: item.hasLabel, building: item.building || '', floor: item.floor || ''
                });
                setDetailsModal({ open: true, item });
            }, []);

            const saveDetails = useCallback(() => {
                const item = detailsModal.item;
                setEquipment(prev => prev.map(i => i.id === item.id ? { ...i, ...detailsForm } : i));
                
                const rooms = directories.rooms || [];
                const roomsWithBuilding = directories.roomsWithBuilding || [];
                
                if (detailsForm.location && detailsForm.building) {
                    const exists = roomsWithBuilding.find(r => r && r.name === detailsForm.location && r.building === detailsForm.building);
                    if (!exists) {
                        setDirectories(prev => ({
                            ...prev,
                            roomsWithBuilding: [...(prev.roomsWithBuilding || []), { name: detailsForm.location, building: detailsForm.building }],
                            rooms: [...new Set([...(prev.rooms || []), detailsForm.location])].sort((a, b) => a.localeCompare(b, 'ru'))
                        }));
                    }
                } else if (detailsForm.location && !rooms.includes(detailsForm.location)) {
                    setDirectories(prev => ({ ...prev, rooms: [...(prev.rooms || []), detailsForm.location].sort((a, b) => a.localeCompare(b, 'ru')) }));
                }
                
                const people = directories.people || [];
                if (detailsForm.responsible && !people.includes(detailsForm.responsible)) {
                    setDirectories(prev => ({ ...prev, people: [...(prev.people || []), detailsForm.responsible].sort((a, b) => a.localeCompare(b, 'ru')) }));
                }
                
                setDetailsModal({ open: false, item: null });
                showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            }, [detailsModal.item, detailsForm, directories, showToast]);

            const openEditModal = useCallback((item = null) => {
                if (item) {
                    setEditForm({ name: item.name, invNumber: item.invNumber, date: item.date || '', category: item.category, newCategory: '', note: item.note || '', building: item.building || '', floor: item.floor || '' });
                    setEditModal({ open: true, item, isNew: false });
                } else {
                    setEditForm({ name: '', invNumber: '', date: new Date().toLocaleDateString('ru-RU'), category: '', newCategory: '', note: '', building: '', floor: '' });
                    setEditModal({ open: true, item: null, isNew: true });
                }
            }, []);

            const saveEdit = useCallback(() => {
                const { name, invNumber, date, category, newCategory, note, building, floor } = editForm;
                if (!name.trim()) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
                if (!invNumber.trim()) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä'); return; }
                const finalCategory = newCategory.trim() || category;
                if (!finalCategory) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é'); return; }
                
                const duplicate = equipment.find(i => i.invNumber === invNumber && i.id !== editModal.item?.id);
                if (duplicate) { showToast('–ù–æ–º–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }

                if (editModal.isNew) {
                    const newItem = {
                        id: 'item_' + Date.now(), name: name.trim(), invNumber: invNumber.trim(), date: date.trim(), category: finalCategory, note: note.trim(),
                        building: building, floor: floor, checked: false, writeOff: false, hasLabel: null, serialNumber: '', location: '', responsible: '', inventoryNote: '', isUserAdded: true
                    };
                    setEquipment(prev => [...prev, newItem]);
                    addToHistory('add', newItem, '–î–æ–±–∞–≤–ª–µ–Ω–æ');
                    showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ');
                } else {
                    setEquipment(prev => prev.map(i => i.id === editModal.item.id ? { ...i, name: name.trim(), invNumber: invNumber.trim(), date: date.trim(), category: finalCategory, note: note.trim(), building, floor } : i));
                    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                }
                setEditModal({ open: false, item: null, isNew: false });
            }, [editForm, editModal, equipment, showToast, addToHistory]);

            const addToDirectory = useCallback((type, value, building = null) => {
                if (!value.trim()) return;
                
                if (type === 'rooms') {
                    const rooms = directories.rooms || [];
                    const roomsWithBuilding = directories.roomsWithBuilding || [];
                    
                    if (building) {
                        const exists = roomsWithBuilding.find(r => r && r.name === value.trim() && r.building === building);
                        if (exists) { showToast('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
                        setDirectories(prev => ({
                            ...prev,
                            roomsWithBuilding: [...(prev.roomsWithBuilding || []), { name: value.trim(), building }],
                            rooms: [...new Set([...(prev.rooms || []), value.trim()])].sort((a, b) => a.localeCompare(b, 'ru'))
                        }));
                    } else {
                        if (rooms.includes(value.trim())) { showToast('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
                        setDirectories(prev => ({ ...prev, rooms: [...(prev.rooms || []), value.trim()].sort((a, b) => a.localeCompare(b, 'ru')) }));
                    }
                    setRoomsModal(prev => ({ ...prev, newRoom: '' }));
                } else {
                    const people = directories.people || [];
                    if (people.includes(value.trim())) { showToast('–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); return; }
                    setDirectories(prev => ({ ...prev, people: [...(prev.people || []), value.trim()].sort((a, b) => a.localeCompare(b, 'ru')) }));
                    setPeopleModal(prev => ({ ...prev, newPerson: '' }));
                }
                showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ');
            }, [directories, showToast]);

            const removeFromDirectory = useCallback((type, idx) => {
                const key = type === 'rooms' ? 'rooms' : 'people';
                const items = directories[key] || [];
                const item = items[idx];
                if (!item) return;
                
                showConfirm('–£–¥–∞–ª–∏—Ç—å?', item, () => {
                    if (type === 'rooms') {
                        setDirectories(prev => ({
                            ...prev, rooms: (prev.rooms || []).filter((_, i) => i !== idx),
                            roomsWithBuilding: (prev.roomsWithBuilding || []).filter(r => r && r.name !== item)
                        }));
                    } else {
                        setDirectories(prev => ({ ...prev, [key]: (prev[key] || []).filter((_, i) => i !== idx) }));
                    }
                    setConfirmModal(prev => ({ ...prev, open: false }));
                    showToast('–£–¥–∞–ª–µ–Ω–æ');
                });
            }, [directories, showConfirm, showToast]);

            const handleSave = () => showConfirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å?', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?', () => {
                localStorage.setItem('inv_102_data_v12', JSON.stringify(equipment));
                setConfirmModal(prev => ({ ...prev, open: false }));
                showToast('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            });

            const handleExportExcel = () => {
                const BOM = '\uFEFF';
                const headers = ['–ò–Ω–≤.‚Ññ', 'S/N', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ó–¥–∞–Ω–∏–µ', '–≠—Ç–∞–∂', '–ö–∞–±–∏–Ω–µ—Ç', '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', '–°—Ç–∞—Ç—É—Å', '–ë–∏—Ä–∫–∞', '–ó–∞–º–µ—Ç–∫–∞'];
                let csv = BOM + headers.join(';') + '\n';
                equipment.forEach(item => {
                    const status = item.writeOff ? '–°–ø–∏—Å–∞–Ω–∏–µ' : item.checked ? '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç';
                    const label = item.hasLabel === true ? '–ï—Å—Ç—å' : item.hasLabel === false ? '–ù–ï–¢' : '-';
                    const row = [item.invNumber, item.serialNumber || '', item.name, item.category, item.building || '', item.floor || '', item.location || '', item.responsible || '', status, label, item.inventoryNote || '']
                        .map(f => `"${String(f).replace(/"/g, '""')}"`).join(';');
                    csv += row + '\n';
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `inventory_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                setExportModal({ open: false });
                showToast('üìä –°–∫–∞—á–∞–Ω–æ');
            };

            const handleExportCheckedReport = () => {
                const checkedItems = equipment.filter(item => item.checked || item.writeOff);
                const date = new Date().toLocaleDateString('ru-RU');
                const percent = equipment.length > 0 ? Math.round((checkedItems.length / equipment.length) * 100) : 0;

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∑–¥–∞–Ω–∏—è–º –∏ —ç—Ç–∞–∂–∞–º
                const byBuilding = {};
                checkedItems.forEach(item => {
                    const building = item.building || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    const floor = item.floor || '-';
                    if (!byBuilding[building]) byBuilding[building] = {};
                    if (!byBuilding[building][floor]) byBuilding[building][floor] = [];
                    byBuilding[building][floor].push(item);
                });

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–µ–∫—Ü–∏–π
                let sectionsHtml = '';
                Object.entries(byBuilding).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([building, floors]) => {
                    const buildingClass = building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'nansen' : building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'botanica' : 'unknown';
                    const buildingIcon = building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'üè¢' : 'üìç';
                    const totalInBuilding = Object.values(floors).flat().length;

                    sectionsHtml += '<div class="building-section">';
                    sectionsHtml += '<div class="building-header ' + buildingClass + '">' + buildingIcon + ' ' + building + ' (' + totalInBuilding + ' —à—Ç.)</div>';

                    Object.entries(floors).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([floor, items]) => {
                        sectionsHtml += '<div class="floor-section">';
                        sectionsHtml += '<div class="floor-header">–≠—Ç–∞–∂ ' + floor + '</div>';
                        sectionsHtml += '<table><thead><tr><th style="width:12%">–ò–Ω–≤. ‚Ññ</th><th style="width:38%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:15%">–ö–∞–±–∏–Ω–µ—Ç</th><th style="width:20%">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th style="width:8%">–°—Ç–∞—Ç—É—Å</th><th style="width:7%">–ë–∏—Ä–∫–∞</th></tr></thead><tbody>';

                        items.sort((a, b) => (a.location || '').localeCompare(b.location || '', 'ru')).forEach(item => {
                            const statusClass = item.writeOff ? 'status-writeoff' : 'status-ok';
                            const statusText = item.writeOff ? '–°–ø–∏—Å–∞–Ω–∏–µ' : '–û–ö';
                            const labelText = item.hasLabel === true ? '‚úì' : item.hasLabel === false ? '‚úó' : '-';
                            sectionsHtml += '<tr><td class="inv-number">' + (item.invNumber || '-') + '</td><td>' + (item.name || '-') + '</td><td>' + (item.location || '-') + '</td><td>' + (item.responsible || '-') + '</td><td class="' + statusClass + '">' + statusText + '</td><td>' + labelText + '</td></tr>';
                        });

                        sectionsHtml += '</tbody></table></div>';
                    });

                    sectionsHtml += '</div>';
                });

                // –°–æ–∑–¥–∞—ë–º HTML –¥–ª—è –ø–µ—á–∞—Ç–∏
                const printWindow = window.open('', '_blank');
                const percentColor = percent >= 80 ? '#38a169' : percent >= 50 ? '#d69e2e' : '#e53e3e';

                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–û—Ç—á—ë—Ç –ø–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:"Segoe UI",Tahoma,sans-serif;padding:20px;color:#333}.header{text-align:center;margin-bottom:30px;border-bottom:3px solid #3182ce;padding-bottom:20px}.header h1{font-size:24px;color:#2d3748;margin-bottom:5px}.header h2{font-size:16px;color:#718096;font-weight:normal}.stats{display:flex;justify-content:space-between;margin-bottom:25px;padding:15px;background:#f7fafc;border-radius:8px}.stat-item{text-align:center}.stat-value{font-size:28px;font-weight:bold;color:#3182ce}.stat-label{font-size:12px;color:#718096}.building-section{margin-bottom:25px;break-inside:avoid}.building-header{background:linear-gradient(135deg,#3182ce,#2c5282);color:#fff;padding:10px 15px;border-radius:6px 6px 0 0;font-weight:bold;font-size:14px}.building-header.nansen{background:linear-gradient(135deg,#3182ce,#2c5282)}.building-header.botanica{background:linear-gradient(135deg,#38a169,#276749)}.building-header.unknown{background:linear-gradient(135deg,#718096,#4a5568)}.floor-section{border:1px solid #e2e8f0;border-top:none}.floor-header{background:#edf2f7;padding:8px 15px;font-weight:600;font-size:12px;color:#4a5568;border-bottom:1px solid #e2e8f0}table{width:100%;border-collapse:collapse;font-size:11px}th{background:#f7fafc;padding:8px 10px;text-align:left;font-weight:600;color:#4a5568;border-bottom:2px solid #e2e8f0}td{padding:8px 10px;border-bottom:1px solid #e2e8f0}tr:nth-child(even){background:#f7fafc}.inv-number{font-family:monospace;font-weight:bold;color:#2d3748}.status-ok{color:#38a169;font-weight:bold}.status-writeoff{color:#e53e3e;font-weight:bold}.signature-section{margin-top:50px;display:flex;justify-content:space-between;padding-top:30px;border-top:1px solid #e2e8f0}.signature-line{width:45%}.signature-line p{border-bottom:1px solid #333;padding-bottom:5px;margin-bottom:5px}.signature-line span{font-size:11px;color:#718096}.footer{margin-top:30px;text-align:center;font-size:10px;color:#a0aec0}@media print{body{padding:10px}.building-section{break-inside:avoid}@page{margin:15mm}}</style></head><body>');
                printWindow.document.write('<div class="header"><h1>üìã –û–¢–ß–Å–¢ –ü–û –ò–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–ò–ò</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</h2></div>');
                printWindow.document.write('<div class="stats"><div class="stat-item"><div class="stat-value">' + date + '</div><div class="stat-label">–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</div></div><div class="stat-item"><div class="stat-value">' + checkedItems.length + '</div><div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div></div><div class="stat-item"><div class="stat-value">' + equipment.length + '</div><div class="stat-label">–í—Å–µ–≥–æ</div></div><div class="stat-item"><div class="stat-value" style="color:' + percentColor + '">' + percent + '%</div><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div></div>');
                printWindow.document.write(sectionsHtml);
                printWindow.document.write('<div class="signature-section"><div class="signature-line"><p>&nbsp;</p><span>–ü–æ–¥–ø–∏—Å—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</span></div><div class="signature-line"><p>&nbsp;</p><span>–î–∞—Ç–∞</span></div></div>');
                printWindow.document.write('<div class="footer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + new Date().toLocaleString('ru-RU') + '</div>');
                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                setExportModal({ open: false });
                showToast('üìÑ –û—Ç—á—ë—Ç –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏');
            };

            // –ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞ –ù–ï –ù–ê–ô–î–ï–ù–ù–´–• –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞
            const handlePrintNotFound = () => {
                const notFoundItems = equipment.filter(item => !item.checked && !item.writeOff);
                const date = new Date().toLocaleDateString('ru-RU');

                if (notFoundItems.length === 0) {
                    showToast('‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!');
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byCategory = {};
                notFoundItems.forEach(item => {
                    const category = item.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!byCategory[category]) byCategory[category] = [];
                    byCategory[category].push(item);
                });

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
                let sectionsHtml = '';
                Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0], 'ru')).forEach(([category, items]) => {
                    sectionsHtml += '<div class="category-section">';
                    sectionsHtml += '<div class="category-header">' + category + ' (' + items.length + ' —à—Ç.)</div>';
                    sectionsHtml += '<table><thead><tr><th style="width:5%">‚òê</th><th style="width:12%">–ò–Ω–≤. ‚Ññ</th><th style="width:40%">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="width:15%">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –º–µ—Å—Ç–æ</th><th style="width:28%">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead><tbody>';

                    items.sort((a, b) => (a.invNumber || '').localeCompare(b.invNumber || '')).forEach(item => {
                        const lastLocation = [item.building, item.floor ? '—ç—Ç.' + item.floor : '', item.location].filter(Boolean).join(', ') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                        sectionsHtml += '<tr><td class="checkbox-cell">‚òê</td><td class="inv-number">' + (item.invNumber || '-') + '</td><td>' + (item.name || '-') + '</td><td class="location">' + lastLocation + '</td><td class="note-cell"></td></tr>';
                    });

                    sectionsHtml += '</tbody></table></div>';
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ü–æ–∏—Å–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Segoe UI",Tahoma,sans-serif;padding:15px;color:#333;font-size:11px}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #e53e3e}');
                printWindow.document.write('.header h1{font-size:20px;color:#c53030;margin-bottom:5px}');
                printWindow.document.write('.header h2{font-size:14px;color:#718096;font-weight:normal}');
                printWindow.document.write('.stats{display:flex;justify-content:space-between;margin-bottom:15px;padding:10px;background:#fff5f5;border-radius:6px;border:1px solid #feb2b2}');
                printWindow.document.write('.stat-item{text-align:center}.stat-value{font-size:20px;font-weight:bold;color:#c53030}.stat-label{font-size:10px;color:#718096}');
                printWindow.document.write('.instructions{background:#fffbeb;border:1px solid #f6e05e;border-radius:6px;padding:10px;margin-bottom:15px;font-size:10px}');
                printWindow.document.write('.instructions strong{color:#744210}');
                printWindow.document.write('.category-section{margin-bottom:15px;break-inside:avoid}');
                printWindow.document.write('.category-header{background:#4a5568;color:white;padding:8px 12px;font-weight:bold;font-size:12px;border-radius:4px 4px 0 0}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;font-size:10px}');
                printWindow.document.write('th{background:#edf2f7;padding:6px 8px;text-align:left;font-weight:600;color:#4a5568;border:1px solid #e2e8f0}');
                printWindow.document.write('td{padding:6px 8px;border:1px solid #e2e8f0;vertical-align:top}');
                printWindow.document.write('tr:nth-child(even){background:#f7fafc}');
                printWindow.document.write('.checkbox-cell{text-align:center;font-size:14px}');
                printWindow.document.write('.inv-number{font-family:monospace;font-weight:bold;color:#2d3748;white-space:nowrap}');
                printWindow.document.write('.location{color:#718096;font-size:9px}');
                printWindow.document.write('.note-cell{background:#fffbeb}');
                printWindow.document.write('.footer{margin-top:20px;padding-top:15px;border-top:1px solid #e2e8f0}');
                printWindow.document.write('.signature-row{display:flex;justify-content:space-between;margin-top:30px}');
                printWindow.document.write('.signature-line{width:45%}.signature-line p{border-bottom:1px solid #333;height:25px}.signature-line span{font-size:9px;color:#718096}');
                printWindow.document.write('@media print{body{padding:10px}@page{margin:10mm;size:A4}}');
                printWindow.document.write('</style></head><body>');

                printWindow.document.write('<div class="header"><h1>üîç –ü–û–ò–°–ö –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø</h1><h2>–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</h2></div>');

                printWindow.document.write('<div class="stats">');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + date + '</div><div class="stat-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + notFoundItems.length + '</div><div class="stat-label">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + equipment.length + '</div><div class="stat-label">–í—Å–µ–≥–æ</div></div>');
                printWindow.document.write('<div class="stat-item"><div class="stat-value">' + Math.round(((equipment.length - notFoundItems.length) / equipment.length) * 100) + '%</div><div class="stat-label">–ù–∞–π–¥–µ–Ω–æ</div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write('<div class="instructions"><strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–æ–π (‚òë) –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ. –í –∫–æ–ª–æ–Ω–∫–µ "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" —É–∫–∞–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏.</div>');

                printWindow.document.write(sectionsHtml);

                printWindow.document.write('<div class="footer">');
                printWindow.document.write('<div class="signature-row"><div class="signature-line"><p></p><span>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –ø–æ–∏—Å–∫</span></div><div class="signature-line"><p></p><span>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span></div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                setExportModal({ open: false });
                showToast('üîç –°–ø–∏—Å–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç');
            };

            // –ê–∫—Ç —Å–≤–µ—Ä–∫–∏ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏
            const handlePrintReconciliation = () => {
                const date = new Date().toLocaleDateString('ru-RU');
                const currentYear = new Date().getFullYear();

                const total = equipment.length;
                const checked = equipment.filter(i => i.checked && !i.writeOff).length;
                const writeOff = equipment.filter(i => i.writeOff).length;
                const pending = equipment.filter(i => !i.checked && !i.writeOff).length;
                const noLabel = equipment.filter(i => i.hasLabel === false).length;

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–¥–∞–Ω–∏—è–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const byBuilding = {};
                equipment.forEach(item => {
                    const building = item.building || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    if (!byBuilding[building]) byBuilding[building] = { total: 0, checked: 0, writeOff: 0, items: [] };
                    byBuilding[building].total++;
                    if (item.checked && !item.writeOff) byBuilding[building].checked++;
                    if (item.writeOff) byBuilding[building].writeOff++;
                    byBuilding[building].items.push(item);
                });

                const byCategory = {};
                equipment.forEach(item => {
                    const cat = item.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                    if (!byCategory[cat]) byCategory[cat] = { total: 0, checked: 0, writeOff: 0 };
                    byCategory[cat].total++;
                    if (item.checked && !item.writeOff) byCategory[cat].checked++;
                    if (item.writeOff) byCategory[cat].writeOff++;
                });

                const printWindow = window.open('', '_blank');
                printWindow.document.write('<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>–ê–∫—Ç —Å–≤–µ—Ä–∫–∏</title><style>');
                printWindow.document.write('*{margin:0;padding:0;box-sizing:border-box}');
                printWindow.document.write('body{font-family:"Times New Roman",serif;padding:20mm;color:#000;font-size:12pt;line-height:1.5}');
                printWindow.document.write('.header{text-align:center;margin-bottom:20px}');
                printWindow.document.write('.header h1{font-size:14pt;font-weight:bold;margin-bottom:10px}');
                printWindow.document.write('.header h2{font-size:12pt;font-weight:normal;margin-bottom:5px}');
                printWindow.document.write('.org-info{text-align:right;font-size:10pt;margin-bottom:15px}');
                printWindow.document.write('.section{margin-bottom:15px}');
                printWindow.document.write('.section-title{font-weight:bold;margin-bottom:8px;border-bottom:1px solid #000;padding-bottom:3px}');
                printWindow.document.write('table{width:100%;border-collapse:collapse;margin-bottom:15px;font-size:10pt}');
                printWindow.document.write('th,td{border:1px solid #000;padding:5px 8px;text-align:left}');
                printWindow.document.write('th{background:#f0f0f0;font-weight:bold}');
                printWindow.document.write('.num{text-align:center;width:30px}');
                printWindow.document.write('.count{text-align:center;width:60px}');
                printWindow.document.write('.summary-box{border:2px solid #000;padding:15px;margin:20px 0}');
                printWindow.document.write('.summary-row{display:flex;justify-content:space-between;margin-bottom:5px}');
                printWindow.document.write('.signatures{margin-top:30px;page-break-inside:avoid}');
                printWindow.document.write('.sig-row{display:flex;justify-content:space-between;margin-bottom:25px}');
                printWindow.document.write('.sig-item{width:45%}');
                printWindow.document.write('.sig-line{border-bottom:1px solid #000;height:20px;margin-bottom:3px}');
                printWindow.document.write('.sig-label{font-size:9pt;text-align:center}');
                printWindow.document.write('.stamp-place{width:120px;height:120px;border:1px dashed #999;display:flex;align-items:center;justify-content:center;font-size:9pt;color:#999;margin:0 auto}');
                printWindow.document.write('@media print{body{padding:15mm}@page{margin:15mm;size:A4}}');
                printWindow.document.write('</style></head><body>');

                // –®–∞–ø–∫–∞
                printWindow.document.write('<div class="org-info">–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102<br>–≥. –ú–æ—Å–∫–≤–∞</div>');
                printWindow.document.write('<div class="header">');
                printWindow.document.write('<h1>–ê–ö–¢ –°–í–ï–†–ö–ò</h1>');
                printWindow.document.write('<h2>–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π</h2>');
                printWindow.document.write('<p>–æ—Ç ¬´' + new Date().getDate() + '¬ª ' + new Date().toLocaleString('ru-RU', { month: 'long' }) + ' ' + currentYear + ' –≥.</p>');
                printWindow.document.write('</div>');

                // –û—Å–Ω–æ–≤–∞–Ω–∏–µ
                printWindow.document.write('<div class="section">');
                printWindow.document.write('<p>–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–∫–∞–∑–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102 –∫–æ–º–∏—Å—Å–∏–µ–π –≤ —Å–æ—Å—Ç–∞–≤–µ:</p>');
                printWindow.document.write('<p>–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –∫–æ–º–∏—Å—Å–∏–∏: ___________________________________ / _______________</p>');
                printWindow.document.write('<p>–ß–ª–µ–Ω—ã –∫–æ–º–∏—Å—Å–∏–∏: ___________________________________ / _______________</p>');
                printWindow.document.write('<p style="margin-left:100px">___________________________________ / _______________</p>');
                printWindow.document.write('<p style="margin-left:100px">___________________________________ / _______________</p>');
                printWindow.document.write('<p style="margin-top:10px">–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ —Å–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–ª–∏—á–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π.</p>');
                printWindow.document.write('</div>');

                // –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
                printWindow.document.write('<div class="summary-box">');
                printWindow.document.write('<div class="section-title">–ò–¢–û–ì–ò –°–í–ï–†–ö–ò</div>');
                printWindow.document.write('<div class="summary-row"><span>–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü –ø–æ —É—á—ë—Ç—É:</span><strong>' + total + '</strong></div>');
                printWindow.document.write('<div class="summary-row"><span>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –Ω–∞–ª–∏—á–∏–µ:</span><strong style="color:green">' + checked + '</strong></div>');
                printWindow.document.write('<div class="summary-row"><span>–ü–æ–¥–ª–µ–∂–∏—Ç —Å–ø–∏—Å–∞–Ω–∏—é:</span><strong style="color:red">' + writeOff + '</strong></div>');
                printWindow.document.write('<div class="summary-row"><span>–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏):</span><strong style="color:orange">' + pending + '</strong></div>');
                if (noLabel > 0) printWindow.document.write('<div class="summary-row"><span>–ë–µ–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω–æ–π –±–∏—Ä–∫–∏:</span><strong style="color:red">' + noLabel + '</strong></div>');
                printWindow.document.write('</div>');

                // –ü–æ –∑–¥–∞–Ω–∏—è–º
                printWindow.document.write('<div class="section">');
                printWindow.document.write('<div class="section-title">–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ó–î–ê–ù–ò–Ø–ú</div>');
                printWindow.document.write('<table><thead><tr><th class="num">‚Ññ</th><th>–ó–¥–∞–Ω–∏–µ</th><th class="count">–í—Å–µ–≥–æ</th><th class="count">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</th><th class="count">–°–ø–∏—Å–∞–Ω–æ</th><th class="count">–û–∂–∏–¥–∞–µ—Ç</th></tr></thead><tbody>');
                Object.entries(byBuilding).forEach(([building, data], idx) => {
                    const pend = data.total - data.checked - data.writeOff;
                    printWindow.document.write('<tr><td class="num">' + (idx + 1) + '</td><td>' + building + '</td><td class="count">' + data.total + '</td><td class="count">' + data.checked + '</td><td class="count">' + data.writeOff + '</td><td class="count">' + pend + '</td></tr>');
                });
                printWindow.document.write('</tbody></table></div>');

                // –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                printWindow.document.write('<div class="section">');
                printWindow.document.write('<div class="section-title">–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú</div>');
                printWindow.document.write('<table><thead><tr><th class="num">‚Ññ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th class="count">–í—Å–µ–≥–æ</th><th class="count">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</th><th class="count">–°–ø–∏—Å–∞–Ω–æ</th></tr></thead><tbody>');
                Object.entries(byCategory).sort((a, b) => b[1].total - a[1].total).forEach(([cat, data], idx) => {
                    printWindow.document.write('<tr><td class="num">' + (idx + 1) + '</td><td>' + cat + '</td><td class="count">' + data.total + '</td><td class="count">' + data.checked + '</td><td class="count">' + data.writeOff + '</td></tr>');
                });
                printWindow.document.write('</tbody></table></div>');

                // –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
                printWindow.document.write('<div class="section">');
                printWindow.document.write('<div class="section-title">–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï –ö–û–ú–ò–°–°–ò–ò</div>');
                printWindow.document.write('<p>–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Å–≤–µ—Ä–∫–∏ –∫–æ–º–∏—Å—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞:</p>');
                printWindow.document.write('<p>1. –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ª–∏—á–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π ______________________</p>');
                printWindow.document.write('<p style="margin-left:20px">(—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç / –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç)</p>');
                printWindow.document.write('<p>   –¥–∞–Ω–Ω—ã–º –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–≥–æ —É—á—ë—Ç–∞.</p>');
                printWindow.document.write('<p>2. –í—ã—è–≤–ª–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è: _________________________________________________</p>');
                printWindow.document.write('<p>   ____________________________________________________________________</p>');
                printWindow.document.write('<p>3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–æ–º–∏—Å—Å–∏–∏: ________________________________________________</p>');
                printWindow.document.write('<p>   ____________________________________________________________________</p>');
                printWindow.document.write('</div>');

                // –ü–æ–¥–ø–∏—Å–∏
                printWindow.document.write('<div class="signatures">');
                printWindow.document.write('<div class="sig-row">');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –∫–æ–º–∏—Å—Å–∏–∏ (–ø–æ–¥–ø–∏—Å—å, –§–ò–û)</div></div>');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('</div>');
                printWindow.document.write('<div class="sig-row">');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–ß–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏ (–ø–æ–¥–ø–∏—Å—å, –§–ò–û)</div></div>');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('</div>');
                printWindow.document.write('<div class="sig-row">');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–ß–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏ (–ø–æ–¥–ø–∏—Å—å, –§–ò–û)</div></div>');
                printWindow.document.write('<div class="sig-item"><div class="sig-line"></div><div class="sig-label">–î–∞—Ç–∞</div></div>');
                printWindow.document.write('</div>');
                printWindow.document.write('<div style="text-align:center;margin-top:20px"><div class="stamp-place">–ú.–ü.</div></div>');
                printWindow.document.write('</div>');

                printWindow.document.write('<script>window.onload=function(){window.print();}<\/script></body></html>');
                printWindow.document.close();

                setAnalyticsModal({ open: false });
                showToast('üìã –ê–∫—Ç —Å–≤–µ—Ä–∫–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');
            };

            // –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–±—ç–∫–∞–ø)
            const handleExportJSON = () => {
                const fullBackup = {
                    version: '2.1',
                    exportedAt: new Date().toISOString(),
                    equipment,
                    directories,
                    history,
                    cartridgeModels,
                    cartridgeStock,
                    cartridgeHistory,
                    manualCartridgeMapping,
                    procurementNeeds,
                    consumablesStock,
                    consumablesHistory
                };
                const data = JSON.stringify(fullBackup, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `backup_102_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                setExportModal({ open: false });
                showToast('üì§ –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
            };

            const handleImportClick = () => {
                setExportModal({ open: false });
                document.getElementById('fileInput').click();
            };

            // –ü–æ–ª–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞)
            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        const imp = json.equipment || (Array.isArray(json) ? json : null);
                        if (!imp) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                        setEquipment(imp);

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
                        if (json.directories) {
                            setDirectories(json.directories);
                        }

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                        if (json.history) {
                            setHistory(json.history);
                        }

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π
                        if (json.cartridgeModels) {
                            setCartridgeModels(json.cartridgeModels);
                        }
                        if (json.cartridgeStock) {
                            setCartridgeStock(json.cartridgeStock);
                        }
                        if (json.cartridgeHistory) {
                            setCartridgeHistory(json.cartridgeHistory);
                        }
                        if (json.manualCartridgeMapping) {
                            setManualCartridgeMapping(json.manualCartridgeMapping);
                        }

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏
                        if (json.procurementNeeds) {
                            setProcurementNeeds(json.procurementNeeds);
                        }

                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–ª–∞–¥ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
                        if (json.consumablesStock) {
                            setConsumablesStock(json.consumablesStock);
                        }
                        if (json.consumablesHistory) {
                            setConsumablesHistory(json.consumablesHistory);
                        }

                        showToast(`üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${imp.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`);
                    } catch (err) {
                        console.error('Import error:', err);
                        showToast('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ fileSelected –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
            useEffect(() => {
                const handleFileSelected = (e) => {
                    handleImportJSON(e.detail);
                };
                document.addEventListener('fileSelected', handleFileSelected);
                return () => document.removeEventListener('fileSelected', handleFileSelected);
            }, []);

            // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
            const [dangerConfirm, setDangerConfirm] = useState({ open: false, inputValue: '', onConfirm: null });

            const handleClearAll = () => {
                setExportModal({ open: false });
                setDangerConfirm({
                    open: true,
                    inputValue: '',
                    onConfirm: () => {
                        setEquipment(prev => prev.map(i => ({ ...i, checked: false, writeOff: false, hasLabel: null, serialNumber: '', location: '', responsible: '', inventoryNote: '', building: '', floor: '', checkedAt: null })));
                        setHistory([]);
                        setDangerConfirm({ open: false, inputValue: '', onConfirm: null });
                        showToast('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
                    }
                });
            };

            // –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç—É
            const handleRoomClick = useCallback((building, floor, room) => {
                setRoomDevicesModal({ open: true, building, floor, room });
            }, []);

            const quickSearchResults = useMemo(() => {
                if (!quickSearchModal.query) return [];
                const q = quickSearchModal.query.toLowerCase();
                return equipment.filter(item => [item.invNumber, item.name, item.serialNumber, item.building, item.location].join(' ').toLowerCase().includes(q)).slice(0, 20);
            }, [quickSearchModal.query, equipment]);

            const currentFloors = useMemo(() => {
                if (!detailsForm.building) return ['1', '2', '3'];
                return buildingsConfig[detailsForm.building]?.floors || ['1', '2', '3'];
            }, [detailsForm.building]);

            const editFloors = useMemo(() => {
                if (!editForm.building) return ['1', '2', '3'];
                return buildingsConfig[editForm.building]?.floors || ['1', '2', '3'];
            }, [editForm.building]);

            // –≠–∫—Ä–∞–Ω –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            if (equipment.length === 0 && !hasLocalData) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-gray-100">
                        <div className="max-w-md w-full mx-4 p-8 bg-white rounded-2xl shadow-xl">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <span className="text-3xl">üìã</span>
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800 mb-2">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –°–ö–û–®–ò ‚Ññ102</h1>
                                <p className="text-gray-500">–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>
                            </div>

                            <div className="space-y-4">
                                <div className="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                    <h3 className="font-semibold text-blue-800 mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±—ç–∫–∞–ø</h3>
                                    <p className="text-sm text-blue-600 mb-3">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ backup_102_*.json –∏–ª–∏ data.json</p>
                                    <label className="touch-btn block w-full py-3 bg-blue-600 text-white rounded-lg font-semibold text-center cursor-pointer hover:bg-blue-700">
                                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª JSON
                                        <input type="file" accept=".json" className="hidden" onChange={handleImportJSON} />
                                    </label>
                                </div>

                                <div className="p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <h3 className="font-semibold text-gray-700 mb-2">–ù–∞—á–∞—Ç—å —Å –Ω—É–ª—è</h3>
                                    <p className="text-sm text-gray-500 mb-3">–°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –±–∞–∑—É –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é</p>
                                    <button onClick={() => setEquipment([])} className="touch-btn w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                                        –ù–∞—á–∞—Ç—å –ø—É—Å—Ç—É—é —Å–µ—Å—Å–∏—é
                                    </button>
                                </div>
                            </div>

                            <div className="mt-6 pt-6 border-t border-gray-100 text-center">
                                <p className="text-xs text-gray-400">
                                    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.<br/>
                                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–≠–∫—Å–ø–æ—Ä—Ç" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–∞.
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex bg-gray-50" style={{ height: '100%', minHeight: 0, overflow: 'hidden' }}>
                    <NavRail
                        onOpenRooms={() => setRoomsModal({ ...roomsModal, open: true })}
                        onOpenPeople={() => setPeopleModal({ ...peopleModal, open: true })}
                        onAddEquipment={() => openEditModal()}
                        onShowInfo={() => setInfoModal({ open: true })}
                        onGoHome={goHome}
                        onOpenStats={() => setStatsModal({ open: true })}
                        onOpenExport={() => setExportModal({ open: true })}
                        onOpenSettings={() => setSettingsModal({ open: true })}
                        onOpenHistory={() => setHistoryModal({ open: true })}
                        onOpenNotes={() => setNotesModal({ open: true })}
                        onOpenCartridges={() => setCartridgesModal({ open: true, tab: 'stock' })}
                        onOpenProcurement={() => setProcurementModal({ open: true })}
                        onOpenConsumables={() => setConsumablesModal({ open: true })}
                        problemCount={problemItems.length}
                        notesCount={notesCount}
                        criticalCartridgesCount={criticalCartridgesCount}
                        procurementCount={procurementNeeds.filter(n => n.status === 'pending').length}
                        consumablesCount={consumablesStock.filter(item => item.quantity > 0 && item.quantity <= 2).length}
                    />

                    {/* –ò–ó–ú–ï–ù–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω onRoomClick */}
                    <FilterPanel
                        isOpen={sidebarOpen}
                        onClose={() => setSidebarOpen(false)}
                        stats={stats}
                        activeFilter={activeFilter}
                        setActiveFilter={setActiveFilter}
                        activeBuilding={activeBuilding}
                        setActiveBuilding={setActiveBuilding}
                        equipment={equipment}
                        onViewItem={openDetails}
                        recentItems={recentItems}
                        problemItems={problemItems}
                        onRoomClick={handleRoomClick}
                        printDeletedRegistry={printDeletedRegistry}
                    />

                    <main className="main-area flex-1 flex flex-col min-w-0 overflow-hidden">
                        <header className="mobile-header bg-white border-b border-gray-200 px-3 py-2.5 flex-col gap-2 flex-shrink-0">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setSidebarOpen(true)} className="touch-btn w-10 h-10 rounded-lg bg-gray-100 flex-shrink-0">
                                    <Icons.Menu />
                                </button>
                                <Dropdown value={activeBuilding} options={buildingOptions} onChange={setActiveBuilding} />
                                <Dropdown value={activeCategory} options={categoryOptions} onChange={setActiveCategory} />
                                <button onClick={handleSave} className="touch-btn w-10 h-10 bg-blue-600 text-white rounded-lg flex-shrink-0">
                                    <Icons.Save />
                                </button>
                            </div>
                        </header>

                        <header className="desktop-header bg-white border-b border-gray-200 px-5 py-3 flex-shrink-0">
                            <div className="flex items-center gap-3">
                                <Dropdown value={activeBuilding} options={buildingOptions} onChange={setActiveBuilding} />
                                <Dropdown value={activeCategory} options={categoryOptions} onChange={setActiveCategory} />

                                {/* –°—á—ë—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ */}
                                <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                    –ù–∞–π–¥–µ–Ω–æ: {filteredEquipment.length}
                                </span>

                                <div className="flex items-center gap-2 ml-auto">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            placeholder="–ü–æ–∏—Å–∫..."
                                            className="w-48 px-3 py-2 pl-8 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                        />
                                        <span className="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                                        {searchQuery && (
                                            <button onClick={() => setSearchQuery('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">‚úï</button>
                                        )}
                                    </div>

                                    {/* –ö–Ω–æ–ø–∫–∞ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ */}
                                    <button
                                        onClick={() => { setSelectionMode(!selectionMode); if (selectionMode) clearSelection(); }}
                                        className={`touch-btn px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-1.5 transition-colors ${selectionMode ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                        title="–†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞"
                                    >
                                        ‚òëÔ∏è {selectionMode ? '–û—Ç–º–µ–Ω–∞' : '–í—ã–±—Ä–∞—Ç—å'}
                                    </button>

                                    <button onClick={handleSave} className="touch-btn px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold flex items-center gap-1.5">
                                        <Icons.Save /> <span className="hidden sm:inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <div ref={contentRef} className="content-scroll p-5 custom-scroll">
                            {Object.keys(groupedEquipment).length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                    <div className="text-4xl mb-3">üì≠</div>
                                    <p className="text-base font-semibold">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                                </div>
                            ) : (
                                Object.entries(groupedEquipment).sort((a, b) => a[0].localeCompare(b[0], 'ru')).map(([category, items]) => {
                                    const config = categoryConfig[category] || defaultCatConfig;
                                    const checkedCount = items.filter(i => i.checked || i.writeOff).length;
                                    return (
                                        <div key={category}>
                                            <div className="category-divider" style={{ background: config.color }}>
                                                <span className="flex items-center gap-2">
                                                    <span>{config.icon}</span>
                                                    <span>{category}</span>
                                                </span>
                                                <span className="bg-white/20 px-2.5 py-0.5 rounded text-xs">{checkedCount}/{items.length}</span>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                                {items.map(item => (
                                                    <EquipmentCard
                                                        key={item.id}
                                                        item={item}
                                                        onView={openDetails}
                                                        onCheck={handleCheck}
                                                        selectionMode={selectionMode}
                                                        isSelected={selectedItems.has(item.id)}
                                                        onToggleSelect={toggleSelectItem}
                                                        onQuickCheck={quickCheck}
                                                        onQuickWriteOff={quickWriteOff}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            <div className="h-16"></div>
                        </div>
                    </main>

                    <button onClick={() => setQuickSearchModal({ open: true, query: '' })}
                        className="fixed bottom-5 right-5 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center z-100 hover:bg-blue-700">
                        üîç
                    </button>

                    <Modal isOpen={infoModal.open} onClose={() => setInfoModal({ open: false })} title="–û –ø—Ä–æ–≥—Ä–∞–º–º–µ" size="sm">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <span className="text-2xl">üìã</span>
                            </div>
                            <h3 className="text-lg font-bold text-gray-800 mb-1">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h3>
                            <p className="text-sm text-gray-500 mb-2">–ì–ö–û–£ –°–ö–û–®–ò ‚Ññ102</p>
                            <div className="flex justify-center gap-4 text-xs text-gray-400 mb-4">
                                <span>üè´ –ù–∞–Ω—Å–µ–Ω–∞ (3 —ç—Ç.)</span>
                                <span>üè¢ –ë–æ—Ç–∞–Ω–∏—á–∫–∞ (2 —ç—Ç.)</span>
                            </div>
                            <p className="text-xs text-gray-400">–í–µ—Ä—Å–∏—è 7.1</p>
                        </div>
                    </Modal>

                    <StatsModal isOpen={statsModal.open} onClose={() => setStatsModal({ open: false })} stats={stats} equipment={equipment} />
                    <HistoryModal isOpen={historyModal.open} onClose={() => setHistoryModal({ open: false })} history={history} onViewItem={(item) => { setHistoryModal({ open: false }); openDetails(item); }} />
                    <ExportModal isOpen={exportModal.open} onClose={() => setExportModal({ open: false })} onExportExcel={handleExportExcel} onExportCheckedReport={handleExportCheckedReport} onPrintNotFound={handlePrintNotFound} onOpenFilterReport={() => { setExportModal({ open: false }); setReportFilterModal({ open: true, filterType: 'responsible', filterValue: '', filterBuilding: '' }); }} onExportJSON={handleExportJSON} onImport={handleImportClick} onClearAll={handleClearAll} />
                    <ReportFilterModal
                        isOpen={reportFilterModal.open}
                        onClose={() => setReportFilterModal({ open: false, filterType: 'responsible', filterValue: '', filterBuilding: '' })}
                        filterType={reportFilterModal.filterType}
                        filterValue={reportFilterModal.filterValue}
                        filterBuilding={reportFilterModal.filterBuilding}
                        onFilterTypeChange={(type) => setReportFilterModal(prev => ({ ...prev, filterType: type }))}
                        onFilterValueChange={(val) => setReportFilterModal(prev => ({ ...prev, filterValue: val }))}
                        onBuildingChange={(building) => setReportFilterModal(prev => ({ ...prev, filterBuilding: building }))}
                        onPrint={handlePrintFilteredReport}
                        uniqueResponsibles={uniqueResponsibles}
                        uniqueLocations={uniqueLocations}
                        uniqueBuildings={uniqueBuildings}
                        uniqueYears={uniqueYears}
                        getFloorsByBuilding={getFloorsByBuilding}
                        getLocationsByBuilding={getLocationsByBuilding}
                    />
                    <SettingsModal isOpen={settingsModal.open} onClose={() => setSettingsModal({ open: false })} stats={stats} />
                    <CheckWizardModal isOpen={checkWizardModal.open} onClose={() => setCheckWizardModal({ open: false, item: null })} item={checkWizardModal.item} onComplete={handleCheckComplete} directories={directories} />
                    
                    {/* –ù–û–í–û–ï: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫–∞–±–∏–Ω–µ—Ç–∞ */}
                    <RoomDevicesModal 
                        isOpen={roomDevicesModal.open}
                        onClose={() => setRoomDevicesModal({ open: false, building: '', floor: '', room: '' })}
                        building={roomDevicesModal.building}
                        floor={roomDevicesModal.floor}
                        room={roomDevicesModal.room}
                        equipment={equipment}
                        onViewItem={openDetails}
                    />

                    {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–º–µ—Ç–æ–∫ */}
                    <NotesModal
                        isOpen={notesModal.open}
                        onClose={() => setNotesModal({ open: false })}
                        equipment={equipment}
                        onViewItem={openDetails}
                    />

                    {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π */}
                    <CartridgesModal
                        isOpen={cartridgesModal.open}
                        onClose={() => setCartridgesModal({ open: false, tab: 'stock' })}
                        tab={cartridgesModal.tab}
                        setTab={(tab) => setCartridgesModal(prev => ({ ...prev, tab }))}
                        cartridgeModels={cartridgeModels}
                        setCartridgeModels={setCartridgeModels}
                        cartridgeStock={cartridgeStock}
                        setCartridgeStock={setCartridgeStock}
                        cartridgeHistory={cartridgeHistory}
                        setCartridgeHistory={setCartridgeHistory}
                        manualCartridgeMapping={manualCartridgeMapping}
                        setManualCartridgeMapping={setManualCartridgeMapping}
                        equipment={equipment}
                        directories={directories}
                        showToast={showToast}
                    />

                    {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π */}
                    <ProcurementNeedsModal
                        isOpen={procurementModal.open}
                        onClose={() => setProcurementModal({ open: false })}
                        needs={procurementNeeds}
                        setNeeds={setProcurementNeeds}
                        directories={directories}
                        showToast={showToast}
                    />

                    {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–ª–∞–¥–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ */}
                    <ConsumablesModal
                        isOpen={consumablesModal.open}
                        onClose={() => setConsumablesModal({ open: false })}
                        stock={consumablesStock}
                        setStock={setConsumablesStock}
                        history={consumablesHistory}
                        setHistory={setConsumablesHistory}
                        directories={directories}
                        showToast={showToast}
                    />

                    <Modal isOpen={detailsModal.open} onClose={() => setDetailsModal({ open: false, item: null })} title="–ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" size="lg">
                        {detailsModal.item && (
                            <div className="space-y-4">
                                <div className="p-3 bg-blue-50 rounded-lg">
                                    <div className="flex items-center gap-2 mb-1 flex-wrap">
                                        <span className="px-2 py-0.5 bg-blue-600 text-white rounded text-xs font-mono">{detailsModal.item.invNumber}</span>
                                        {detailsModal.item.date && <span className="text-xs text-gray-500">üìÖ {detailsModal.item.date}</span>}
                                        {detailsModal.item.isUserAdded && <span className="text-xs text-blue-600 font-semibold">–ù–æ–≤–æ–µ</span>}
                                    </div>
                                    <h3 className="font-semibold text-gray-800 text-sm">{detailsModal.item.name}</h3>
                                    <p className="text-xs text-gray-500">{detailsModal.item.category}</p>
                                </div>

                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-2">–ë–∏—Ä–∫–∞</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button type="button" onClick={() => setDetailsForm(prev => ({ ...prev, hasLabel: true }))} 
                                            className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${detailsForm.hasLabel === true ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            ‚úì –ï—Å—Ç—å
                                        </button>
                                        <button type="button" onClick={() => setDetailsForm(prev => ({ ...prev, hasLabel: false }))} 
                                            className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${detailsForm.hasLabel === false ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            ‚úó –ù–µ—Ç
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-2">–ó–¥–∞–Ω–∏–µ</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button type="button" onClick={() => setDetailsForm(prev => ({ ...prev, building: '–ù–∞–Ω—Å–µ–Ω–∞', floor: '' }))} 
                                            className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${detailsForm.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            üè´ –ù–∞–Ω—Å–µ–Ω–∞
                                        </button>
                                        <button type="button" onClick={() => setDetailsForm(prev => ({ ...prev, building: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞', floor: '' }))} 
                                            className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${detailsForm.building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                            üè¢ –ë–æ—Ç–∞–Ω–∏—á–∫–∞
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–≠—Ç–∞–∂</label>
                                    <div className="flex gap-2">
                                        {currentFloors.map(f => (
                                            <button key={f} type="button" onClick={() => setDetailsForm(prev => ({ ...prev, floor: f }))}
                                                className={`touch-btn flex-1 py-2 rounded-lg font-semibold text-sm ${detailsForm.floor === f ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                                {f}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <AutocompleteInput label="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä" value={detailsForm.serialNumber} onChange={v => setDetailsForm(prev => ({ ...prev, serialNumber: v }))} suggestions={[]} placeholder="S/N" />
                                <AutocompleteInput label="–ö–∞–±–∏–Ω–µ—Ç" value={detailsForm.location} onChange={v => setDetailsForm(prev => ({ ...prev, location: v }))} suggestions={filteredRooms} placeholder="–ù–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞" />
                                <AutocompleteInput label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" value={detailsForm.responsible} onChange={v => setDetailsForm(prev => ({ ...prev, responsible: v }))} suggestions={directories.people || []} placeholder="–§–ò–û" />

                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–ó–∞–º–µ—Ç–∫–∏</label>
                                    <textarea value={detailsForm.inventoryNote} onChange={e => setDetailsForm(prev => ({ ...prev, inventoryNote: e.target.value }))}
                                        placeholder="..." rows={2} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm resize-none" />
                                </div>

                                <div className="grid grid-cols-3 gap-2 pt-3 border-t border-gray-100">
                                    <button onClick={() => { setDetailsModal({ open: false, item: null }); openEditModal(detailsModal.item); }} className="touch-btn py-2.5 bg-gray-100 text-gray-700 rounded-lg font-semibold text-sm">
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button onClick={() => handleWriteOff(detailsModal.item)} className="touch-btn py-2.5 bg-red-100 text-red-600 rounded-lg font-semibold text-sm">
                                        –°–ø–∏—Å–∞—Ç—å
                                    </button>
                                    <button onClick={() => handleDelete(detailsModal.item)} className="touch-btn py-2.5 bg-gray-600 text-white rounded-lg font-semibold text-sm">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>

                                <button onClick={saveDetails} className="touch-btn w-full py-3 bg-blue-600 text-white rounded-lg font-semibold">
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={editModal.open} onClose={() => setEditModal({ open: false, item: null, isNew: false })} title={editModal.isNew ? '–î–æ–±–∞–≤–∏—Ç—å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'} size="md">
                        <div className="space-y-3">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                <input type="text" value={editForm.name} onChange={e => setEditForm(prev => ({ ...prev, name: e.target.value }))}
                                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–ò–Ω–≤. –Ω–æ–º–µ—Ä *</label>
                                    <input type="text" value={editForm.invNumber} onChange={e => setEditForm(prev => ({ ...prev, invNumber: e.target.value }))}
                                        placeholder="‚Ññ" className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–î–∞—Ç–∞</label>
                                    <input type="text" value={editForm.date} onChange={e => setEditForm(prev => ({ ...prev, date: e.target.value }))}
                                        placeholder="–î–î.–ú–ú.–ì–ì–ì–ì" className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-2">–ó–¥–∞–Ω–∏–µ</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <button type="button" onClick={() => setEditForm(prev => ({ ...prev, building: '–ù–∞–Ω—Å–µ–Ω–∞', floor: '' }))} 
                                        className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${editForm.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                        üè´ –ù–∞–Ω—Å–µ–Ω–∞
                                    </button>
                                    <button type="button" onClick={() => setEditForm(prev => ({ ...prev, building: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞', floor: '' }))} 
                                        className={`touch-btn py-2.5 rounded-lg font-semibold text-sm ${editForm.building === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                        üè¢ –ë–æ—Ç–∞–Ω–∏—á–∫–∞
                                    </button>
                                </div>
                            </div>

                            {editForm.building && (
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">–≠—Ç–∞–∂</label>
                                    <div className="flex gap-2">
                                        {editFloors.map(f => (
                                            <button key={f} type="button" onClick={() => setEditForm(prev => ({ ...prev, floor: f }))}
                                                className={`touch-btn flex-1 py-2 rounded-lg font-semibold text-sm ${editForm.floor === f ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                                {f}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                                <select value={editForm.category} onChange={e => setEditForm(prev => ({ ...prev, category: e.target.value }))}
                                    className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                    {categories.filter(c => c !== '–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ').map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <input type="text" value={editForm.newCategory} onChange={e => setEditForm(prev => ({ ...prev, newCategory: e.target.value }))}
                                    placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é" className="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                            </div>
                            <div className="flex gap-2 pt-3">
                                <button onClick={() => setEditModal({ open: false, item: null, isNew: false })} className="touch-btn flex-1 py-3 bg-gray-100 text-gray-600 rounded-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
                                <button onClick={saveEdit} className="touch-btn flex-1 py-3 bg-blue-600 text-white rounded-lg font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    </Modal>

                    <Modal isOpen={quickSearchModal.open} onClose={() => setQuickSearchModal({ open: false, query: '' })} title="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫" size="md">
                        <input type="text" value={quickSearchModal.query} onChange={e => setQuickSearchModal(prev => ({ ...prev, query: e.target.value }))}
                            placeholder="–ù–æ–º–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∑–¥–∞–Ω–∏–µ..." className="w-full px-4 py-3 border border-gray-200 rounded-lg font-mono mb-4" autoFocus />
                        <div className="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
                            {quickSearchResults.length === 0 ? (
                                <div className="p-8 text-center text-gray-400 text-sm">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å...</div>
                            ) : (
                                quickSearchResults.map(item => (
                                    <button key={item.id} onClick={() => { setQuickSearchModal({ open: false, query: '' }); openDetails(item); }}
                                        className={`w-full text-left p-3 border-b border-gray-50 hover:bg-gray-50 flex items-center gap-3 ${item.checked ? 'bg-green-50' : item.writeOff ? 'bg-red-50' : ''}`}>
                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm ${item.writeOff ? 'bg-red-500 text-white' : item.checked ? 'bg-green-500 text-white' : 'bg-amber-100 text-amber-600'}`}>
                                            {item.writeOff ? 'üìù' : item.checked ? '‚úì' : '‚è≥'}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                                <span className="font-mono font-semibold text-blue-600 text-sm">{item.invNumber}</span>
                                                {item.building && (
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}`}>
                                                        {item.building === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="text-xs text-gray-500 truncate">{item.name}</div>
                                        </div>
                                    </button>
                                ))
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={roomsModal.open} onClose={() => setRoomsModal({ open: false, newRoom: '', newRoomBuilding: '–ù–∞–Ω—Å–µ–Ω–∞' })} title="üö™ –ö–∞–±–∏–Ω–µ—Ç—ã" size="md">
                        <div className="space-y-3 mb-4">
                            <div className="grid grid-cols-2 gap-2">
                                <button type="button" onClick={() => setRoomsModal(prev => ({ ...prev, newRoomBuilding: '–ù–∞–Ω—Å–µ–Ω–∞' }))}
                                    className={`touch-btn py-2 rounded-lg font-semibold text-sm ${roomsModal.newRoomBuilding === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                    üè´ –ù–∞–Ω—Å–µ–Ω–∞
                                </button>
                                <button type="button" onClick={() => setRoomsModal(prev => ({ ...prev, newRoomBuilding: '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' }))}
                                    className={`touch-btn py-2 rounded-lg font-semibold text-sm ${roomsModal.newRoomBuilding === '–ë–æ—Ç–∞–Ω–∏—á–∫–∞' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600'}`}>
                                    üè¢ –ë–æ—Ç–∞–Ω–∏—á–∫–∞
                                </button>
                            </div>
                            <div className="flex gap-2">
                                <input type="text" value={roomsModal.newRoom} onChange={e => setRoomsModal(prev => ({ ...prev, newRoom: e.target.value }))}
                                    onKeyDown={e => e.key === 'Enter' && addToDirectory('rooms', roomsModal.newRoom, roomsModal.newRoomBuilding)}
                                    placeholder="–ù–æ–≤—ã–π –∫–∞–±–∏–Ω–µ—Ç..." className="flex-1 px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                                <button onClick={() => addToDirectory('rooms', roomsModal.newRoom, roomsModal.newRoomBuilding)} className="touch-btn px-4 py-2.5 bg-green-600 text-white rounded-lg font-bold">+</button>
                            </div>
                        </div>
                        <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                            {(directories.rooms || []).length === 0 ? (
                                <div className="p-6 text-center text-gray-400 text-sm">–ü—É—Å—Ç–æ</div>
                            ) : (
                                (directories.rooms || []).map((room, idx) => {
                                    const roomsWithBuilding = directories.roomsWithBuilding || [];
                                    const roomBuilding = roomsWithBuilding.find(r => r && r.name === room)?.building;
                                    return (
                                        <div key={idx} className="flex items-center gap-2 p-3 border-b border-gray-50">
                                            {roomBuilding && (
                                                <span className={`text-sm ${roomBuilding === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'text-blue-500' : 'text-green-500'}`}>
                                                    {roomBuilding === '–ù–∞–Ω—Å–µ–Ω–∞' ? 'üè´' : 'üè¢'}
                                                </span>
                                            )}
                                            <span className="flex-1 text-sm">{room}</span>
                                            <button onClick={() => removeFromDirectory('rooms', idx)} className="touch-btn p-2 bg-red-100 text-red-600 rounded-lg text-xs">üóëÔ∏è</button>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={peopleModal.open} onClose={() => setPeopleModal({ open: false, newPerson: '' })} title="üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏" size="sm">
                        <div className="flex gap-2 mb-4">
                            <input type="text" value={peopleModal.newPerson} onChange={e => setPeopleModal(prev => ({ ...prev, newPerson: e.target.value }))}
                                onKeyDown={e => e.key === 'Enter' && addToDirectory('people', peopleModal.newPerson)}
                                placeholder="–ù–æ–≤–æ–µ –§–ò–û..." className="flex-1 px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                            <button onClick={() => addToDirectory('people', peopleModal.newPerson)} className="touch-btn px-4 py-2.5 bg-green-600 text-white rounded-lg font-bold">+</button>
                        </div>
                        <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                            {(directories.people || []).length === 0 ? (
                                <div className="p-6 text-center text-gray-400 text-sm">–ü—É—Å—Ç–æ</div>
                            ) : (
                                (directories.people || []).map((person, idx) => (
                                    <div key={idx} className="flex items-center gap-2 p-3 border-b border-gray-50">
                                        <span className="flex-1 text-sm">{person}</span>
                                        <button onClick={() => removeFromDirectory('people', idx)} className="touch-btn p-2 bg-red-100 text-red-600 rounded-lg text-xs">üóëÔ∏è</button>
                                    </div>
                                ))
                            )}
                        </div>
                    </Modal>

                    <ConfirmModal isOpen={confirmModal.open} onClose={() => setConfirmModal(prev => ({ ...prev, open: false }))}
                        onConfirm={confirmModal.onConfirm} title={confirmModal.title} message={confirmModal.message} />

                    {/* –ú–æ–¥–∞–ª –¥–≤–æ–π–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */}
                    {dangerConfirm.open && (
                        <div className="modal-base modal-z-800">
                            <div className="modal-animate bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                                <div className="bg-red-600 p-4 text-white text-center">
                                    <span className="text-3xl">‚ö†Ô∏è</span>
                                    <h3 className="text-lg font-bold mt-2">–í–ù–ò–ú–ê–ù–ò–ï!</h3>
                                </div>
                                <div className="p-5">
                                    <p className="text-gray-700 text-center mb-4">
                                        –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å <strong>—Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</strong>. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                                    </p>
                                    <p className="text-sm text-gray-500 text-center mb-4">
                                        –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ <strong className="text-red-600">–°–ë–†–û–°</strong>
                                    </p>
                                    <input
                                        type="text"
                                        value={dangerConfirm.inputValue}
                                        onChange={(e) => setDangerConfirm(prev => ({ ...prev, inputValue: e.target.value }))}
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ –°–ë–†–û–°"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-center text-lg font-mono focus:outline-none focus:border-red-500"
                                        autoFocus
                                    />
                                    <div className="flex gap-3 mt-5">
                                        <button
                                            onClick={() => setDangerConfirm({ open: false, inputValue: '', onConfirm: null })}
                                            className="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold"
                                        >
                                            –û—Ç–º–µ–Ω–∞
                                        </button>
                                        <button
                                            onClick={() => dangerConfirm.inputValue === '–°–ë–†–û–°' && dangerConfirm.onConfirm()}
                                            disabled={dangerConfirm.inputValue !== '–°–ë–†–û–°'}
                                            className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${dangerConfirm.inputValue === '–°–ë–†–û–°' ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}
                                        >
                                            üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */}
                    {selectionMode && selectedItems.size > 0 && (
                        <div className="bulk-action-bar">
                            <div className="flex items-center gap-3">
                                <span className="text-sm font-semibold">–í—ã–±—Ä–∞–Ω–æ: {selectedItems.size}</span>
                                <button onClick={selectAllVisible} className="text-xs text-blue-300 hover:text-white underline">
                                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ ({filteredEquipment.length})
                                </button>
                            </div>
                            <div className="actions">
                                <button onClick={bulkCheck} className="btn-check">‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                                <button onClick={bulkUncheck} className="btn-cancel">‚Ü© –°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É</button>
                                <button onClick={bulkWriteOff} className="btn-writeoff">üìù –°–ø–∏—Å–∞—Ç—å</button>
                                <button onClick={bulkPrint} className="btn-print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                                <button onClick={clearSelection} className="btn-cancel">‚úï –û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    )}

                    {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */}
                    {isLoading && (
                        <div className="loading-overlay">
                            <div className="loading-spinner"></div>
                            <p className="mt-4 text-gray-600 font-semibold">–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>
                        </div>
                    )}

                    <Toast message={toast.message} isVisible={toast.visible} onClose={() => setToast(prev => ({ ...prev, visible: false }))} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const event = new CustomEvent('fileSelected', { detail: e });
            document.dispatchEvent(event);
        });
    </script>
</body>
</html>
